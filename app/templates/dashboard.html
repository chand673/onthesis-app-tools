{% extends "layout.html" %}

{% block title %}Command Center - OnThesis{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    
    <header class="mb-10 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white">
            Hai, <span class="text-accent-cyan">{{ current_user.username or 'Chandz' }}</span>!
        </h1>
        <p class="text-lg text-text-secondary mt-2 max-w-3xl mx-auto">
            Selamat datang di pusat kendali akademik Anda. Semua alat bantu skripsi ada di sini, siap memaksimalkan produktivitas Anda.
        </p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        <div class="apex-card p-6">
            <div class="flex items-center justify-between">
                <p class="text-sm font-medium text-text-secondary">Proyek Aktif</p>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary h-5 w-5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            </div>
            <p id="stats-projects-count" class="text-4xl font-bold text-white mt-2">0</p>
        </div>
        <div class="apex-card p-6">
            <div class="flex items-center justify-between">
                <p class="text-sm font-medium text-text-secondary">Referensi Tersimpan</p>
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary h-5 w-5"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            </div>
            <p id="stats-references-count" class="text-4xl font-bold text-white mt-2">0</p>
        </div>
        <div class="apex-card p-6">
             <div class="flex items-center justify-between">
                <p class="text-sm font-medium text-text-secondary">Parafrase Hari Ini</p>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-secondary h-5 w-5"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
            </div>
            <p id="stats-paraphrase-count" class="text-4xl font-bold text-white mt-2">- / -</p>
        </div>
    </div>

    <div class="mt-12">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white">Proyek Terbaru</h3>
            <a href="{{ url_for('projects') }}" class="btn-secondary text-sm">Lihat Semua Proyek</a>
        </div>
        <div id="project-overview-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        </div>
    </div>

    <div class="mt-12">
        <h3 class="text-2xl font-bold text-white mb-6">Pusat Fitur</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <a href="{{ url_for('search_references') }}" class="apex-card group">
                 <div class="flex items-center gap-4 mb-4"><div class="p-3 bg-gray-800 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div><h3 class="text-lg font-bold text-white">Search References</h3></div>
                 <p class="text-sm text-text-secondary">Akses jutaan jurnal dan referensi ilmiah global.</p>
            </a>
            <a href="{{ url_for('citation_management') }}" class="apex-card group">
                 <div class="flex items-center gap-4 mb-4"><div class="p-3 bg-gray-800 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></div><h3 class="text-lg font-bold text-white">Manajemen Sitasi</h3></div>
                 <p class="text-sm text-text-secondary">Kelola daftar pustaka dan format kutipan otomatis.</p>
            </a>
            <a href="{{ url_for('paraphrase_ai') }}" class="apex-card group">
                 <div class="flex items-center gap-4 mb-4"><div class="p-3 bg-gray-800 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg></div><h3 class="text-lg font-bold text-white">Parafrase AI</h3></div>
                 <p class="text-sm text-text-secondary">Ubah tulisan menjadi lebih akademis dan bebas plagiarisme.</p>
            </a>
            <a href="{{ url_for('chat_ai') }}" class="apex-card group">
                 <div class="flex items-center gap-4 mb-4"><div class="p-3 bg-gray-800 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><h3 class="text-lg font-bold text-white">Curhat AI</h3></div>
                 <p class="text-sm text-text-secondary">Diskusi, atasi kebuntuan, dan kelola stres skripsi Anda.</p>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script type="module">
    // Menggunakan Firestore untuk data proyek
    import { db, auth } from '/static/js/firebase.js';
    import { collection, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        const updateReferenceCount = () => {
            const references = JSON.parse(localStorage.getItem('onthesis_references')) || [];
            document.getElementById('stats-references-count').textContent = references.length;
        };

        const updateUsageStats = async () => {
            const paraphraseCountEl = document.getElementById('stats-paraphrase-count');
            try {
                const response = await fetch('/api/get-usage-status');
                const data = await response.json();
                if (data.status === 'pro') {
                    paraphraseCountEl.textContent = 'Unlimited';
                } else if (data.status === 'free') {
                    const used = data.limits.paraphrase - data.paraphrase_remaining;
                    paraphraseCountEl.textContent = `${used} / ${data.limits.paraphrase}`;
                }
            } catch (error) {
                paraphraseCountEl.textContent = 'N/A';
            }
        };
        
        const loadProjectOverview = () => {
            if (!auth.currentUser) return;
            const container = document.getElementById('project-overview-container');
            const q = query(collection(db, "projects"), where("userId", "==", auth.currentUser.uid));

            onSnapshot(q, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => projects.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('stats-projects-count').textContent = projects.length;

                if (projects.length === 0) {
                    container.innerHTML = `<p class="text-text-secondary italic md:col-span-2">Belum ada proyek. <a href="{{ url_for('projects') }}" class="text-accent-cyan hover:underline">Mulai proyek pertama Anda!</a></p>`;
                    return;
                }

                container.innerHTML = projects.slice(0, 2).map(project => `
                    <a href="{{ url_for('projects') }}" class="apex-card p-6 block">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-bold text-white text-lg">${project.title}</h4>
                            <span class="text-xs bg-accent-cyan/20 text-accent-cyan font-bold px-2 py-1 rounded-full">${project.status || 'Baru'}</span>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm text-text-secondary">Progres</span>
                                <span class="text-sm font-semibold text-white">${project.progress}%</span>
                            </div>
                            <div class="w-full bg-border-panel rounded-full h-2.5">
                                <div class="bg-accent-cyan h-2.5 rounded-full" style="width: ${project.progress}%"></div>
                            </div>
                        </div>
                    </a>
                `).join('');
            });
        };

        updateReferenceCount();
        updateUsageStats();
        
        // Menunggu auth siap sebelum memuat data proyek
        auth.onAuthStateChanged(user => {
            if (user) {
                loadProjectOverview();
            }
        });
    });
</script>
{% endblock %}
