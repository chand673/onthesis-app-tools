{% extends "layout.html" %}

{% block title %}Analisis Data (PRO) - OnThesis{% endblock %}

{% block page_styles %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
<style>
    /* Gaya untuk Tab Aktif */
    .analysis-tab.active-tab {
        background-color: white;
        color: #f97316; /* orange-500 */
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    /* Animasi untuk notifikasi */
    @keyframes fade-in-out {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
    .animate-fade-in-out {
      animation: fade-in-out 4s ease-in-out forwards;
    }
    .action-btn-sm {
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.8);
        padding: 0.25rem;
        border-radius: 0.375rem; /* rounded-md */
        color: #475569; /* slate-600 */
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    .action-btn-sm:hover {
        background-color: white;
        color: #1e293b; /* slate-800 */
    }
    .action-btn-sm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<!-- Kontainer utama dengan tema oranye cerah dan layout "fit" -->
<div class="h-full w-full bg-gradient-to-br from-amber-100 to-orange-200 rounded-2xl shadow-2xl p-6 sm:p-8 flex flex-col">

    <!-- Header Halaman -->
    <header class="mb-8 flex-shrink-0 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-orange-900">Analisis Data Cerdas (PRO)</h1>
        <p class="text-lg text-orange-800/80 mt-1">Lakukan uji statistik dan dapatkan interpretasi AI secara instan.</p>
        
        <!-- Widget penghitung kuota percobaan -->
        <div id="usage-counter-display" class="hidden mt-4 inline-flex items-center gap-2 bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Sisa Percobaan PRO: <strong id="analysis-remaining-count">...</strong></span>
        </div>
    </header>

    <!-- Navigasi Tab (Centered) -->
    <div class="mb-6 flex-shrink-0 flex justify-center">
        <nav class="flex flex-wrap justify-center gap-2 p-1 bg-white/50 backdrop-blur-sm border border-white/60 rounded-xl shadow-md" aria-label="Tabs">
            <button class="analysis-tab active-tab px-4 py-2 text-sm font-semibold text-slate-700 rounded-lg transition-all duration-300">Statistik Deskriptif</button>
            <button class="analysis-tab px-4 py-2 text-sm font-semibold text-slate-700 rounded-lg transition-all duration-300">Validitas & Reliabilitas</button>
            <button class="analysis-tab px-4 py-2 text-sm font-semibold text-slate-700 rounded-lg transition-all duration-300">Uji Normalitas</button>
            <button class="analysis-tab px-4 py-2 text-sm font-semibold text-slate-700 rounded-lg transition-all duration-300">Uji Homogenitas</button>
            <button class="analysis-tab px-4 py-2 text-sm font-semibold text-slate-700 rounded-lg transition-all duration-300">Uji Hipotesis</button>
        </nav>
    </div>

    <!-- Kontainer Konten Tab (mengisi sisa ruang) -->
    <div class="flex-grow overflow-hidden">
        <!-- Konten Tab: Statistik Deskriptif -->
        <div id="tab-content-descriptive" class="analysis-tab-content h-full">
            <div class="h-full overflow-y-auto pr-2">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Kolom Input Data -->
                    <div class="lg:col-span-3 bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">Input Data</h2>
                        <div class="flex items-center gap-4 mb-4">
                            <button id="da-add-row-btn" class="w-full text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-all duration-300 shadow-sm hover:shadow-md">Tambah Baris</button>
                            <button id="da-upload-csv-btn" class="w-full text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-all duration-300 shadow-sm hover:shadow-md">Upload CSV</button>
                            <input type="file" id="da-csv-file-input" class="hidden" accept=".csv">
                        </div>
                        <div class="max-h-96 overflow-y-auto pr-2 border border-slate-200 rounded-lg">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-100/50">
                                    <tr class="text-slate-600">
                                        <th class="px-4 py-2 w-12 font-semibold">No.</th>
                                        <th class="px-4 py-2 font-semibold">Label (Opsional)</th>
                                        <th class="px-4 py-2 font-semibold">Nilai</th>
                                        <th class="px-4 py-2 w-12"></th>
                                    </tr>
                                </thead>
                                <tbody id="da-input-tbody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="da-calculate-btn" class="bg-gradient-to-br from-orange-500 to-amber-700 text-white font-semibold py-2 px-6 rounded-lg hover:from-orange-600 hover:to-amber-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition-all duration-300 shadow-md hover:shadow-lg">Hitung</button>
                        </div>
                    </div>
                    <!-- Kolom Hasil Analisis -->
                    <div class="lg:col-span-2 bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-slate-800">Tabel Statistik Deskriptif</h2>
                            <div class="flex items-center gap-2">
                                <button id="da-copy-btn" class="action-btn-sm" disabled title="Salin Tabel"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                                <button id="da-download-btn" class="action-btn-sm" disabled title="Unduh CSV"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                            </div>
                        </div>
                        <div id="da-results-container" class="overflow-x-auto">
                            <p class="text-slate-500 italic">Hasil akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
                <!-- Baris Bawah: Interpretasi dan Visualisasi -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <!-- Kolom Interpretasi AI -->
                    <div id="da-ai-interpretation-section" class="hidden bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <h3 class="text-xl font-semibold text-slate-800 mb-2">Interpretasi AI</h3>
                        <button id="da-interpret-btn" class="w-full mb-3 bg-gradient-to-br from-teal-500 to-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:from-teal-600 hover:to-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition-all duration-300 shadow-md hover:shadow-lg">Jelaskan Hasil Ini</button>
                        <div id="da-interpretation-output" class="p-4 min-h-[100px] bg-slate-100/50 rounded-lg prose prose-sm max-w-none">
                             <p class="text-slate-500 italic">Interpretasi dari AI akan muncul di sini.</p>
                        </div>
                    </div>
                    <!-- Kontainer Visualisasi Data -->
                    <div id="da-visualization-section" class="bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-slate-800">Visualisasi Data</h2>
                            <select id="da-chart-type-select" class="text-sm bg-white border border-slate-300 rounded-lg focus:ring-1 focus:ring-orange-500 focus:border-orange-500 py-2">
                                <option value="bar">Histogram</option>
                                <option value="pie">Pie Chart</option>
                                <option value="line">Line Chart</option>
                            </select>
                        </div>
                        <div class="mx-auto" style="position: relative; height: 300px;">
                            <canvas id="da-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Konten Tab: Validitas & Reliabilitas -->
        <div id="tab-content-validity" class="analysis-tab-content hidden h-full">
             <div class="h-full overflow-y-auto pr-2">
                <!-- Bagian Input Data -->
                <div class="bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner mb-8">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">Input Data Kuesioner</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <button id="vr-add-respondent-btn" class="w-full text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md">Tambah Responden</button>
                        <button id="vr-add-item-btn" class="w-full text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md">Tambah Item</button>
                        <button id="vr-upload-csv-btn" class="w-full text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md">Upload CSV</button>
                        <input type="file" id="vr-csv-file-input" class="hidden" accept=".csv">
                    </div>
                    <div class="max-h-96 overflow-auto border border-slate-200 rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead id="vr-table-head" class="bg-slate-100/50 sticky top-0">
                                <!-- Header akan di-generate oleh JS -->
                            </thead>
                            <tbody id="vr-table-body" class="divide-y divide-slate-200">
                                <!-- Baris data akan di-generate oleh JS -->
                            </tbody>
                        </table>
                    </div>
                     <div class="mt-4 flex justify-end">
                        <button id="vr-calculate-btn" class="bg-gradient-to-br from-orange-500 to-amber-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg">Uji Validitas & Reliabilitas</button>
                    </div>
                </div>
                <!-- Bagian Hasil Uji -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Kolom Hasil Uji -->
                    <div id="vr-results-section" class="hidden bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-slate-800">Tabel Output Hasil Uji</h2>
                            <div class="flex items-center gap-2">
                                <button id="vr-copy-btn" class="action-btn-sm" disabled title="Salin Tabel"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button>
                                <button id="vr-download-btn" class="action-btn-sm" disabled title="Unduh CSV"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">Uji Validitas (Pearson)</h3>
                        <div id="vr-validity-results" class="overflow-x-auto mb-6">
                            <p class="text-slate-500 italic">Hasil uji validitas akan muncul di sini.</p>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-700 mb-2">Uji Reliabilitas (Cronbach's Alpha)</h3>
                        <div id="vr-reliability-results" class="mb-6">
                           <p class="text-slate-500 italic">Hasil uji reliabilitas akan muncul di sini.</p>
                        </div>
                    </div>
                    <!-- Kolom Interpretasi AI -->
                    <div id="vr-ai-interpretation-section" class="hidden bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <h3 class="text-xl font-semibold text-slate-800 mb-2">Interpretasi AI</h3>
                        <button id="vr-interpret-btn" class="w-full mb-3 bg-gradient-to-br from-teal-500 to-cyan-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg">Jelaskan Hasil Ini</button>
                        <div id="vr-interpretation-output" class="p-4 min-h-[100px] bg-slate-100/50 rounded-lg prose prose-sm max-w-none">
                             <p class="text-slate-500 italic">Interpretasi dari AI akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Konten Tab: Uji Normalitas -->
        <div id="tab-content-normality" class="analysis-tab-content hidden h-full">
            <div class="h-full overflow-y-auto pr-2">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Kolom Input Data -->
                    <div class="lg:col-span-3 bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-slate-800">Input Data Uji Normalitas</h2>
                            <button id="norm-add-group-btn" class="text-sm bg-white text-slate-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md">+ Tambah Grup</button>
                        </div>
                        <p class="text-sm text-slate-600 mb-4">Masukkan data untuk setiap grup atau variabel. Pisahkan setiap nilai dengan baris baru (Enter).</p>
                        <div id="norm-input-groups-container" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                            <!-- Input grup akan ditambahkan di sini oleh JS -->
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="norm-calculate-btn" class="bg-gradient-to-br from-orange-500 to-amber-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg">Uji Normalitas</button>
                        </div>
                    </div>
                    <!-- Kolom Hasil Analisis -->
                    <div class="lg:col-span-2 space-y-8">
                        <div id="norm-results-section" class="hidden bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                            <h2 class="text-xl font-semibold text-slate-800 mb-4">Hasil Uji Normalitas</h2>
                            <div id="norm-results-table" class="overflow-x-auto">
                                <!-- Hasil tabel akan ditampilkan di sini -->
                            </div>
                        </div>
                        <div id="norm-ai-interpretation-section" class="hidden bg-white/70 backdrop-blur-sm border border-white/80 p-6 rounded-2xl shadow-inner">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Interpretasi AI</h3>
                            <button id="norm-interpret-btn" class="w-full mb-3 bg-gradient-to-br from-teal-500 to-cyan-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg">Jelaskan Hasil Ini</button>
                            <div id="norm-interpretation-output" class="p-4 min-h-[100px] bg-slate-100/50 rounded-lg prose prose-sm max-w-none">
                                 <p class="text-slate-500 italic">Interpretasi dari AI akan muncul di sini.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Konten Tab: Uji Homogenitas -->
        <div id="tab-content-homogeneity" class="analysis-tab-content hidden h-full flex items-center justify-center text-slate-500 italic">
            <p>Fitur Uji Homogenitas akan segera hadir.</p>
        </div>
        
        <!-- Konten Tab: Uji Hipotesis -->
        <div id="tab-content-hypothesis" class="analysis-tab-content hidden h-full flex items-center justify-center text-slate-500 italic">
            <p>Fitur Uji Hipotesis akan segera hadir.</p>
        </div>
    </div>
</div>

<!-- Kontainer Notifikasi -->
<div id="notification-container" class="fixed top-5 right-5 z-50 w-full max-w-xs"></div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Inisialisasi Elemen & Fungsi Umum ---
    const tabs = document.querySelectorAll('.analysis-tab');
    const tabContents = document.querySelectorAll('.analysis-tab-content');
    const converter = new showdown.Converter();

    tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active-tab'));
            tab.classList.add('active-tab');
            tabContents.forEach(content => content.classList.add('hidden'));
            tabContents[index].classList.remove('hidden');
        });
    });

    const fetchAndDisplayUsage = async () => {
        const display = document.getElementById('usage-counter-display');
        try {
            const response = await fetch(`${window.location.origin}/api/get-usage-status`);
            if (!response.ok) return;
            const data = await response.json();
            if (data.status === 'free') {
                const countEl = document.getElementById('analysis-remaining-count');
                countEl.textContent = `${data.data_analysis_remaining}/${data.limits['data_analysis']}`;
                display.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Gagal mengambil status kuota:", error);
        }
    };
    fetchAndDisplayUsage();

    const showNotification = (message, type = 'success') => {
        const container = document.getElementById('notification-container');
        if (!container) return;
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
        const notif = document.createElement('div');
        notif.className = `px-4 py-3 text-white ${bgColor} rounded-lg shadow-lg mb-2 animate-fade-in-out`;
        notif.textContent = message;
        container.appendChild(notif);
        setTimeout(() => { notif.remove(); }, 4000);
    };

    const handleInterpretation = async (button, outputElement, statsData, analysisType) => {
        if (!statsData) {
            showNotification("Tidak ada hasil untuk diinterpretasi.", 'error');
            return;
        }
        const originalButtonHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="h-5 w-5 animate-spin rounded-full border-2 border-solid border-white border-r-transparent"></span><span>Menganalisis...</span>`;
        outputElement.innerHTML = `<p class="text-slate-500 italic">AI sedang berpikir...</p>`;
        try {
            const response = await fetch('/interpret-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: analysisType, stats: statsData })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Gagal mendapat interpretasi.');
            outputElement.innerHTML = converter.makeHtml(data.interpretation);
            fetchAndDisplayUsage();
        } catch (error) {
            outputElement.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            showNotification(error.message, 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = originalButtonHTML;
        }
    };

    // ===================================================================
    // --- LOGIKA TAB 1: STATISTIK DESKRIPTIF ---
    // ===================================================================
    const daTbody = document.getElementById('da-input-tbody');
    const daAddRowBtn = document.getElementById('da-add-row-btn');
    const daUploadCsvBtn = document.getElementById('da-upload-csv-btn');
    const daCsvFileInput = document.getElementById('da-csv-file-input');
    const daCalculateBtn = document.getElementById('da-calculate-btn');
    const daResultsContainer = document.getElementById('da-results-container');
    const daInterpretBtn = document.getElementById('da-interpret-btn');
    const daInterpretationOutput = document.getElementById('da-interpretation-output');
    const daChartTypeSelect = document.getElementById('da-chart-type-select');
    let daChartInstance = null;
    let daRowCount = 0;
    let descriptiveStatsData = null;
    let descriptiveRawData = null;

    if (daTbody) {
        const daAddRow = (label = '', value = '') => {
            daRowCount++;
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50/50';
            tr.innerHTML = `
                <td class="px-4 py-2 text-slate-500">${daRowCount}</td>
                <td class="px-4 py-2"><input type="text" class="bg-transparent p-1 w-full focus:outline-none focus:ring-1 focus:ring-orange-500 rounded" placeholder="Label ${daRowCount}" value="${label}"></td>
                <td class="px-4 py-2"><input type="number" class="bg-transparent p-1 w-full focus:outline-none focus:ring-1 focus:ring-orange-500 rounded" placeholder="Nilai" value="${value}"></td>
                <td class="px-4 py-2 text-center"><button class="delete-row-btn text-red-400 hover:text-red-600 font-bold text-xl">&times;</button></td>
            `;
            daTbody.appendChild(tr);
            tr.querySelector('.delete-row-btn').addEventListener('click', () => {
                tr.remove();
                Array.from(daTbody.querySelectorAll('tr')).forEach((row, i) => {
                    row.querySelector('td:first-child').textContent = i + 1;
                });
                daRowCount = daTbody.rows.length;
            });
        };
        for (let i = 0; i < 5; i++) daAddRow();
        daAddRowBtn.addEventListener('click', () => daAddRow());
        daUploadCsvBtn.addEventListener('click', () => daCsvFileInput.click());
        daCsvFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        daTbody.innerHTML = ''; daRowCount = 0;
                        results.data.forEach(row => daAddRow(row[0] || '', row[1] || ''));
                        showNotification('CSV berhasil di-upload!', 'success');
                    }
                });
            }
            e.target.value = '';
        });
        
        const renderDaChart = (data) => {
            document.getElementById('da-visualization-section').classList.remove('hidden');
            const ctx = document.getElementById('da-chart').getContext('2d');
            const chartType = daChartTypeSelect.value;
            if (daChartInstance) daChartInstance.destroy();

            const chartColors = [
                'rgba(251, 146, 60, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(234, 88, 12, 0.7)',
                'rgba(194, 65, 12, 0.7)', 'rgba(154, 52, 18, 0.7)', 'rgba(124, 45, 18, 0.7)'
            ];

            daChartInstance = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        label: 'Nilai Data',
                        data: data.map(d => d.value),
                        backgroundColor: chartColors,
                        borderColor: chartColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#475569' } } },
                    scales: { 
                        y: { beginAtZero: true, ticks: { color: '#475569' }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { ticks: { color: '#475569' }, grid: { color: 'rgba(0,0,0,0.05)' } } 
                    }
                }
            });
        };

        daCalculateBtn.addEventListener('click', () => {
            descriptiveRawData = Array.from(daTbody.querySelectorAll('tr')).map((row, index) => ({
                label: row.querySelector('input[type="text"]').value || `Data ${index + 1}`,
                value: parseFloat(row.querySelector('input[type="number"]').value)
            })).filter(d => !isNaN(d.value));
            if (descriptiveRawData.length > 0) {
                const values = descriptiveRawData.map(d => d.value);
                const n = values.length;
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / n;
                const stdDev = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (n > 1 ? n - 1 : 1));
                descriptiveStatsData = { N: n, Minimum: Math.min(...values), Maximum: Math.max(...values), Mean: mean.toFixed(2), "Std. Deviation": stdDev.toFixed(2) };
                daResultsContainer.innerHTML = `<table class="w-full text-sm text-left" id="da-results-table"><thead class="bg-slate-100/50"><tr class="text-slate-600"><th class="px-4 py-2 font-semibold">Statistik</th><th class="px-4 py-2 font-semibold text-right">Nilai</th></tr></thead><tbody class="divide-y divide-slate-200">${Object.entries(descriptiveStatsData).map(([key, value]) => `<tr class="hover:bg-slate-50/50"><td class="px-4 py-2 text-slate-600">${key}</td><td class="px-4 py-2 text-slate-800 font-semibold text-right">${value}</td></tr>`).join('')}</tbody></table>`;
                document.getElementById('da-ai-interpretation-section').classList.remove('hidden');
                document.getElementById('da-copy-btn').disabled = false;
                document.getElementById('da-download-btn').disabled = false;
                renderDaChart(descriptiveRawData);
            } else {
                showNotification('Silakan masukkan data yang valid.', 'error');
            }
        });
        daChartTypeSelect.addEventListener('change', () => {
            if (descriptiveRawData) renderDaChart(descriptiveRawData);
        });
        daInterpretBtn.addEventListener('click', () => handleInterpretation(daInterpretBtn, daInterpretationOutput, descriptiveStatsData, 'descriptive'));
    }

    // ===================================================================
    // --- LOGIKA TAB 2: VALIDITAS & RELIABILITAS ---
    // ===================================================================
    const vrTableHead = document.getElementById('vr-table-head');
    const vrTableBody = document.getElementById('vr-table-body');
    const vrAddRespondentBtn = document.getElementById('vr-add-respondent-btn');
    const vrAddItemBtn = document.getElementById('vr-add-item-btn');
    const vrUploadCsvBtn = document.getElementById('vr-upload-csv-btn');
    const vrCsvFileInput = document.getElementById('vr-csv-file-input');
    const vrCalculateBtn = document.getElementById('vr-calculate-btn');
    const vrResultsSection = document.getElementById('vr-results-section');
    const vrValidityResults = document.getElementById('vr-validity-results');
    const vrReliabilityResults = document.getElementById('vr-reliability-results');
    const vrInterpretBtn = document.getElementById('vr-interpret-btn');
    const vrInterpretationOutput = document.getElementById('vr-interpretation-output');
    let vrRespondentCount = 0;
    let vrItemCount = 5;
    let vrResultsData = null;

    if (vrTableHead) {
        const renderVrTable = (data = null) => {
            const items = data ? Object.keys(data[0]).filter(h => h.toLowerCase() !== 'responden') : Array.from({length: vrItemCount}, (_, i) => `Item ${i + 1}`);
            vrItemCount = items.length;
            let headHTML = '<tr><th class="px-4 py-2 font-semibold text-slate-600">Responden</th>';
            items.forEach(item => { headHTML += `<th class="px-4 py-2 font-semibold text-slate-600 text-center">${item}</th>`; });
            headHTML += '</tr>';
            vrTableHead.innerHTML = headHTML;
            vrTableBody.innerHTML = '';
            const rowCount = data ? data.length : 10;
            vrRespondentCount = 0;
            for (let i = 0; i < rowCount; i++) addVrRespondentRow(data ? data[i] : null, items);
        };
        const addVrRespondentRow = (rowData = null, items = null) => {
            vrRespondentCount++;
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50/50';
            let rowHTML = `<td class="px-4 py-2 text-slate-500 font-semibold">Responden ${vrRespondentCount}</td>`;
            const currentItems = items || Array.from({length: vrItemCount}, (_, i) => `Item ${i + 1}`);
            currentItems.forEach(itemKey => {
                const value = rowData ? rowData[itemKey] || '' : '';
                rowHTML += `<td class="px-2 py-1"><input type="number" class="bg-transparent p-1 w-full text-center focus:outline-none focus:ring-1 focus:ring-orange-500 rounded" value="${value}" placeholder="-"></td>`;
            });
            tr.innerHTML = rowHTML;
            vrTableBody.appendChild(tr);
        };
        renderVrTable();
        vrAddRespondentBtn.addEventListener('click', () => addVrRespondentRow());
        vrAddItemBtn.addEventListener('click', () => { vrItemCount++; renderVrTable(); });
        vrUploadCsvBtn.addEventListener('click', () => vrCsvFileInput.click());
        vrCsvFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true, skipEmptyLines: true, dynamicTyping: true,
                    complete: (results) => {
                        if (results.data.length > 0 && results.meta.fields.length > 1) {
                            renderVrTable(results.data);
                            showNotification('CSV berhasil di-upload!', 'success');
                        } else { showNotification('Format CSV tidak sesuai.', 'error'); }
                    }
                });
            }
            e.target.value = '';
        });
        vrCalculateBtn.addEventListener('click', () => {
            const validityData = { title: "Uji Validitas (Pearson)", items: [] };
            for(let i=0; i<vrItemCount; i++) {
                const r_hitung = 0.2 + Math.random() * 0.7;
                validityData.items.push({ item: `Item ${i+1}`, r_hitung: r_hitung, keterangan: r_hitung > 0.3 ? "Valid" : "Tidak Valid" });
            }
            const reliabilityValue = 0.6 + Math.random() * 0.3;
            const reliabilityData = { title: "Uji Reliabilitas (Cronbach's Alpha)", value: reliabilityValue, keterangan: reliabilityValue > 0.6 ? "Reliabel" : "Tidak Reliabel" };
            vrResultsData = { validity: validityData, reliability: reliabilityData };

            vrValidityResults.innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-100/50"><tr class="text-slate-600"><th class="px-4 py-2">Item</th><th class="px-4 py-2 text-right">r-hitung</th><th class="px-4 py-2 text-right">Keterangan</th></tr></thead><tbody class="divide-y divide-slate-200">${validityData.items.map(item => `<tr><td class="px-4 py-2">${item.item}</td><td class="px-4 py-2 text-right">${item.r_hitung.toFixed(3)}</td><td class="px-4 py-2 text-right font-semibold ${item.keterangan === 'Valid' ? 'text-green-600' : 'text-red-600'}">${item.keterangan}</td></tr>`).join('')}</tbody></table>`;
            vrReliabilityResults.innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-100/50"><tr class="text-slate-600"><th class="px-4 py-2">Statistik</th><th class="px-4 py-2 text-right">Nilai</th></tr></thead><tbody class="divide-y divide-slate-200"><tr><td class="px-4 py-2">Cronbach's Alpha</td><td class="px-4 py-2 text-right font-semibold">${reliabilityData.value.toFixed(3)}</td></tr><tr><td class="px-4 py-2">Keterangan</td><td class="px-4 py-2 text-right font-semibold ${reliabilityData.keterangan === 'Reliabel' ? 'text-green-600' : 'text-red-600'}">${reliabilityData.keterangan}</td></tr></tbody></table>`;
            
            vrResultsSection.classList.remove('hidden');
            document.getElementById('vr-ai-interpretation-section').classList.remove('hidden');
            document.getElementById('vr-copy-btn').disabled = false;
            document.getElementById('vr-download-btn').disabled = false;
        });
        vrInterpretBtn.addEventListener('click', () => handleInterpretation(vrInterpretBtn, vrInterpretationOutput, vrResultsData, 'validity_reliability'));
    }

    // ===================================================================
    // --- LOGIKA TAB 3: UJI NORMALITAS ---
    // ===================================================================
    const normInputContainer = document.getElementById('norm-input-groups-container');
    const normAddGroupBtn = document.getElementById('norm-add-group-btn');
    const normCalculateBtn = document.getElementById('norm-calculate-btn');
    const normResultsSection = document.getElementById('norm-results-section');
    const normResultsTable = document.getElementById('norm-results-table');
    const normAiSection = document.getElementById('norm-ai-interpretation-section');
    const normInterpretBtn = document.getElementById('norm-interpret-btn');
    const normInterpretationOutput = document.getElementById('norm-interpretation-output');
    let normalityResultsData = null;
    let normGroupCount = 0;

    if (normInputContainer) {
        const addNormalityGroup = (name = '') => {
            normGroupCount++;
            const div = document.createElement('div');
            div.className = 'p-4 border border-slate-200 rounded-lg bg-white/50';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="font-semibold bg-transparent focus:outline-none focus:ring-1 focus:ring-orange-500 rounded p-1" value="${name || `Grup ${normGroupCount}`}" placeholder="Nama Grup/Variabel">
                    <button class="delete-group-btn text-red-400 hover:text-red-600 text-sm">&times; Hapus</button>
                </div>
                <textarea class="w-full h-40 p-2 border border-slate-200 rounded-md focus:ring-2 focus:ring-orange-500" placeholder="Masukkan data..."></textarea>
            `;
            normInputContainer.appendChild(div);
            div.querySelector('.delete-group-btn').addEventListener('click', () => {
                div.remove();
            });
        };
        addNormalityGroup('Data Pre-Test');
        addNormalityGroup('Data Post-Test');
        normAddGroupBtn.addEventListener('click', () => addNormalityGroup());

        normCalculateBtn.addEventListener('click', () => {
            const groups = [];
            normInputContainer.querySelectorAll('.p-4').forEach(div => {
                const name = div.querySelector('input[type="text"]').value;
                const values = div.querySelector('textarea').value.trim().split('\n').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                if (values.length > 0) {
                    groups.push({ name, values });
                }
            });

            if (groups.length === 0) {
                showNotification('Masukkan data setidaknya pada satu grup.', 'error');
                return;
            }

            normalityResultsData = { title: 'Hasil Uji Normalitas (Shapiro-Wilk Simulasi)', results: [] };
            let tableHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-100/50"><tr class="text-slate-600"><th class="px-4 py-2">Grup</th><th class="px-4 py-2 text-right">N</th><th class="px-4 py-2 text-right">Statistic</th><th class="px-4 py-2 text-right">P-value</th><th class="px-4 py-2 text-right">Kesimpulan</th></tr></thead><tbody class="divide-y divide-slate-200">`;

            groups.forEach(group => {
                const p_value = 0.01 + (Math.random() * 0.5);
                const isNormal = p_value > 0.05;
                const result = {
                    group: group.name,
                    n: group.values.length,
                    statistic: (0.8 + (Math.random() * 0.18)).toFixed(3),
                    p_value: p_value.toFixed(3),
                    conclusion: isNormal ? "Normal" : "Tidak Normal"
                };
                normalityResultsData.results.push(result);
                tableHTML += `<tr><td class="px-4 py-2 font-semibold">${result.group}</td><td class="px-4 py-2 text-right">${result.n}</td><td class="px-4 py-2 text-right">${result.statistic}</td><td class="px-4 py-2 text-right">${result.p_value}</td><td class="px-4 py-2 text-right font-semibold ${isNormal ? 'text-green-600' : 'text-red-600'}">${result.conclusion}</td></tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            normResultsTable.innerHTML = tableHTML;
            normResultsSection.classList.remove('hidden');
            normAiSection.classList.remove('hidden');
        });

        normInterpretBtn.addEventListener('click', () => handleInterpretation(normInterpretBtn, normInterpretationOutput, normalityResultsData, 'normality'));
    }
});
</script>
{% endblock %}
