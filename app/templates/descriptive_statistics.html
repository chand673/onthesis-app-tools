{% extends "layout.html" %}

{% block title %}Statistik Deskriptif - OnThesis{% endblock %}

{% block page_styles %}
<style>
    /* Gaya untuk input dinamis */
    .variable-group {
        transition: background-color 0.2s ease-in-out;
    }
    .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    /* Gaya untuk output hasil dengan tab */
    .nav-tabs .nav-link {
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        color: var(--text-secondary);
        border-radius: 0.5rem 0.5rem 0 0;
        margin-right: 2px;
        padding: 0.5rem 1rem;
    }
    .nav-tabs .nav-link.active {
        background-color: var(--accent-cyan);
        color: white;
        border-color: var(--accent-cyan);
    }
    .tab-content {
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        border-top: none;
        padding: 1.5rem;
        border-radius: 0 0 0.5rem 0.5rem;
    }
    .stat-table {
        width: 100%;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
    }
    .stat-table th, .stat-table td {
        padding: 0.6rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-panel);
    }
    .stat-table tr:last-child th,
    .stat-table tr:last-child td {
        border-bottom: none;
    }
    .stat-table th {
        color: var(--text-secondary);
        font-weight: 500;
        width: 50%;
    }
    .stat-table td {
        color: var(--text-primary);
        font-weight: 600;
    }
    .plots-container img {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
        border: 1px solid var(--border-panel);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Analisis Statistik Deskriptif</h1>
        <p class="text-lg text-text-secondary mt-1">Dapatkan ringkasan statistik dan visualisasi dari data Anda.</p>
    </header>

    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Kartu Input -->
        <div class="apex-card p-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Variabel</h3>
            <p class="text-sm text-text-secondary mb-4 max-w-2xl mx-auto text-center">Masukkan data untuk setiap variabel yang ingin dianalisis. Anda dapat menambah atau menghapus variabel sesuai kebutuhan.</p>
            
            <div id="variablesContainer" class="space-y-4 text-left">
                <!-- Input variabel dinamis akan ditambahkan di sini oleh JavaScript -->
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-4 pt-4 border-t border-border-panel">
                <button id="addVariable" class="btn-secondary flex-1">+ Tambah Variabel</button>
                <button id="removeVariable" class="btn-secondary flex-1">- Hapus Variabel</button>
                <button id="loadSample" class="btn-secondary flex-1">Muat Contoh</button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border-panel">
                <div class="flex justify-center">
                    <button id="runAnalysis" class="btn-primary w-full md:w-1/2">Jalankan Analisis</button>
                </div>
            </div>
        </div>
        
        <!-- Pesan Error Dinamis -->
        <div id="error-container" class="apex-card p-4 bg-red-500/10 border-red-500/30 text-red-400" style="display: none;"></div>

        <!-- Kontainer Output -->
        <div id="output" class="space-y-4" style="display:none;">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
            </div>
            <div id="results-tabs-nav" class="nav nav-tabs"></div>
            <div id="results-tabs-content" class="tab-content"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    let analysisData = null; // Untuk menyimpan hasil analisis

    const createVariable = (name = '', data = '') => {
        const varCount = $('#variablesContainer').children().length + 1;
        const varName = name || `Variabel_${varCount}`;
        const varHtml = `
            <div class="variable-group p-4 border border-border-panel rounded-lg bg-bg-canvas">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="bg-transparent font-semibold text-text-primary focus:outline-none w-full variable-name-input" value="${varName}" placeholder="Nama Variabel">
                    <button class="text-text-secondary hover:text-red-400 remove-variable-btn text-xl font-bold" title="Hapus Variabel Ini">&times;</button>
                </div>
                <textarea class="feedback-form-input data-input h-24" placeholder="Masukkan data numerik, pisahkan dengan koma, spasi, atau baris baru...">${data}</textarea>
            </div>
        `;
        $('#variablesContainer').append(varHtml);
    };

    createVariable(); // Mulai dengan satu input

    $('#addVariable').on('click', () => createVariable());

    $('#removeVariable').on('click', function() {
        if ($('#variablesContainer > .variable-group').length > 1) {
            $('#variablesContainer > .variable-group').last().remove();
        } else {
            alert('Minimal harus ada satu variabel.');
        }
    });
    
    $('#variablesContainer').on('click', '.remove-variable-btn', function() {
        if ($('#variablesContainer > .variable-group').length > 1) {
            $(this).closest('.variable-group').remove();
        } else {
            alert('Minimal harus ada satu variabel.');
        }
    });

    $('#loadSample').on('click', () => {
        $('#variablesContainer').empty();
        createVariable('Tinggi_Badan_cm', '165, 170, 155, 180, 168, 172, 160, 175, 166, 159');
        createVariable('Skor_IQ', '110, 112, 105, 120, 115, 118, 108, 122, 113, 109');
    });

    $('#runAnalysis').on('click', async function() {
        $('.input-error').removeClass('input-error');
        $('#error-container').hide().empty();
        let hasError = false;
        const dataForAnalysis = {};
        const variableNames = new Set();

        $('.variable-group').each(function() {
            const nameInput = $(this).find('.variable-name-input');
            let name = nameInput.val().trim().replace(/\s+/g, '_');
            const textarea = $(this).find('.data-input');
            const rawData = textarea.val().trim();
            
            if (!name) { hasError = true; nameInput.addClass('input-error'); return; }
            if (variableNames.has(name)) { alert(`Nama variabel duplikat: "${name}".`); hasError = true; nameInput.addClass('input-error'); return; }
            variableNames.add(name);

            if (rawData === '') { hasError = true; textarea.addClass('input-error'); return; }
            const values = rawData.split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            if (values.length < 2) { hasError = true; textarea.addClass('input-error'); } 
            else { dataForAnalysis[name] = values; }
        });

        if (hasError) { alert('Periksa input Anda. Setiap variabel harus punya nama unik dan minimal 2 data numerik.'); return; }
        if (Object.keys(dataForAnalysis).length === 0) { alert('Tidak ada data valid untuk dianalisis.'); return; }

        const button = $(this);
        button.prop('disabled', true).html('<div class="spinner w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>');
        $('#output').slideUp();

        try {
            const response = await fetch("{{ url_for('api_descriptive_analysis') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataForAnalysis)
            });

            const result = await response.json();
            if (!response.ok) { throw new Error(result.error || 'Terjadi kesalahan pada server.'); }
            
            analysisData = result; // Simpan hasil untuk interpretasi AI
            displayResults(analysisData);

        } catch (e) {
            $('#error-container').text(e.message).slideDown();
        } finally {
            button.prop('disabled', false).text('Jalankan Analisis');
        }
    });

    function displayResults(data) {
        const tabsNav = $('#results-tabs-nav').empty();
        const tabsContent = $('#results-tabs-content').empty();

        data.columns.forEach((col, index) => {
            const isActive = index === 0;
            const stats = data.results[col];
            if (!stats || stats.n === 0) return;
            const safeColId = col.replace(/[^a-zA-Z0-9]/g, '_');

            tabsNav.append(`<button class="nav-link ${isActive ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#tab-${safeColId}" type="button">${col}</button>`);
            
            const formatNum = (num) => (num !== null && num !== undefined) ? Number(num).toFixed(3) : 'N/A';
            
            tabsContent.append(`
                <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="tab-${safeColId}">
                    <div class="mb-6 border-b border-border-panel pb-6">
                        <h4 class="text-lg font-bold text-text-primary mb-2">Ringkasan Otomatis (AI)</h4>
                        <button class="btn-secondary w-full mb-4 interpret-btn" data-col="${col}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                            <span class="btn-text">Buat Interpretasi untuk Variabel '${col}'</span>
                            <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                        </button>
                        <div id="interpretation-${safeColId}" class="prose prose-sm max-w-none text-text-secondary dark:prose-invert bg-bg-subtle p-4 rounded-lg border border-border-panel" style="display: none;"></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-bold text-text-primary mb-2">Statistik Deskriptif</h4>
                            <table class="stat-table"><tbody>
                                <tr><th>Mean</th><td>${formatNum(stats.mean)}</td></tr>
                                <tr><th>Median</th><td>${formatNum(stats.median)}</td></tr>
                                <tr><th>Modus</th><td>${stats.mode.join(', ')}</td></tr>
                                <tr><th>Std. Deviasi</th><td>${formatNum(stats.std)}</td></tr>
                                <tr><th>Varian</th><td>${formatNum(stats.variance)}</td></tr>
                                <tr><th>Range</th><td>${formatNum(stats.range)}</td></tr>
                                <tr><th>Minimum</th><td>${formatNum(stats.min)}</td></tr>
                                <tr><th>Maksimum</th><td>${formatNum(stats.max)}</td></tr>
                            </tbody></table>
                        </div>
                        <div class="plots-container space-y-4">
                            ${data.plots[col+'_histogram'] ? `<img src="${data.plots[col+'_histogram']}" alt="Histogram">` : ''}
                            ${data.plots[col+'_boxplot'] ? `<img src="${data.plots[col+'_boxplot']}" alt="Boxplot">` : ''}
                        </div>
                    </div>
                </div>
            `);
        });

        $('#output').slideDown();
        $('html, body').animate({ scrollTop: $("#output").offset().top - 80 }, 500);
    }

    $(document).on('click', '.nav-link', function(e) {
        e.preventDefault();
        $('.nav-link').removeClass('active');
        $('.tab-pane').removeClass('show active');
        $(this).addClass('active');
        $($(this).data('bs-target')).addClass('show active');
    });

    $(document).on('click', '.interpret-btn', function() {
        const btn = $(this);
        const col = btn.data('col');
        const safeColId = col.replace(/[^a-zA-Z0-9]/g, '_');
        const stats = analysisData.results[col];
        const btnText = btn.find('.btn-text');
        const spinner = btn.find('.spinner');
        const outputDiv = $(`#interpretation-${safeColId}`);

        btnText.text('Menganalisis...');
        spinner.removeClass('hidden');
        btn.prop('disabled', true);
        outputDiv.slideUp();

        const prompt = `Anda adalah seorang ahli statistik. Berikan interpretasi profesional untuk hasil statistik deskriptif dari variabel "${col}" berikut dalam format HTML.

**Data Statistik:**
- N (Jumlah Data): ${stats.n}
- Mean: ${stats.mean.toFixed(3)}
- Median: ${stats.median.toFixed(3)}
- Modus: ${stats.mode.join(', ')}
- Standar Deviasi: ${stats.std.toFixed(3)}

**Tugas Anda:**
Buat ringkasan naratif yang mudah dipahami. Bahas tendensi sentral (mean, median, modus) dan sebaran data (standar deviasi). Gunakan format HTML yang rapi dengan <h4>, <p>, dan <strong>. Jangan sertakan tag <html> atau <body>.`;

        $.ajax({
            url: "{{ url_for('interpret_analysis') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stats: prompt }),
            success: (res) => outputDiv.html(res.interpretation.replace(/^```html\s*|```\s*$/g, '').trim()).slideDown(),
            error: (err) => outputDiv.html(`<p class="text-red-400">Gagal: ${err.responseJSON ? err.responseJSON.error : 'Error'}</p>`).slideDown(),
            complete: () => {
                btnText.text(`Buat Interpretasi untuk Variabel '${col}'`);
                spinner.addClass('hidden');
                btn.prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}
