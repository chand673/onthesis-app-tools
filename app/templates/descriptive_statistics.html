{% extends "layout.html" %}

{% block title %}Statistik Deskriptif - OnThesis{% endblock %}

{% block page_styles %}
<style>
    /* Gaya untuk menandai input yang error */
    .input-error {
        border-color: #ef4444 !important; /* Warna merah */
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
    .nav-tabs .nav-link {
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        color: var(--text-secondary);
    }
    .nav-tabs .nav-link.active {
        background-color: var(--accent-cyan);
        color: white;
        border-color: var(--accent-cyan);
    }
    .stat-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
    }
    .stat-table th, .stat-table td {
        border: 1px solid var(--border-panel);
        padding: 8px 12px;
        text-align: left;
    }
    .stat-table th {
        background-color: var(--bg-canvas);
        font-weight: bold;
        color: var(--text-primary);
        width: 50%;
    }
    .stat-table td {
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Analisis Statistik Deskriptif</h1>
        <p class="text-lg text-text-secondary mt-1">Dapatkan ringkasan statistik dan visualisasi dari data Anda.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Kartu Input -->
        <div class="apex-card p-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Variabel</h3>
            <p class="text-sm text-text-secondary mb-4 max-w-2xl mx-auto text-center">Masukkan data untuk setiap variabel yang ingin dianalisis. Anda dapat menambah atau menghapus variabel sesuai kebutuhan.</p>
            
            <div id="variablesContainer" class="space-y-4 text-left">
                <!-- Input variabel dinamis akan ditambahkan di sini oleh JavaScript -->
            </div>

            <div class="flex flex-wrap gap-4 mt-4 pt-4 border-t border-border-panel">
                <button id="addVariable" class="btn-secondary flex-1">+ Tambah Variabel</button>
                <button id="removeVariable" class="btn-secondary flex-1">- Hapus Variabel</button>
                <button id="loadSample" class="btn-secondary flex-1">Muat Contoh</button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border-panel">
                <div class="flex justify-center">
                    <button id="runAnalysis" class="btn-primary w-full md:w-1/2">Jalankan Analisis</button>
                </div>
            </div>
        </div>

        <!-- Kontainer Output -->
        <div id="output" class="space-y-8" style="display:none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
            </div>
            
            <div class="apex-card p-6">
                <div id="results-tabs-nav" class="nav nav-tabs mb-4 border-b border-border-panel"></div>
                <div id="results-tabs-content" class="tab-content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    let analysisData = null;

    const createVariable = (name = '', data = '') => {
        const varCount = $('#variablesContainer').children().length + 1;
        const varName = name || `Variabel ${varCount}`;
        const varHtml = `
            <div class="variable-group p-4 border border-border-panel rounded-lg bg-bg-canvas">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="bg-transparent font-semibold text-text-primary focus:outline-none w-full variable-name-input" value="${varName}" placeholder="Nama Variabel">
                    <button class="text-text-secondary hover:text-red-400 remove-variable-btn text-xl font-bold" title="Hapus Variabel Ini">&times;</button>
                </div>
                <textarea class="feedback-form-input data-input" placeholder="Masukkan data numerik, pisahkan dengan koma, spasi, atau baris baru...">${data}</textarea>
            </div>
        `;
        $('#variablesContainer').append(varHtml);
    };

    // Inisialisasi dengan satu variabel
    createVariable();

    $('#addVariable').click(() => createVariable());

    $('#removeVariable').click(function() {
        if ($('#variablesContainer').children().length > 1) {
            $('#variablesContainer').children().last().remove();
        } else {
            alert('Minimal harus ada satu variabel.');
        }
    });
    
    $('#variablesContainer').on('click', '.remove-variable-btn', function() {
        if ($('#variablesContainer').children().length > 1) {
            $(this).closest('.variable-group').remove();
        } else {
            alert('Minimal harus ada satu variabel.');
        }
    });

    $('#loadSample').click(() => {
        $('#variablesContainer').empty();
        createVariable('Tinggi Badan (cm)', '165, 170, 155, 180, 168, 172, 160, 175, 166, 159');
        createVariable('Berat Badan (kg)', '60, 72, 58, 85, 65, 70, 62, 78, 64, 55');
    });

    $('#runAnalysis').click(async function() {
        $('.data-input').removeClass('input-error');
        let hasError = false;
        const dataForAnalysis = {};

        $('.variable-group').each(function() {
            const groupEl = $(this);
            const nameInput = groupEl.find('.variable-name-input');
            const name = nameInput.val().trim();
            const textarea = groupEl.find('.data-input');
            const rawData = textarea.val().trim();
            
            if (!name) {
                hasError = true;
                nameInput.addClass('input-error');
                return; // Lanjut ke iterasi berikutnya
            }
            if (rawData === '') {
                hasError = true;
                textarea.addClass('input-error');
                return;
            }

            const values = rawData.split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            
            if (values.length < 2) {
                hasError = true;
                textarea.addClass('input-error');
            } else {
                dataForAnalysis[name] = values;
            }
        });

        if (hasError) {
            alert('Setiap variabel harus memiliki nama dan minimal 2 data numerik. Kolom yang bermasalah telah ditandai.');
            return;
        }

        if (Object.keys(dataForAnalysis).length === 0) {
            alert('Tidak ada data valid untuk dianalisis.');
            return;
        }

        const button = $(this);
        button.prop('disabled', true).html('<div class="spinner w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>');
        $('#output').hide();
        $('#interpretationOutput').hide().empty();

        try {
            const response = await fetch("{{ url_for('descriptive_analysis') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataForAnalysis)
            });

            analysisData = await response.json();
            if (!response.ok) {
                throw new Error(analysisData.error || 'Terjadi kesalahan pada server.');
            }
            
            displayResults(analysisData);

        } catch (e) {
            alert('Error: ' + e.message);
        } finally {
            button.prop('disabled', false).text('Jalankan Analisis');
        }
    });

    function displayResults(data) {
        $('#output').show();
        $('html, body').animate({
            scrollTop: $("#output").offset().top - 80
        }, 500);

        const tabsNav = $('#results-tabs-nav').empty();
        const tabsContent = $('#results-tabs-content').empty();

        data.columns.forEach((col, index) => {
            const isActive = index === 0;
            const stats = data.results[col];
            if (!stats || stats.n === 0) return;

            const safeColId = col.replace(/[^a-zA-Z0-9]/g, '_');

            tabsNav.append(
                `<button class="nav-link ${isActive ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#content-${safeColId}" type="button">${col}</button>`
            );

            const formatNum = (num) => (num !== null && num !== undefined) ? Number(num).toFixed(3) : 'N/A';
            
            let freqTableHtml = '<div class="overflow-y-auto max-h-96"><table class="stat-table"><thead><tr><th>Nilai</th><th>Frekuensi</th><th>Persen (%)</th></tr></thead><tbody>';
            let valueCounts = {};
            stats.raw_data.forEach(val => { valueCounts[val] = (valueCounts[val] || 0) + 1; });
            Object.entries(valueCounts).sort((a,b) => Number(a[0]) - Number(b[0])).forEach(([value, count]) => {
                const percent = ((count / stats.n) * 100).toFixed(2);
                freqTableHtml += `<tr><td>${value}</td><td>${count}</td><td>${percent}%</td></tr>`;
            });
            freqTableHtml += '</tbody></table></div>';

            tabsContent.append(`
                <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="content-${safeColId}">
                    <div class="mb-6 border-b border-border-panel pb-6">
                        <h4 class="text-lg font-bold text-text-primary mb-2">Ringkasan Otomatis (AI)</h4>
                        <button class="btn-secondary w-full mb-4 interpret-btn" data-col="${col}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                            <span class="btn-text">Buat Interpretasi untuk Variabel '${col}'</span>
                            <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                        </button>
                        <div id="interpretation-${safeColId}" class="prose prose-sm max-w-none text-text-secondary dark:prose-invert bg-bg-canvas p-4 rounded-lg border border-border-panel" style="display: none;"></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-bold text-text-primary mb-2">Ukuran Pemusatan</h4>
                                <table class="stat-table"><tbody>
                                    <tr><th>Mean (Rata-rata)</th><td>${formatNum(stats.mean)}</td></tr>
                                    <tr><th>Median (Nilai Tengah)</th><td>${formatNum(stats.median)}</td></tr>
                                    <tr><th>Modus</th><td>${stats.mode.join(', ')}</td></tr>
                                </tbody></table>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-text-primary mb-2">Ukuran Penyebaran</h4>
                                <table class="stat-table"><tbody>
                                    <tr><th>Standar Deviasi</th><td>${formatNum(stats.std)}</td></tr>
                                    <tr><th>Varian</th><td>${formatNum(stats.variance)}</td></tr>
                                    <tr><th>Range</th><td>${formatNum(stats.range)}</td></tr>
                                    <tr><th>Minimum</th><td>${formatNum(stats.min)}</td></tr>
                                    <tr><th>Maksimum</th><td>${formatNum(stats.max)}</td></tr>
                                    <tr><th>Interquartile Range (IQR)</th><td>${formatNum(stats.iqr)}</td></tr>
                                </tbody></table>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-text-primary mb-2">Distribusi Frekuensi</h4>
                            ${freqTableHtml}
                        </div>
                    </div>
                    
                    <div class="mt-8 border-t border-border-panel pt-8">
                        <h3 class="text-xl font-bold text-text-primary mb-4 text-center">Visualisasi Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${data.plots[col+'_histogram'] ? `<img src="${data.plots[col+'_histogram']}" class="w-full rounded-lg border border-border-panel">` : ''}
                            ${data.plots[col+'_boxplot'] ? `<img src="${data.plots[col+'_boxplot']}" class="w-full rounded-lg border border-border-panel">` : ''}
                            ${data.plots[col+'_barchart'] ? `<img src="${data.plots[col+'_barchart']}" class="w-full rounded-lg border border-border-panel">` : ''}
                            ${data.plots[col+'_pie'] ? `<div class="md:col-span-2 flex justify-center"><img src="${data.plots[col+'_pie']}" class="w-full max-w-md mx-auto rounded-lg border border-border-panel"></div>` : ''}
                        </div>
                    </div>
                </div>
            `);
        });

        $('.nav-link').on('click', function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $('.tab-pane').removeClass('show active');
            $(this).addClass('active');
            $($(this).data('bs-target')).addClass('show active');
        });
    }

    $(document).on('click', '.interpret-btn', function() {
        // ... (Logika interpretasi AI sama seperti sebelumnya, tidak perlu diubah)
        const btn = $(this);
        const col = btn.data('col');
        const safeColId = col.replace(/[^a-zA-Z0-9]/g, '_');
        const stats = analysisData.results[col];
        const btnText = btn.find('.btn-text');
        const spinner = btn.find('.spinner');

        btnText.text('Menganalisis...');
        spinner.removeClass('hidden');
        btn.prop('disabled', true);

        const prompt = `Anda adalah seorang ahli statistik. Berikan interpretasi profesional untuk hasil statistik deskriptif dari variabel "${col}" berikut dalam format HTML.

**Data Statistik:**
- N (Jumlah Data): ${stats.n}
- Mean: ${stats.mean.toFixed(3)}
- Median: ${stats.median.toFixed(3)}
- Modus: ${stats.mode.join(', ')}
- Standar Deviasi: ${stats.std.toFixed(3)}
- Varian: ${stats.variance.toFixed(3)}
- Range: ${stats.range.toFixed(3)}
- Skewness: ${stats.skewness.toFixed(3)}
- Kurtosis: ${stats.kurtosis.toFixed(3)}
- Shapiro-Wilk (p-value): ${stats.shapiro_p ? stats.shapiro_p.toFixed(3) : 'N/A'}

**Tugas Anda:**
Buat ringkasan naratif yang menjelaskan temuan utama dari data ini. Bahas tendensi sentral (mean, median, modus), sebaran data (standar deviasi, range), bentuk distribusi (skewness, kurtosis), dan jika ada, hasil uji normalitas (Shapiro-Wilk). Gunakan format yang rapi menggunakan elemen HTML seperti <h4>, <p>, dan <strong>. Jangan sertakan tag <html>, <body>, atau \`\`\`html.`;

        $.ajax({
            url: "{{ url_for('interpret_analysis') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stats: prompt }),
            success: function(res) {
                const cleanedHtml = res.interpretation.replace(/^```html\s*|```\s*$/g, '').trim();
                $(`#interpretation-${safeColId}`).html(cleanedHtml).show();
            },
            error: function(err) {
                $(`#interpretation-${safeColId}`).html(`<p class="text-red-400">Gagal mendapatkan interpretasi: ${err.responseJSON ? err.responseJSON.error : 'Error'}</p>`).show();
            },
            complete: function() {
                btnText.text(`Buat Interpretasi untuk Variabel '${col}'`);
                spinner.addClass('hidden');
                btn.prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}
