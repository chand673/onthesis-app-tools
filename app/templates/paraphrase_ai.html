{% extends "layout.html" %}

{% block title %}Parafrase AI - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Ekspor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<style>
    .prose h1, .prose h2, .prose h3, .prose h4, .prose p, .prose ul, .prose li {
        color: var(--text-secondary);
    }
    .prose strong {
        color: var(--text-primary);
    }
    /* Custom slider style */
    input[type=range] {
        /* PERBAIKAN: Menambahkan properti standar 'appearance' */
        -webkit-appearance: none; /* Untuk browser lama */
        appearance: none; /* Standar, untuk browser modern */
        background: transparent;
        cursor: pointer;
        width: 100%;
    }
    input[type=range]::-webkit-slider-runnable-track {
        background: var(--border-panel);
        height: 0.5rem;
        border-radius: 0.5rem;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        margin-top: -4px;
        background-color: var(--accent-cyan);
        height: 1.25rem;
        width: 1.25rem;
        border-radius: 50%;
        border: 2px solid var(--bg-panel);
    }
    input[type=range]:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 3px var(--bg-panel), 0 0 0 6px var(--accent-cyan-glow);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Parafrase AI</h1>
        <p class="text-lg text-text-secondary mt-1">Ubah tulisanmu agar tidak terdeteksi sebagai hasil copy-paste.</p>
    </header>

    <div class="max-w-6xl mx-auto space-y-8">
        <div class="apex-card p-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Kolom Input -->
                <div>
                    <h3 class="text-xl font-bold text-text-primary mb-2">Teks Asli</h3>
                    <p class="text-sm text-text-secondary mb-4">Tempel teks yang ingin Anda ubah di sini.</p>
                    <textarea id="paraphrase-input" class="feedback-form-input h-80" placeholder="Contoh: Menurut penelitian, mahasiswa seringkali menunda pekerjaan skripsi mereka..."></textarea>
                </div>
                <!-- Kolom Output -->
                <div>
                    <h3 class="text-xl font-bold text-text-primary mb-2">Hasil Parafrase</h3>
                    <p class="text-sm text-text-secondary mb-4">AI akan menulis ulang teks Anda di sini.</p>
                    <div id="paraphrase-output" class="w-full h-80 p-4 bg-bg-canvas border border-border-panel rounded-lg overflow-y-auto prose max-w-none">
                        <p class="italic text-text-secondary">Hasil akan muncul di sini...</p>
                    </div>
                </div>
            </div>

            <!-- Pengaturan & Tombol Aksi -->
            <div class="mt-8 pt-6 border-t border-border-panel">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <!-- Slider Intensitas -->
                    <div>
                        <label for="intensity-slider" class="block text-sm font-medium text-text-primary mb-2">Tingkat Perubahan: <span id="intensity-label" class="font-bold text-accent-cyan">Standar</span></label>
                        <input id="intensity-slider" type="range" min="1" max="3" value="2" class="w-full">
                    </div>
                    <!-- Tombol Utama -->
                    <div class="flex justify-end items-center gap-4">
                        <button id="export-pdf-btn" class="btn-secondary">Export PDF</button>
                        <button id="export-doc-btn" class="btn-secondary">Export DOC</button>
                        <button id="paraphrase-btn" class="btn-primary">
                            <span class="btn-text">Parafrase Sekarang</span>
                            <div class="spinner hidden ml-2"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    const paraphraseBtn = $('#paraphrase-btn');
    const paraphraseInput = $('#paraphrase-input');
    const paraphraseOutput = $('#paraphrase-output');
    const intensitySlider = $('#intensity-slider');
    const intensityLabel = $('#intensity-label');
    const exportPdfBtn = $('#export-pdf-btn');
    const exportDocBtn = $('#export-doc-btn');
    const converter = new showdown.Converter({ simpleLineBreaks: true });

    const intensityMap = {
        '1': 'Sedikit Berbeda',
        '2': 'Standar',
        '3': 'Sangat Berbeda'
    };

    intensitySlider.on('input', function() {
        intensityLabel.text(intensityMap[$(this).val()]);
    });

    const setLoadingState = (isLoading) => {
        paraphraseBtn.prop('disabled', isLoading);
        paraphraseBtn.find('.btn-text').toggleClass('hidden', isLoading);
        paraphraseBtn.find('.spinner').toggleClass('hidden', !isLoading);
    };

    paraphraseBtn.on('click', async function() {
        const text = paraphraseInput.val().trim();
        const intensity = intensitySlider.val();
        if (!text) {
            alert('Teks tidak boleh kosong.');
            return;
        }

        setLoadingState(true);
        paraphraseOutput.html('<p class="italic text-text-secondary">AI sedang bekerja, mohon tunggu...</p>');

        try {
            const response = await fetch("{{ url_for('paraphrase_text') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text, intensity: intensity })
            });
            const data = await response.json();
            if (!response.ok) {
                if(data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    throw new Error(data.error || 'Terjadi kesalahan.');
                }
                return;
            }
            paraphraseOutput.html(converter.makeHtml(data.paraphrased_text));
        } catch (error) {
            paraphraseOutput.html(`<p class="text-red-400 font-semibold">${error.message}</p>`);
        } finally {
            setLoadingState(false);
        }
    });

    const exportHandler = async (format) => {
        const content = paraphraseOutput.html();
        const plainText = paraphraseOutput.text();
        if (!plainText || plainText === 'Hasil akan muncul di sini...') {
            alert('Tidak ada hasil untuk diekspor.');
            return;
        }

        const btn = format === 'pdf' ? exportPdfBtn : exportDocBtn;
        const originalText = btn.text();
        btn.prop('disabled', true).text('Memproses...');

        try {
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                doc.html(content, {
                    callback: function(doc) {
                        doc.save('hasil-parafrase-onthesis.pdf');
                    },
                    x: 15,
                    y: 15,
                    width: 170,
                    windowWidth: 650
                });
            } else if (format === 'doc') {
                const contentBlob = htmlDocx.asBlob(content);
                saveAs(contentBlob, 'hasil-parafrase-onthesis.doc');
            }
        } catch (e) {
            alert('Gagal mengekspor file.');
            console.error(e);
        } finally {
            btn.prop('disabled', false).text(originalText);
        }
    };

    exportPdfBtn.on('click', () => exportHandler('pdf'));
    exportDocBtn.on('click', () => exportHandler('doc'));
});
</script>
{% endblock %}
