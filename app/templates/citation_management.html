<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Sitasi - OnThesis</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Konfigurasi untuk Dark Mode dan Styling Tambahan -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'bg-primary': '#121212',
                        'bg-secondary': '#1E1E1E',
                        'bg-canvas': '#242424',
                        'text-primary': '#E0E0E0',
                        'text-secondary': '#B0B0B0',
                        'border-panel': '#333333',
                        'border-panel-hover': '#444444',
                        'primary-accent': '#3B82F6', // Biru
                        'primary-accent-hover': '#2563EB',
                    }
                }
            }
        }
    </script>
    
    <!-- CSS untuk komponen custom dan animasi -->
    <style>
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');

        .apex-card { background-color: #1E1E1E; border-radius: 0.75rem; border: 1px solid #333333; }
        .btn-primary { background-color: #3B82F6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2563EB; }
        .btn-secondary { background-color: #374151; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #4B5563; }
        .feedback-form-input { width: 100%; background-color: #242424; border: 1px solid #333333; border-radius: 0.5rem; padding: 0.75rem; color: #E0E0E0; }
        .feedback-form-input:focus { outline: none; border-color: #3B82F6; }
        .feedback-modal { transition: opacity 0.3s ease; }
        .feedback-modal-content { background-color: #1E1E1E; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        .animate-fade-out-down { animation: fadeOutDown 0.3s ease-in forwards; }
        @keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="animate-fade-in-up max-w-4xl mx-auto">
    <!-- Header Halaman -->
    <header class="flex flex-wrap justify-between items-center gap-4 mb-8 text-center md:text-left">
        <div class="w-full md:w-auto">
            <h1 class="text-4xl font-extrabold text-text-primary">Manajemen Sitasi</h1>
            <p class="text-lg text-text-secondary mt-1">Kelola, format, dan ekspor semua referensi Anda dengan mudah.</p>
        </div>
    </header>

    <!-- Kontrol Utama & Daftar Referensi -->
    <div class="apex-card p-6">
        <!-- Panel Kontrol Atas -->
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6 pb-6 border-b border-border-panel">
            <div class="flex items-center gap-4">
                <button id="open-manual-add-btn" class="btn-primary text-sm">+ Tambah Manual</button>
                <button id="upload-doc-btn" class="btn-secondary text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span id="upload-btn-text">Unggah & Analisis</span>
                    <div id="upload-spinner" class="hidden w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                </button>
                <input type="file" id="doc-file-input" class="hidden" accept=".pdf,.doc,.docx">
            </div>
            <div class="flex items-center gap-3">
                <select id="citation-style-select" class="feedback-form-input text-sm !py-2">
                    <option value="apa">Gaya: APA 7</option>
                    <option value="mla">Gaya: MLA 9</option>
                    <option value="chicago">Gaya: Chicago</option>
                </select>
                <button id="export-references-btn" class="btn-secondary text-sm">Ekspor</button>
            </div>
        </div>
        
        <!-- Daftar Referensi (Scrollable) -->
        <div id="references-list" class="space-y-3">
            <!-- Pesan Loading Awal -->
            <div class="text-center text-text-secondary italic py-10"><p>Memuat sitasi Anda...</p></div>
        </div>
    </div>
</div>

<!-- Modal untuk Tambah Referensi Manual -->
<div id="manualAddModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden feedback-modal">
    <div class="w-full max-w-lg feedback-modal-content rounded-lg shadow-lg p-8 transform transition-all opacity-0 -translate-y-4" id="manual-add-modal-card">
        <h3 class="text-2xl font-bold text-text-primary mb-6 text-center">Tambah Referensi Manual</h3>
        <form id="manual-add-form" class="space-y-4">
            <input type="text" name="title" placeholder="Judul Artikel" class="feedback-form-input" required>
            <input type="text" name="author" placeholder="Penulis (e.g., Doe, J.)" class="feedback-form-input" required>
            <input type="number" name="year" placeholder="Tahun" class="feedback-form-input" required>
            <input type="text" name="journal" placeholder="Nama Jurnal/Publikasi" class="feedback-form-input">
            <div class="flex justify-center gap-4 pt-4">
                <button type="button" id="cancel-manual-add-btn" class="btn-secondary">Batal</button>
                <button type="submit" class="btn-primary">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Kontainer Notifikasi -->
<div id="notification-container" class="fixed top-5 right-5 z-50 w-full max-w-xs"></div>


<!-- =============================================================== -->
<!-- SCRIPT JAVASCRIPT & FIREBASE                                    -->
<!-- =============================================================== -->
<script type="module">
    // Import fungsi-fungsi yang dibutuhkan dari Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // =================================================================================
    // PENTING: Ganti konfigurasi ini dengan konfigurasi dari project Firebase Anda!
    // =================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        authDomain: "nama-proyek-anda.firebaseapp.com",
        projectId: "nama-proyek-anda",
        storageBucket: "nama-proyek-anda.appspot.com",
        messagingSenderId: "xxxxxxxxxxxx",
        appId: "1:xxxxxxxxxxxx:web:xxxxxxxxxxxxxxxxxxxxxx"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    document.addEventListener('DOMContentLoaded', () => {
        const citationStyleSelect = document.getElementById('citation-style-select');
        const referencesList = document.getElementById('references-list');
        const openManualAddBtn = document.getElementById('open-manual-add-btn');
        const manualAddModal = document.getElementById('manualAddModal');
        const exportBtn = document.getElementById('export-references-btn');
        const uploadDocBtn = document.getElementById('upload-doc-btn');
        const docFileInput = document.getElementById('doc-file-input');
        const uploadBtnText = document.getElementById('upload-btn-text');
        const uploadSpinner = document.getElementById('upload-spinner');
        const manualForm = document.getElementById('manual-add-form');

        let currentReferences = [];
        let unsubscribe = null;

        const showNotification = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const notif = document.createElement('div');
            notif.className = `px-4 py-3 text-white ${bgColor} rounded-lg shadow-lg mb-2 animate-fade-in-up`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => {
                notif.classList.remove('animate-fade-in-up');
                notif.classList.add('animate-fade-out-down');
                setTimeout(() => notif.remove(), 500);
            }, 4000);
        };

        const formatReference = (ref, style) => {
            const author = ref.author || 'N/A';
            const year = ref.year || 'N/A';
            const title = ref.title || 'N/A';
            const journal = ref.journal ? `<em>${ref.journal}</em>` : '';
            switch(style) {
                case 'mla': return `${author}. "${title}." ${journal}, ${year}.`;
                case 'chicago': return `${author}. ${year}. "${title}." ${journal}.`;
                default: return `${author} (${year}). ${title}. ${journal}`;
            }
        };

        const renderReferences = () => {
            const style = citationStyleSelect.value;
            if (!referencesList) return;

            if (currentReferences.length === 0) {
                referencesList.innerHTML = `<div class="text-center text-text-secondary italic py-10"><p>Belum ada referensi.</p></div>`;
                return;
            }
            referencesList.innerHTML = currentReferences.map(ref => `
                <div class="bg-bg-canvas p-3 rounded-lg flex justify-between items-start group gap-4 border border-border-panel hover:border-border-panel-hover transition-colors">
                    <p class="text-text-secondary text-sm flex-grow">${formatReference(ref, style)}</p>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button data-ref-id="${ref.id}" class="copy-ref-btn opacity-0 group-hover:opacity-100 transition-opacity btn-secondary !text-xs !py-1 !px-2">Salin</button>
                        <button data-ref-id="${ref.id}" class="delete-ref-btn opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:text-red-400 p-1 rounded-full">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>`).join('');
        };

        const handleFileUpload = async (file) => {
            if (!file || !auth.currentUser) return;
            showNotification('Fungsi unggah dokumen belum diimplementasikan di contoh ini.', 'error');
        };

        referencesList.addEventListener('click', async (e) => {
            const copyBtn = e.target.closest('.copy-ref-btn');
            const deleteBtn = e.target.closest('.delete-ref-btn');
            if (copyBtn) {
                const refId = copyBtn.dataset.refId;
                const ref = currentReferences.find(r => r.id === refId);
                if (ref) {
                    try {
                        await navigator.clipboard.writeText(formatReference(ref, citationStyleSelect.value).replace(/<[^>]*>/g, ''));
                        showNotification('Sitasi berhasil disalin!');
                    } catch (err) {
                        showNotification('Gagal menyalin sitasi.', 'error');
                    }
                }
            }
            if (deleteBtn) {
                const refId = deleteBtn.dataset.refId;
                if (window.confirm('Anda yakin ingin menghapus referensi ini?')) {
                    try {
                        await deleteDoc(doc(db, "citations", refId));
                        showNotification('Referensi berhasil dihapus.');
                    } catch (error) {
                        showNotification('Gagal menghapus referensi.', 'error');
                    }
                }
            }
        });

        const closeModal = () => {
            const modalCard = document.getElementById('manual-add-modal-card');
            manualAddModal.classList.remove('animate-fade-in');
            manualAddModal.classList.add('opacity-0');
            modalCard.classList.add('opacity-0', '-translate-y-4');
            setTimeout(() => {
                manualAddModal.classList.add('hidden');
                manualForm.reset();
            }, 300);
        };

        openManualAddBtn.addEventListener('click', () => {
            const modalContent = document.getElementById('manual-add-modal-card');
            manualAddModal.classList.remove('hidden', 'opacity-0');
            manualAddModal.classList.add('animate-fade-in');
            setTimeout(() => {
                modalContent.classList.remove('opacity-0', '-translate-y-4');
            }, 10);
        });
        
        document.getElementById('cancel-manual-add-btn').addEventListener('click', closeModal);
        manualAddModal.addEventListener('click', (e) => {
            if (e.target.id === 'manualAddModal') {
                closeModal();
            }
        });

        manualForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) {
                showNotification('Anda harus login untuk menyimpan referensi.', 'error');
                return;
            }
            const formData = new FormData(e.target);
            const newRef = {
                title: formData.get('title'),
                author: formData.get('author'),
                year: formData.get('year'),
                journal: formData.get('journal'),
                userId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "citations"), newRef);
                showNotification('Referensi berhasil disimpan!');
                closeModal();
            } catch (error) {
                showNotification('Gagal menyimpan referensi.', 'error');
            }
        });
        
        citationStyleSelect.addEventListener('change', renderReferences);
        uploadDocBtn.addEventListener('click', () => docFileInput.click());
        docFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        // --- SINKRONISASI REAL-TIME DENGAN FIRESTORE ---
        onAuthStateChanged(auth, user => {
            if (unsubscribe) unsubscribe();

            if (user) {
                const citationsRef = collection(db, "citations");
                const q = query(citationsRef, where("userId", "==", user.uid), orderBy("createdAt", "desc"));
                
                unsubscribe = onSnapshot(q, (snapshot) => {
                    currentReferences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderReferences();
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    showNotification("Gagal memuat data. Periksa koneksi atau izin database Anda.", "error");
                });

            } else {
                currentReferences = [];
                renderReferences();
            }
        });
    });
</script>

</body>
</html>
