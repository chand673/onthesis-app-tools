{% extends "layout.html" %}

{% block title %}Uji Normalitas - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Grafik & Tabel -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Pustaka untuk membaca file CSV & Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Pustaka untuk Export Profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    /* Gaya Umum & Tema */
    .highlight { color: var(--accent-cyan); font-weight: 600; }
    .input-error { border-color: #ef4444 !important; }
    
    /* Gaya Tabel SPSS */
    .spss-table { width: 100%; border-collapse: collapse; }
    .spss-table thead .spss-title-row th {
        background-color: transparent !important;
        color: var(--text-primary) !important;
        font-size: 1.1em;
        font-weight: bold;
        padding: 8px 0;
        text-align: left;
        border-bottom: 2px solid var(--text-primary) !important;
    }
    .spss-table thead .spss-header-row th {
        color: var(--text-primary) !important;
        font-weight: bold;
        padding: 8px;
        border-bottom: 1px solid var(--border-panel) !important;
    }
    .spss-table tbody td {
        padding: 8px;
        color: var(--text-secondary) !important;
        border-bottom: 1px solid var(--border-panel);
    }
    /* Styling untuk checkbox */
    .form-checkbox {
        appearance: none;
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        padding: 0;
        display: inline-block;
        vertical-align: middle;
        width: 1.25em;
        height: 1.25em;
        border-radius: 0.25rem;
        cursor: pointer;
    }
    .form-checkbox:checked {
        background-color: var(--accent-cyan);
        border-color: var(--accent-cyan);
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        background-size: 100% 100%;
        background-position: center;
        background-repeat: no-repeat;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Uji Normalitas Data</h1>
        <p class="text-lg text-text-secondary mt-1">Analisis data Anda untuk memeriksa asumsi normalitas.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Kartu Input Data -->
        <div class="apex-card p-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Anda</h3>
            
            <!-- Area Input File yang Diperbarui -->
            <div class="max-w-lg mx-auto text-left">
                <label for="file-input" class="btn-secondary w-full flex items-center justify-center gap-2 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Pilih File CSV atau Excel</span>
                </label>
                <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls">
                <p id="file-name-display" class="text-sm text-center text-text-secondary mt-2"></p>
                
                <div id="variable-selector-container" class="mt-4" style="display: none;">
                    <label for="variable-selector" class="block text-sm font-medium text-text-secondary">Pilih Variabel untuk Dianalisis:</label>
                    <select id="variable-selector" class="feedback-form-input mt-1"></select>
                </div>
            </div>

            <!-- Pilihan Visualisasi -->
            <div class="mt-6 pt-6 border-t border-border-panel text-left">
                <h4 class="text-lg font-bold text-text-primary mb-4 text-center">Pilih Visualisasi</h4>
                <div class="max-w-lg mx-auto grid grid-cols-1 sm:grid-cols-3 gap-4 text-text-secondary">
                    <label class="flex items-center justify-center sm:justify-start space-x-2 cursor-pointer p-2 rounded-lg hover:bg-bg-canvas">
                        <input type="checkbox" id="check-hist" class="form-checkbox" checked>
                        <span>Histogram & Kurva</span>
                    </label>
                    <label class="flex items-center justify-center sm:justify-start space-x-2 cursor-pointer p-2 rounded-lg hover:bg-bg-canvas">
                        <input type="checkbox" id="check-qq" class="form-checkbox" checked>
                        <span>Q-Q Plot</span>
                    </label>
                    <label class="flex items-center justify-center sm:justify-start space-x-2 cursor-pointer p-2 rounded-lg hover:bg-bg-canvas">
                        <input type="checkbox" id="check-box" class="form-checkbox" checked>
                        <span>Box Plot</span>
                    </label>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                <button id="btnBackend" class="btn-primary w-full md:w-1/2">Jalankan Analisis</button>
            </div>
        </div>

        <!-- Kontainer Output -->
        <div id="output" class="space-y-8" style="display:none;">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
                <div class="flex gap-2">
                    <button id="export-pdf-btn" class="btn-secondary text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span class="btn-text">Export PDF</span>
                    </button>
                    <button id="export-doc-btn" class="btn-secondary text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4.5V20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4.5M16 4.5h-4a2 2 0 0 0-2 2v0a2 2 0 0 0 2 2h4M16 4.5V2M8 13h8M8 17h8"></path></svg>
                        <span class="btn-text">Export DOC</span>
                    </button>
                    <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>

            <div id="results-container" class="space-y-12">
                <!-- Hasil akan ditampilkan di sini -->
            </div>
        </div>
        <!-- Elemen tersembunyi untuk ekspor DOC -->
        <div id="exportContent" class="hidden"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function(){
    let analysisResult = null;
    let fileData = [];

    $('#file-input').on('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        $('#file-name-display').text(`File terpilih: ${file.name}`);
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = e.target.result;
            try {
                if (file.name.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => { 
                            fileData = results.data; 
                            populateVariableSelector();
                        }
                    });
                    return;
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    fileData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                } else {
                    alert("Format file tidak didukung. Harap unggah file CSV atau Excel.");
                    return;
                }
                populateVariableSelector();
            } catch (error) {
                alert("Gagal memproses file. Pastikan formatnya benar.");
                console.error(error);
            }
        };
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsText(file);
        }
    });

    function populateVariableSelector() {
        const selector = $('#variable-selector');
        selector.empty();
        if (fileData.length > 0) {
            const headers = Object.keys(fileData[0]);
            headers.forEach(header => {
                if (fileData.some(row => typeof row[header] === 'number')) {
                    selector.append(`<option value="${header}">${header}</option>`);
                }
            });
            $('#variable-selector-container').show();
        }
    }

    function getSelectedData() {
        const selectedVar = $('#variable-selector').val();
        if (!selectedVar || fileData.length === 0) return [];
        return fileData.map(row => row[selectedVar]).filter(val => typeof val === 'number');
    }

    const getPlotlyLayout = (title, forExport = false) => {
        const isLight = document.documentElement.classList.contains('light');
        const titleColor = forExport ? '#000000' : (isLight ? '#181C32' : '#E6EDF3');
        const textColor = forExport ? '#000000' : (isLight ? '#5E6278' : '#8B949E');
        const gridColor = forExport ? '#cccccc' : (isLight ? '#DEE2E6' : '#30363D');

        return {
            title: { text: title, font: { color: titleColor } },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: textColor },
            xaxis: { gridcolor: gridColor, zerolinecolor: gridColor },
            yaxis: { gridcolor: gridColor, zerolinecolor: gridColor },
            showlegend: false
        };
    };

    const generateNormalCurve = (mean, stdDev, data) => {
        const min = Math.min(...data);
        const max = Math.max(...data);
        const x = [];
        const y = [];
        for (let i = min; i <= max; i += (max - min) / 100) {
            x.push(i);
            const exponent = -Math.pow(i - mean, 2) / (2 * Math.pow(stdDev, 2));
            y.push((1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(exponent));
        }
        return { x, y };
    };

    $('#btnBackend').on('click', async function() {
        const data = getSelectedData();
        if (data.length < 3) {
            alert('Data tidak cukup untuk analisis. Pastikan Anda telah memilih file dan variabel yang valid dengan minimal 3 data numerik.');
            return;
        }

        const button = $(this);
        button.prop('disabled', true).text('Menganalisis...');
        
        try {
            const response = await fetch("{{ url_for('api_normality') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: data }),
            });
            analysisResult = await response.json();
            if (!response.ok) throw new Error(analysisResult.error);
            
            displayResults(data);
        } catch (error) {
            alert(`Terjadi kesalahan: ${error.message}`);
        } finally {
            button.prop('disabled', false).text('Jalankan Analisis');
        }
    });

    function displayResults(data) {
        $('#output').show();
        const container = $('#results-container');
        container.empty();

        let resultHtml = `
            <div class="apex-card p-6">
                <p class="text-text-secondary mb-4 p-4 bg-bg-canvas rounded-lg border border-border-panel">${analysisResult.summary}</p>
                <table class="display spss-table" style="width:100%">
                    <thead>
                        <tr class="spss-title-row"><th colspan="4">Tests of Normality</th></tr>
                        <tr class="spss-header-row">
                            <th></th>
                            <th>Statistic</th>
                            <th>df</th>
                            <th>Sig.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisResult.table.map(row => `
                            <tr>
                                <td><strong>${row.test}</strong></td>
                                <td>${row.statistic.toFixed(3)}</td>
                                <td>${row.df}</td>
                                <td class="${row.p < 0.05 ? 'highlight' : ''}">${row.p.toFixed(3)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="mt-6 border-t border-border-panel pt-6">
                    <h4 class="text-lg font-bold text-text-primary mb-4">Visualisasi Data</h4>
                    <div class="grid grid-cols-1 gap-8">
                        <div id="hist-container" style="display: none;">
                            <div id="hist-plot" class="w-full h-96"></div>
                            <p class="text-xs text-text-secondary mt-2 text-center">Histogram menunjukkan distribusi frekuensi data.</p>
                        </div>
                        <div id="qq-container" style="display: none;">
                            <div id="qq-plot" class="w-full h-96"></div>
                            <p class="text-xs text-text-secondary mt-2 text-center">Q-Q Plot membandingkan data dengan distribusi normal ideal.</p>
                        </div>
                        <div id="box-container" style="display: none;">
                            <div id="box-plot" class="w-full h-96"></div>
                            <p class="text-xs text-text-secondary mt-2 text-center">Box Plot menunjukkan ringkasan statistik dan pencilan.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.html(resultHtml);

        if ($('#check-hist').is(':checked')) {
            $('#hist-container').show();
            const normalCurve = generateNormalCurve(analysisResult.mean, analysisResult.std_dev, data);
            const histTrace = { x: data, type: 'histogram', histnorm: 'probability density', name: 'Histogram', marker: { color: '#0ea5e9' } };
            const curveTrace = { x: normalCurve.x, y: normalCurve.y, type: 'scatter', mode: 'lines', name: 'Kurva Normal', line: { color: '#ef4444' } };
            Plotly.newPlot('hist-plot', [histTrace, curveTrace], getPlotlyLayout('Histogram dan Kurva Normal'));
        }
        if ($('#check-qq').is(':checked')) {
            $('#qq-container').show();
            let sorted = [...data].sort((a,b)=>a-b);
            let quantiles = sorted.map((_,i) => (i+0.5)/analysisResult.n);
            let theoretical = quantiles.map(q => analysisResult.mean + analysisResult.std_dev * Math.sqrt(2) * erfinv(2*q-1));
            Plotly.newPlot('qq-plot', [
                {x: theoretical, y: sorted, mode:'markers', name:'Data', marker: { color: '#0ea5e9' }},
                {x: theoretical, y: theoretical, mode:'lines', name:'Garis Normal', line: { color: '#10b981' }}
            ], getPlotlyLayout('Q-Q Plot'));
        }
        if ($('#check-box').is(':checked')) {
            $('#box-container').show();
            Plotly.newPlot('box-plot', [{ y: data, type: 'box', name: 'Data', marker: { color: '#f97316' }}], getPlotlyLayout('Box Plot'));
        }
    }

    const loadImageAsBase64 = (url) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = reject;
            img.src = url;
        });
    };

    const exportHandler = async (format) => {
        const btn = $(`#export-${format}-btn`);
        const spinner = btn.siblings('.spinner').first();
        btn.prop('disabled', true);
        spinner.removeClass('hidden');

        if (format === 'doc') {
            try {
                const checkResponse = await fetch("{{ url_for('check_pro_trial_usage') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feature: 'export_doc' })
                });
                const checkData = await checkResponse.json();
                if (!checkData.allowed) {
                    alert(checkData.message);
                    btn.prop('disabled', false);
                    spinner.addClass('hidden');
                    return;
                }
            } catch (e) {
                alert("Gagal memverifikasi status langganan.");
                btn.prop('disabled', false);
                spinner.addClass('hidden');
                return;
            }
        }

        try {
            const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-black.png') }}";
            const logoData = await loadImageAsBase64(logoUrl);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                let yPos = 15;

                const addHeader = (docInstance) => {
                    const pageWidth = docInstance.internal.pageSize.width;
                    docInstance.addImage(logoData, 'PNG', pageWidth - 15 - 30, 10, 30, 8);
                };

                addHeader(doc);
                doc.setFontSize(18);
                doc.text("Laporan Uji Normalitas - OnThesis", 105, 25, { align: 'center' });
                yPos = 40;

                doc.setFontSize(12);
                const splitSummary = doc.splitTextToSize(analysisResult.summary, 180);
                doc.text(splitSummary, 15, yPos);
                yPos += (splitSummary.length * 5) + 8;

                doc.autoTable({
                    startY: yPos,
                    head: [
                        [{ content: 'Tests of Normality', colSpan: 4, styles: { halign: 'left', fontStyle: 'bold', fillColor: [255, 255, 255], textColor: [0,0,0], lineColor: [0,0,0], lineWidth: {top: 0.2, bottom: 0.2} } }],
                        ['', 'Statistic', 'df', 'Sig.']
                    ],
                    body: analysisResult.table.map(row => [{ content: row.test, styles: { fontStyle: 'bold' } }, row.statistic.toFixed(3), row.df, row.p.toFixed(3)]),
                    theme: 'grid',
                    headStyles: { fillColor: [2, 132, 199], textColor: [255, 255, 255] }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                let plotPromises = [];
                if ($('#check-hist').is(':checked')) plotPromises.push({id: 'hist-plot', title: "Histogram & Kurva Normal"});
                if ($('#check-qq').is(':checked')) plotPromises.push({id: 'qq-plot', title: "Q-Q Plot"});
                if ($('#check-box').is(':checked')) plotPromises.push({id: 'box-plot', title: "Box Plot"});
                
                if(plotPromises.length > 0) {
                    if (yPos > 150) { doc.addPage(); addHeader(doc); yPos = 25; }
                    doc.setFontSize(12);
                    doc.text("Visualisasi Data", 15, yPos);
                    yPos += 8;
                    
                    const images = await Promise.all(plotPromises.map(p => Plotly.toImage(p.id, {format: 'png', width: 800, height: 500})));
                    images.forEach((imgData, i) => {
                        if (yPos > 210) { doc.addPage(); addHeader(doc); yPos = 25; }
                        doc.setFontSize(10);
                        doc.text(plotPromises[i].title, 15, yPos);
                        yPos += 5;
                        doc.addImage(imgData, 'PNG', 15, yPos, 180, 112.5);
                        yPos += 120;
                    });
                }
                doc.save('hasil-uji-normalitas-onthesis.pdf');

            } else if (format === 'doc') {
                let content = `
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; }
                        h1, h2, h3, h4 { font-family: 'Times New Roman', Times, serif; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: left; vertical-align: top; }
                        th { font-weight: bold; }
                        .spss-title-cell { text-align: left; font-weight: bold; border: 1px solid #000; }
                    </style>
                    <h1>Laporan Uji Normalitas - OnThesis</h1>
                `;
                content += `<p>${analysisResult.summary}</p>`;
                
                let tableHtml = `
                    <h4>Tabel 1</h4>
                    <table>
                        <thead>
                            <tr><th class="spss-title-cell" colspan="4">Tests of Normality</th></tr>
                            <tr>
                                <th></th>
                                <th>Statistic</th>
                                <th>df</th>
                                <th>Sig.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisResult.table.map(row => `
                                <tr>
                                    <td style="font-weight: bold;">${row.test}</td>
                                    <td>${row.statistic.toFixed(3)}</td>
                                    <td>${row.df}</td>
                                    <td>${row.p.toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                content += tableHtml;
                
                content += `<h3>Visualisasi Data</h3>`;
                let plotPromises = [];
                if ($('#check-hist').is(':checked')) plotPromises.push({id: 'hist-plot', title: "Histogram & Kurva Normal"});
                if ($('#check-qq').is(':checked')) plotPromises.push({id: 'qq-plot', title: "Q-Q Plot"});
                if ($('#check-box').is(':checked')) plotPromises.push({id: 'box-plot', title: "Box Plot"});
                
                const images = await Promise.all(plotPromises.map(p => Plotly.toImage(p.id, {format: 'png', width: 800, height: 500})));
                images.forEach((imgData, i) => {
                    content += `<h4>${plotPromises[i].title}</h4>`;
                    content += `<p><img src="${imgData}" style="width:500px; height:auto;" /></p>`;
                });
                var converted = htmlDocx.asBlob(content);
                saveAs(converted, 'hasil-uji-normalitas-onthesis.doc');
            }
        } catch (e) {
            console.error("Gagal mengekspor:", e);
            alert("Terjadi kesalahan saat mengekspor file.");
        } finally {
            btn.prop('disabled', false);
            spinner.addClass('hidden');
        }
    };

    $('#export-pdf-btn').on('click', () => exportHandler('pdf'));
    $('#export-doc-btn').on('click', () => exportHandler('doc'));

    function erfinv(x){
        let a = 0.147;
        let ln = Math.log(1 - x*x);
        let part1 = 2/(Math.PI*a) + ln/2;
        let part2 = ln/a;
        return ( (x<0?-1:1) * Math.sqrt( Math.sqrt(part1*part1 - part2) - part1 ) );
    }
});
</script>
{% endblock %}
