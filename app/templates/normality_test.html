{% extends "layout.html" %}

{% block title %}Uji Normalitas - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Grafik & Tabel -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- Pustaka untuk membaca file CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<!-- Pustaka untuk Export PDF Profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>


<style>
    /* Penyesuaian Gaya DataTable agar sesuai Tema */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        color: var(--text-secondary) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: var(--text-secondary) !important;
        border-color: var(--border-panel) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        background: var(--accent-cyan) !important;
        color: var(--bg-panel) !important;
        border-color: var(--accent-cyan) !important;
    }
     html.light .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        color: white !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: var(--bg-canvas) !important;
        border-color: var(--border-panel) !important;
    }
    table.dataTable.no-footer {
        border-bottom-color: var(--border-panel) !important;
    }
    table.dataTable thead th {
        border-bottom: 1px solid var(--border-panel) !important;
    }
    table.dataTable tbody tr {
        background-color: transparent !important;
    }
    table.dataTable tbody tr:hover {
        background-color: var(--bg-canvas) !important;
    }
    table.dataTable tbody td {
        color: var(--text-secondary) !important;
    }
    /* Gaya Tabel SPSS */
    table.spss-table thead .spss-title-row th {
        background-color: transparent !important;
        color: var(--text-primary) !important;
        font-size: 1.1em;
        font-weight: bold;
        padding-left: 0;
        border-bottom: 2px solid var(--text-primary) !important;
    }
    table.spss-table thead .spss-header-row th {
        color: var(--text-primary) !important;
        font-weight: bold;
    }
    .highlight {
        color: var(--accent-cyan);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Uji Normalitas Data</h1>
        <p class="text-lg text-text-secondary mt-1">Analisis satu atau beberapa variabel data sekaligus.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Kartu Input Data -->
        <div class="apex-card p-6 text-center">
            <h3 class="text-xl font-bold text-text-primary mb-4">1. Input Data Anda</h3>
            <p class="text-sm text-text-secondary mb-4 max-w-2xl mx-auto">Anda bisa menambahkan beberapa variabel untuk diuji secara bersamaan. Masukkan data secara manual atau unggah file CSV.</p>
            
            <div id="data-groups-container" class="space-y-4 text-left">
                <!-- Grup data akan ditambahkan di sini oleh JavaScript -->
            </div>

            <div class="flex flex-wrap gap-4 mt-4 pt-4 border-t border-border-panel">
                <button id="add-group-btn" class="btn-secondary flex-1">+ Tambah Variabel</button>
                <button id="upload-csv-btn" class="btn-secondary flex-1">Unggah CSV</button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
            </div>
            <div class="mt-6">
                <button id="btnBackend" class="btn-primary w-full md:w-1/2 mx-auto">Jalankan Analisis</button>
            </div>
        </div>

        <!-- Kontainer Output -->
        <div id="output" class="space-y-8" style="display:none;">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
                <button id="export-pdf-btn" class="btn-secondary text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span class="btn-text">Export PDF</span>
                    <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>

            <div id="results-container" class="space-y-12">
                <!-- Hasil untuk setiap variabel akan ditampilkan di sini -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function(){
    let analysisResults = [];

    const addDataGroup = (name = '', data = '') => {
        const groupCount = $('#data-groups-container').children().length + 1;
        const groupName = name || `Variabel ${groupCount}`;
        const groupHtml = `
            <div class="data-group p-4 border border-border-panel rounded-lg bg-bg-canvas">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="bg-transparent font-semibold text-text-primary focus:outline-none w-full group-name-input" value="${groupName}" placeholder="Nama Variabel">
                    <button class="text-text-secondary hover:text-red-400 remove-group-btn text-xl font-bold">&times;</button>
                </div>
                <textarea class="feedback-form-input h-24 data-input" placeholder="Masukkan data...">${data}</textarea>
            </div>
        `;
        $('#data-groups-container').append(groupHtml);
    };

    addDataGroup();

    $('#add-group-btn').on('click', () => addDataGroup());
    $('#data-groups-container').on('click', '.remove-group-btn', function() { $(this).closest('.data-group').remove(); });
    $('#upload-csv-btn').on('click', () => $('#csv-file-input').click());

    $('#csv-file-input').on('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    $('#data-groups-container').empty();
                    results.meta.fields.forEach(header => {
                        const values = results.data.map(row => row[header]).join('\\n');
                        addDataGroup(header, values);
                    });
                }
            });
        }
    });

    $('#btnBackend').on('click', async function() {
        const groupsData = [];
        $('.data-group').each(function() {
            const name = $(this).find('.group-name-input').val();
            const rawData = $(this).find('textarea').val();
            const values = rawData.split(/[ ,\n\t]+/).map(Number).filter(x => !isNaN(x));
            if (values.length > 0) {
                groupsData.push({ name, values });
            }
        });

        if (groupsData.length === 0) {
            alert('Masukkan data setidaknya pada satu variabel.');
            return;
        }

        const button = $(this);
        button.prop('disabled', true).text('Menganalisis...');
        $('#results-container').empty();
        analysisResults = [];

        for (const group of groupsData) {
            try {
                const response = await fetch("{{ url_for('api_normality') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: group.values }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                analysisResults.push({ name: group.name, ...result });
            } catch (error) {
                analysisResults.push({ name: group.name, error: error.message });
            }
        }
        
        displayResults();
        button.prop('disabled', false).text('Jalankan Analisis');
    });

    function displayResults() {
        $('#output').show();
        analysisResults.forEach((res, index) => {
            const resultId = `result-${index}`;
            let resultHtml = `<div class="apex-card p-6" id="${resultId}"><h3 class="text-xl font-bold text-text-primary mb-2">${res.name}</h3>`;

            if (res.error) {
                resultHtml += `<p class="text-red-500">${res.error}</p>`;
            } else {
                resultHtml += `
                    <p class="text-text-secondary mb-4 p-4 bg-bg-canvas rounded-lg border border-border-panel">${res.summary}</p>
                    <table class="display spss-table" style="width:100%">
                        <thead>
                            <tr class="spss-title-row"><th colspan="4">Tests of Normality</th></tr>
                            <tr class="spss-header-row">
                                <th></th>
                                <th>Statistic</th>
                                <th>df</th>
                                <th>Sig.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${res.table.map(row => `
                                <tr>
                                    <td><strong>${row.test}</strong></td>
                                    <td>${row.statistic.toFixed(3)}</td>
                                    <td>${row.df}</td>
                                    <td class="${row.p < 0.05 ? 'highlight' : ''}">${row.p.toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            resultHtml += '</div>';
            $('#results-container').append(resultHtml);
        });
    }

    $('#export-pdf-btn').on('click', async function() {
        const btn = $(this);
        btn.prop('disabled', true).find('.spinner').removeClass('hidden');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            let yPos = 15;

            doc.setFontSize(18);
            doc.text("Laporan Uji Normalitas - OnThesis", 105, yPos, { align: 'center' });
            yPos += 15;

            for (const res of analysisResults) {
                if (res.error) continue;

                if (yPos > 250) { doc.addPage(); yPos = 15; }

                doc.setFontSize(14);
                doc.text(`Hasil untuk Variabel: ${res.name}`, 15, yPos);
                yPos += 8;

                doc.setFontSize(10);
                const splitSummary = doc.splitTextToSize(res.summary, 180);
                doc.text(splitSummary, 15, yPos);
                yPos += (splitSummary.length * 4) + 8;

                doc.autoTable({
                    startY: yPos,
                    head: [
                        [{ content: 'Tests of Normality', colSpan: 4, styles: { halign: 'left', fontStyle: 'bold', fillColor: [255, 255, 255], textColor: [0,0,0], lineColor: [0,0,0], lineWidth: {top: 0.2, bottom: 0.2} } }],
                        ['', 'Statistic', 'df', 'Sig.']
                    ],
                    body: res.table.map(row => [
                        { content: row.test, styles: { fontStyle: 'bold' } },
                        row.statistic.toFixed(3),
                        row.df,
                        row.p.toFixed(3)
                    ]),
                    theme: 'grid',
                    headStyles: { fillColor: [2, 132, 199], textColor: [255, 255, 255] }
                });
                yPos = doc.autoTable.previous.finalY + 15;
            }

            doc.save('hasil-uji-normalitas-onthesis.pdf');
        } catch (e) {
            console.error("Gagal membuat PDF:", e);
            alert("Terjadi kesalahan saat mengekspor PDF.");
        } finally {
            btn.prop('disabled', false).find('.spinner').addClass('hidden');
        }
    });
});
</script>
{% endblock %}
