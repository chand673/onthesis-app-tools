{% extends "layout.html" %}

{% block title %}Uji ANOVA Profesional - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Tabel & Baca File Excel -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Pustaka untuk Ekspor Profesional (PDF & DOCX) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    /* Gaya untuk file upload modern */
    .file-drop-area { position: relative; display: flex; align-items: center; justify-content: center; width: 100%; padding: 2rem; border: 2px dashed var(--border-panel); border-radius: 0.75rem; transition: all 0.2s ease-in-out; background-color: var(--bg-canvas); }
    .file-drop-area.is-active { border-color: var(--accent-cyan); background-color: var(--accent-cyan-glow); }
    .file-input { position: absolute; left: 0; top: 0; height: 100%; width: 100%; cursor: pointer; opacity: 0; }
    /* Gaya untuk badge status */
    .badge { display: inline-flex; align-items: center; padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 600; border-radius: 9999px; }
    .badge-success { background-color: rgba(34, 211, 238, 0.1); color: var(--accent-cyan); }
    .badge-warning { background-color: rgba(251, 191, 36, 0.1); color: #FBBF24; }
    /* Gaya untuk highlight tabel */
    .highlight td { background-color: var(--accent-cyan-glow) !important; font-weight: 600; color: var(--text-primary) !important; }
    /* Penyesuaian DataTable dengan tema */
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate .paginate_button { color: var(--text-secondary) !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current, .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--accent-cyan) !important; color: var(--bg-panel) !important; border-color: var(--accent-cyan) !important; }
    html.light .dataTables_wrapper .dataTables_paginate .paginate_button.current { color: white !important; }
    table.dataTable thead th, table.dataTable.no-footer { border-bottom: 1px solid var(--border-panel); }
    table.dataTable tbody tr, table.dataTable tbody td { background-color: transparent; color: var(--text-secondary); }
    /* Tombol switcher metode input */
    .input-method-btn.active { background-color: var(--accent-cyan); color: var(--bg-panel); font-weight: 600; }
    html.light .input-method-btn.active { color: white; }
    /* GAYA BARU: Notifikasi Modern */
    #notification { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
    #notification-content { background-color: var(--bg-panel); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 450px; text-align: center; border: 1px solid var(--border-panel); box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideUp 0.4s ease; }
    #notification-title { font-size: 1.5rem; font-weight: bold; color: var(--text-primary); margin-bottom: 1rem; }
    #notification-message { color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    /* GAYA BARU: Tabel Input Manual Two-Way */
    #manual-twoway-table { width: 100%; border-collapse: collapse; }
    #manual-twoway-table th, #manual-twoway-table td { padding: 0.75rem; border: 1px solid var(--border-panel); text-align: left; }
    #manual-twoway-table th { background-color: var(--bg-canvas); }
    #manual-twoway-table input { width: 100%; background: transparent; border: none; color: var(--text-primary); padding: 0.25rem; }
    #manual-twoway-table input:focus { outline: 1px solid var(--accent-cyan); border-radius: 3px; }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">ANOVA (Analysis of Variance)</h1>
        <p class="text-lg text-text-secondary mt-1">Bandingkan rata-rata dari dua atau lebih kelompok secara profesional.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        <div class="apex-card p-6">
            <form id="anova-form" class="space-y-6">
                <!-- Pilihan Metode Input -->
                <div>
                    <h3 class="text-xl font-bold text-text-primary mb-4">Input Data</h3>
                    <div class="flex gap-1 border border-border-panel p-1 rounded-lg bg-bg-canvas">
                        <button type="button" class="input-method-btn active btn-secondary flex-1 border-0" data-method="upload">Unggah File</button>
                        <button type="button" class="input-method-btn btn-secondary flex-1 border-0" data-method="manual">Input Manual</button>
                    </div>
                </div>

                <!-- Kontainer Unggah File -->
                <div id="upload-container">
                    <div class="file-drop-area">
                        <div class="text-center text-text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-accent-cyan opacity-50"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <p class="mb-2">Seret & letakkan file di sini, atau</p>
                            <button type="button" class="btn-secondary text-sm" onclick="$('#file-upload').click();">Pilih File</button>
                            <p id="file-name" class="mt-2 text-sm"></p>
                        </div>
                        <input type="file" id="file-upload" name="file" class="file-input" accept=".csv, .xlsx, .xls">
                    </div>
                </div>

                <!-- Kontainer Input Manual -->
                <div id="manual-input-container" style="display: none;">
                    <!-- Input One-Way -->
                    <div id="manual-oneway-container">
                        <p class="text-sm text-text-secondary mb-4">Masukkan data untuk setiap kelompok. Pisahkan setiap angka dengan koma, spasi, atau baris baru.</p>
                        <div id="groups-container" class="space-y-4"></div>
                        <div class="flex gap-4 mt-4 pt-4 border-t border-border-panel">
                            <button type="button" id="add-group" class="btn-secondary text-sm flex-grow">+ Tambah Grup</button>
                            <button type="button" id="remove-group" class="btn-secondary text-sm flex-grow">- Hapus Grup</button>
                        </div>
                    </div>
                    <!-- Input Two-Way -->
                    <div id="manual-twoway-container" style="display: none;">
                        <p class="text-sm text-text-secondary mb-4">Masukkan setiap baris data beserta kategori grupnya.</p>
                        <table id="manual-twoway-table">
                            <thead>
                                <tr>
                                    <th><input type="text" class="font-bold" id="manual-col-dependent" value="Nilai"></th>
                                    <th><input type="text" class="font-bold" id="manual-col-independent1" value="Metode"></th>
                                    <th><input type="text" class="font-bold" id="manual-col-independent2" value="Gender"></th>
                                </tr>
                            </thead>
                            <tbody id="manual-twoway-tbody"></tbody>
                        </table>
                        <div class="flex gap-4 mt-4 pt-4 border-t border-border-panel">
                            <button type="button" id="add-row" class="btn-secondary text-sm flex-grow">+ Tambah Baris</button>
                            <button type="button" id="remove-row" class="btn-secondary text-sm flex-grow">- Hapus Baris</button>
                        </div>
                    </div>
                    <div class="mt-4"><button type="button" id="load-sample" class="btn-secondary text-sm w-full">Muat Contoh Data</button></div>
                </div>
                
                <!-- Pengaturan Analisis -->
                <div class="space-y-6 pt-6 border-t border-border-panel">
                    <h3 class="text-xl font-bold text-text-primary">Pengaturan Analisis</h3>
                    <div>
                        <label for="anova-type" class="block text-sm font-medium text-text-secondary mb-1">Jenis ANOVA</label>
                        <select id="anova-type" name="anova_type" class="feedback-form-input">
                            <option value="one_way">One-Way ANOVA</option>
                            <option value="two_way">Two-Way ANOVA</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="dependent-var" class="block text-sm font-medium text-text-secondary mb-1">Variabel Dependen</label>
                            <select id="dependent-var" name="dependent" class="feedback-form-input" required disabled>
                                <option>Sediakan data terlebih dahulu</option>
                            </select>
                            <p class="mt-1 text-xs text-text-secondary">Variabel numerik yang diuji.</p>
                        </div>
                        <div>
                            <label for="independent-var-1" class="block text-sm font-medium text-text-secondary mb-1">Variabel Grup 1 (Independen)</label>
                            <select id="independent-var-1" name="independent1" class="feedback-form-input" required disabled>
                                <option>Sediakan data terlebih dahulu</option>
                            </select>
                            <p class="mt-1 text-xs text-text-secondary">Variabel kategori pembeda grup.</p>
                        </div>
                    </div>
                    <div id="independent-var-2-container" style="display: none;">
                        <label for="independent-var-2" class="block text-sm font-medium text-text-secondary mb-1">Variabel Grup 2 (Independen)</label>
                        <select id="independent-var-2" name="independent2" class="feedback-form-input" disabled>
                            <option>Sediakan data terlebih dahulu</option>
                        </select>
                        <p class="mt-1 text-xs text-text-secondary">Variabel kategori pembeda kedua.</p>
                    </div>
                </div>

                <div>
                    <button type="submit" id="run-analysis" class="btn-primary w-full" disabled>
                        <span class="btn-text">Jalankan Analisis</span>
                        <div class="spinner hidden ml-2 w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Kontainer Hasil -->
        <div id="results-container" class="space-y-8" style="display: none;">
            <div class="apex-card p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
                    <div class="flex gap-2">
                        <button id="export-pdf-btn" class="btn-secondary text-sm">Export PDF</button>
                        <button id="export-doc-btn" class="btn-secondary text-sm">Export DOC</button>
                    </div>
                </div>
                <div id="export-content" class="prose max-w-none prose-sm text-text-secondary space-y-8">
                    <div>
                        <h3 class="text-xl font-bold text-text-primary border-b border-border-panel pb-2 mb-4">Ringkasan & Interpretasi</h3>
                        <div id="summary-content">
                            <h4 class="font-bold text-lg text-text-primary">Uji Prasyarat</h4>
                            <div class="flex flex-wrap gap-4 mb-4">
                                <div id="normality-badge"></div>
                                <div id="homogeneity-badge"></div>
                            </div>
                            <p id="prerequisite-summary" class="text-sm"></p>
                            <h4 class="font-bold text-lg text-text-primary mt-6">Jenis Analisis yang Digunakan</h4>
                            <p id="analysis-type" class="text-accent-cyan font-semibold"></p>
                            <h4 class="font-bold text-lg text-text-primary mt-6">Interpretasi Hasil</h4>
                            <div class="p-4 bg-bg-canvas rounded-md border border-border-panel">
                                <p id="summary-indonesia" class="text-text-primary"></p>
                                <button id="copy-summary" class="mt-3 text-xs font-semibold text-accent-cyan hover:underline">Salin ke Laporan</button>
                            </div>
                            <h4 class="font-semibold text-md text-text-primary mt-4">Format Laporan (APA Style)</h4>
                            <div class="p-3 bg-bg-canvas rounded-md border border-border-panel text-sm">
                                <p id="summary-apa" class="font-mono"></p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-primary border-b border-border-panel pb-2 mb-4">Tabel Statistik</h3>
                        <div id="stats-content" class="space-y-8">
                            <h4 class="font-bold text-lg text-text-primary">Statistik Deskriptif</h4>
                            <div class="overflow-x-auto"><table id="desc-table" class="display" style="width:100%"></table></div>
                            <h4 class="font-bold text-lg text-text-primary mt-8">Hasil Uji Utama (<span id="main-test-title"></span>)</h4>
                            <div class="overflow-x-auto"><table id="main-test-table" class="display" style="width:100%"></table></div>
                            <div id="posthoc-container" style="display: none;">
                                <h4 class="font-bold text-lg text-text-primary">Hasil Uji Post-Hoc (<span id="posthoc-title"></span>)</h4>
                                <p class="text-sm">Tabel perbandingan antar pasangan grup. Nilai p-value < 0.05 menunjukkan perbedaan yang signifikan.</p>
                                <div class="overflow-x-auto"><table id="posthoc-table" class="display" style="width:100%"></table></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-text-primary border-b border-border-panel pb-2 mb-4">Visualisasi</h3>
                        <div id="plot-content">
                            <div id="plot-output" class="w-full h-auto min-h-[400px] bg-bg-canvas rounded-md flex items-center justify-center border border-border-panel p-2">
                                <img id="result-plot" src="" alt="Hasil Plot Analisis" class="max-w-full max-h-full object-contain">
                            </div>
                            <button id="download-plot" class="mt-4 btn-secondary text-sm">Download Grafik (PNG)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notifikasi Modern -->
<div id="notification">
    <div id="notification-content">
        <h2 id="notification-title">Error</h2>
        <p id="notification-message">Pesan error akan muncul di sini.</p>
        <button id="notification-close" class="btn-primary mt-4">OK</button>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    let columnHeaders = [];
    let analysisData = null;

    // --- FUNGSI-FUNGSI HELPER UI ---
    function createOneWayGroup(name = '', data = '') {
        const groupCount = $('#groups-container').children().length + 1;
        const groupName = name || `Kelompok ${groupCount}`;
        $('#groups-container').append(`
            <div class="data-group bg-bg-canvas border border-border-panel p-3 rounded-lg">
                <input type="text" class="group-name-input w-full bg-transparent border-0 border-b-2 border-border-panel focus:ring-0 focus:border-accent-cyan font-semibold mb-2 text-text-primary" value="${groupName}" placeholder="Nama Kelompok">
                <textarea class="data-input feedback-form-input" rows="3" placeholder="Masukkan data...">${data}</textarea>
            </div>`);
    }

    function createTwoWayRow(val = '', g1 = '', g2 = '') {
        $('#manual-twoway-tbody').append(`
            <tr>
                <td><input type="text" value="${val}" placeholder="Nilai"></td>
                <td><input type="text" value="${g1}" placeholder="Kategori A"></td>
                <td><input type="text" value="${g2}" placeholder="Kategori B"></td>
            </tr>`);
    }

    function updateManualInputUI() {
        const anovaType = $('#anova-type').val();
        if (anovaType === 'one_way') {
            $('#manual-oneway-container').show();
            $('#manual-twoway-container').hide();
        } else { // two_way
            $('#manual-oneway-container').hide();
            $('#manual-twoway-container').show();
        }
        populateSelectorsForManual();
    }

    // --- Inisialisasi Awal ---
    createOneWayGroup('Kelompok A', '');
    createOneWayGroup('Kelompok B', '');
    for(let i=0; i<5; i++) createTwoWayRow();

    // --- EVENT LISTENERS ---
    $('.input-method-btn').on('click', function() {
        $('.input-method-btn').removeClass('active');
        $(this).addClass('active');
        const selectedMethod = $(this).data('method');
        
        $('#anova-type').prop('disabled', false);
        if (selectedMethod === 'upload') {
            $('#upload-container').show();
            $('#manual-input-container').hide();
            if ($('#file-upload').val()) {
                $('#file-upload').trigger('change');
            } else {
                resetSelectors();
            }
        } else { // manual
            $('#upload-container').hide();
            $('#manual-input-container').show();
            updateManualInputUI();
        }
    });

    $('#anova-type').on('change', function() {
        const type = $(this).val();
        const hasHeaders = columnHeaders.length > 0;
        const isManualMode = $('.input-method-btn.active').data('method') === 'manual';

        if (type === 'two_way') {
            $('#independent-var-2-container').slideDown();
            if (!isManualMode) {
                $('#independent-var-2').prop('disabled', !hasHeaders);
            }
        } else {
            $('#independent-var-2-container').slideUp();
            $('#independent-var-2').prop('disabled', true);
        }
        if (isManualMode) {
            updateManualInputUI();
        }
    });

    $('#load-sample').on('click', function() {
        const anovaType = $('#anova-type').val();
        if (anovaType === 'one_way') {
            $('#groups-container').empty();
            createOneWayGroup('Metode A', '85, 88, 82, 89, 90, 84, 87');
            createOneWayGroup('Metode B', '78, 81, 79, 80, 83, 77, 82');
            createOneWayGroup('Metode C', '90, 92, 95, 88, 91, 94, 93');
        } else { // two_way
            $('#manual-twoway-tbody').empty();
            const sampleData = [
                { v: 85, g1: 'Metode A', g2: 'Pria' }, { v: 88, g1: 'Metode A', g2: 'Pria' },
                { v: 82, g1: 'Metode A', g2: 'Wanita' }, { v: 89, g1: 'Metode A', g2: 'Wanita' },
                { v: 78, g1: 'Metode B', g2: 'Pria' }, { v: 81, g1: 'Metode B', g2: 'Pria' },
                { v: 79, g1: 'Metode B', g2: 'Wanita' }, { v: 80, g1: 'Metode B', g2: 'Wanita' }
            ];
            sampleData.forEach(d => createTwoWayRow(d.v, d.g1, d.g2));
        }
        populateSelectorsForManual();
    });

    $('#add-group').on('click', () => createOneWayGroup());
    $('#remove-group').on('click', function() {
        if ($('#groups-container').children().length > 2) {
            $('#groups-container').children().last().remove();
        } else {
            showNotification('Peringatan', 'Minimal harus ada 2 kelompok.');
        }
    });
    $('#add-row').on('click', () => createTwoWayRow());
    $('#remove-row').on('click', function() {
        if ($('#manual-twoway-tbody tr').length > 2) {
            $('#manual-twoway-tbody tr:last').remove();
        } else {
            showNotification('Peringatan', 'Minimal harus ada 2 baris data.');
        }
    });
    
    const fileDropArea = $('.file-drop-area');
    fileDropArea.on('dragover dragenter', function() { $(this).addClass('is-active'); });
    fileDropArea.on('dragleave dragend drop', function() { $(this).removeClass('is-active'); });
    
    $('#file-upload').on('change', function(e) {
        const file = e.target.files[0];
        if (!file) { resetSelectors(); $('#file-name').text(''); return; }
        $('#file-name').text(`File terpilih: ${file.name}`);
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = event.target.result;
                if (file.name.endsWith('.csv')) {
                    const firstLine = data.split('\n')[0].split('\r')[0];
                    columnHeaders = firstLine.split(',').map(h => h.trim().replace(/"/g, ''));
                } else {
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const headers = XLSX.utils.sheet_to_json(worksheet, {header: 1})[0];
                    columnHeaders = headers.map(h => String(h).trim());
                }
                populateSelectorsFromFile();
            } catch (err) {
                showNotification('Gagal Membaca File', 'Tidak dapat membaca header dari file. Pastikan format file benar dan memiliki baris header.');
                resetSelectors();
            }
        };
        if (file.name.endsWith('.csv')) reader.readAsText(file);
        else reader.readAsBinaryString(file);
    });

    $('#anova-form').on('submit', function(e) { e.preventDefault(); runAnalysis(); });
    
    $('#copy-summary').on('click', function() {
        navigator.clipboard.writeText($('#summary-indonesia').text()).then(() => {
            $(this).text('Berhasil disalin!');
            setTimeout(() => $(this).text('Salin ke Laporan'), 2000);
        });
    });
    $('#download-plot').on('click', function() {
        const link = document.createElement('a');
        link.href = $('#result-plot').attr('src');
        link.download = 'anova-plot-onthesis.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    // --- Notifikasi & Fungsi Utama ---
    function showNotification(title, message) {
        $('#notification-title').text(title);
        $('#notification-message').html(message);
        $('#notification').css('display', 'flex');
    }
    $('#notification-close').on('click', () => $('#notification').fadeOut());

    async function runAnalysis() {
        const button = $('#run-analysis'), btnText = button.find('.btn-text'), spinner = button.find('.spinner');
        const form = $('#anova-form')[0], formData = new FormData(form);
        const inputMethod = $('.input-method-btn.active').data('method'), anovaType = formData.get('anova_type');
        let endpoint = '', payload, headers = {};

        if (!formData.get('dependent') || !formData.get('independent1')) { showNotification('Input Tidak Lengkap', 'Harap pilih Variabel Dependen dan Variabel Grup 1.'); return; }
        if (anovaType === 'two_way' && !formData.get('independent2')) { showNotification('Input Tidak Lengkap', 'Untuk Two-Way ANOVA, harap pilih juga Variabel Grup 2.'); return; }
        if (anovaType === 'two_way' && formData.get('independent1') === formData.get('independent2')) { showNotification('Input Tidak Valid', 'Variabel Grup 1 dan Variabel Grup 2 tidak boleh sama.'); return; }

        if (inputMethod === 'upload') {
            if (!$('#file-upload')[0].files.length) { showNotification('File Belum Dipilih', 'Silakan pilih file data untuk diunggah.'); return; }
            endpoint = "{{ url_for('api_anova_test_file') }}";
            payload = formData;
        } else { // manual
            if (anovaType === 'one_way') {
                let groupsData = [], groupNames = [], hasError = false;
                $('.data-group').each(function() {
                    const groupName = $(this).find('.group-name-input').val().trim();
                    const dataArea = $(this).find('.data-input');
                    const values = dataArea.val().trim().split(/[ ,\n\t;]+/).map(Number).filter(v => !isNaN(v));
                    if (!groupName || values.length < 2) { hasError = true; dataArea.addClass('input-error'); } 
                    else { dataArea.removeClass('input-error'); groupsData.push(values); groupNames.push(groupName); }
                });
                if (hasError || groupsData.length < 2) { showNotification('Input Manual Tidak Valid', 'Pastikan semua grup memiliki nama dan minimal 2 data angka yang valid.'); return; }
                endpoint = "{{ url_for('api_anova_test_manual') }}";
                payload = JSON.stringify({ groups: groupsData, group_names: groupNames, anova_type: 'one_way' });
                headers = { 'Content-Type': 'application/json' };
            } else { // manual two-way
                let manualData = [], hasError = false;
                const colNames = { dependent: $('#manual-col-dependent').val().trim(), independent1: $('#manual-col-independent1').val().trim(), independent2: $('#manual-col-independent2').val().trim() };
                $('#manual-twoway-tbody tr').each(function() {
                    const row = $(this), val = parseFloat(row.find('td:eq(0) input').val()), g1 = row.find('td:eq(1) input').val().trim(), g2 = row.find('td:eq(2) input').val().trim();
                    if (isNaN(val) && !g1 && !g2) return true; // Lewati baris kosong
                    if (isNaN(val) || !g1 || !g2) { hasError = true; return false; }
                    let rowData = {};
                    rowData[colNames.dependent] = val; rowData[colNames.independent1] = g1; rowData[colNames.independent2] = g2;
                    manualData.push(rowData);
                });
                if (hasError || manualData.length < 2) { showNotification('Input Manual Tidak Valid', 'Pastikan semua baris pada tabel Two-Way ANOVA terisi dengan data yang benar (Angka, Teks, Teks).'); return; }
                endpoint = "{{ url_for('api_anova_test_manual') }}";
                payload = JSON.stringify({ data: manualData, anova_type: 'two_way' });
                headers = { 'Content-Type': 'application/json' };
            }
        }
        
        btnText.text('Menganalisis...'); spinner.removeClass('hidden'); button.prop('disabled', true); $('#results-container').slideUp();
        try {
            const response = await fetch(endpoint, { method: 'POST', body: payload, ...(Object.keys(headers).length && {headers}) });
            analysisData = await response.json();
            if (!response.ok || !analysisData.success) { throw new Error(analysisData.message || `Error ${response.status}`); }
            displayResults(analysisData);
            $('#results-container').slideDown();
        } catch (error) {
            showNotification('Terjadi Kesalahan', error.message);
        } finally {
            btnText.text('Jalankan Analisis'); spinner.addClass('hidden'); button.prop('disabled', false);
        }
    }
    
    // --- FUNGSI EKSPOR (DIPERBARUI TOTAL) ---
    const loadImageAsBase64 = (url) => {
        return new Promise((resolve, reject) => {
            if (!url) { resolve(null); return; }
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = () => reject(new Error('Gagal memuat gambar untuk ekspor.'));
            img.src = url;
        });
    };

    async function exportToPdf() {
        if (!analysisData) { showNotification("Gagal Ekspor", "Tidak ada data hasil analisis untuk diekspor."); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let yPos = 25;

        try {
            const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-black.png') }}";
            const logoData = await loadImageAsBase64(logoUrl);
            doc.addImage(logoData, 'PNG', doc.internal.pageSize.width - 45, 8, 30, 8);
        } catch(e) { console.error("Logo gagal dimuat untuk PDF"); }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Laporan Hasil Analisis ANOVA - OnThesis", doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text("Ringkasan & Interpretasi", 14, yPos);
        yPos += 8;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(`Jenis Analisis: ${analysisData.analysis_type}`, 14, yPos);
        yPos += 7;
        const summaryLines = doc.splitTextToSize(analysisData.summary.indonesia, 180);
        doc.text(summaryLines, 14, yPos);
        yPos += summaryLines.length * 4 + 10;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Tabel Statistik Deskriptif", 14, yPos);
        yPos += 2;
        doc.autoTable({ html: '#desc-table', startY: yPos, theme: 'grid', headStyles: { fillColor: [2, 132, 199] } });
        yPos = doc.autoTable.previous.finalY + 10;

        doc.text(`Hasil Uji Utama (${analysisData.analysis_type})`, 14, yPos);
        yPos += 2;
        doc.autoTable({ html: '#main-test-table', startY: yPos, theme: 'grid', headStyles: { fillColor: [2, 132, 199] } });
        yPos = doc.autoTable.previous.finalY + 10;

        if (analysisData.post_hoc_results && analysisData.post_hoc_results.length > 0) {
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            doc.text("Hasil Uji Post-Hoc", 14, yPos);
            yPos += 2;
            doc.autoTable({ html: '#posthoc-table', startY: yPos, theme: 'grid', headStyles: { fillColor: [2, 132, 199] } });
            yPos = doc.autoTable.previous.finalY + 10;
        }

        if (yPos > 180) { doc.addPage(); yPos = 20; }
        doc.text("Visualisasi", 14, yPos);
        yPos += 5;
        try {
            const imgElement = document.getElementById('result-plot');
            const imgData = imgElement.src;
            const imgProps = doc.getImageProperties(imgData);
            const imgWidth = 180;
            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
            doc.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight);
        } catch(e) {
            doc.text("Gagal memuat grafik.", 15, yPos);
        }
        
        doc.save('Laporan_ANOVA_OnThesis.pdf');
    }

    async function exportToDoc() {
        if (!analysisData) { showNotification("Gagal Ekspor", "Tidak ada data hasil analisis untuk diekspor."); return; }
        
        try {
            const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-black.png') }}";
            const logoData = await loadImageAsBase64(logoUrl);
            const plotData = await loadImageAsBase64($('#result-plot').attr('src'));

            let contentHtml = `
                <div style="font-family: 'Times New Roman', Times, serif; font-size: 12pt;">
                    <p style="text-align: right;"><img src="${logoData}" width="150"></p>
                    <h1 style="text-align: center;">Laporan Hasil Analisis ANOVA</h1>
                    <h3>Ringkasan & Interpretasi</h3>
                    <p><b>Jenis Analisis:</b> ${analysisData.analysis_type}</p>
                    <p>${analysisData.summary.indonesia}</p>
                    <br/>
                    <h3>Tabel Statistik Deskriptif</h3>
                    ${$('#desc-table').parent().html()}
                    <br/>
                    <h3>Hasil Uji Utama (${analysisData.analysis_type})</h3>
                    ${$('#main-test-table').parent().html()}
            `;
            if (analysisData.post_hoc_results && analysisData.post_hoc_results.length > 0) {
                contentHtml += `<br/><h3>Hasil Uji Post-Hoc</h3>${$('#posthoc-table').parent().html()}`;
            }
            contentHtml += `
                    <br/>
                    <h3>Visualisasi</h3>
                    <p><img src="${plotData}" style="width:500px; height:auto;" /></p>
                </div>`;

            const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
                body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; }
                h1, h2, h3, h4 { font-family: 'Times New Roman', Times, serif; color: #000; }
                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                th, td { border: 1px solid #000000; text-align: left; padding: 8px; }
                th { background-color: #f2f2f2; }
                </style></head><body>${contentHtml}</body></html>`;
            
            const converted = htmlDocx.asBlob(fullHtml);
            saveAs(converted, 'Laporan_ANOVA_OnThesis.docx');
        } catch(e) {
            showNotification("Gagal Ekspor", "Terjadi kesalahan saat menyiapkan data untuk ekspor.");
        }
    }

    $('#export-pdf-btn').on('click', exportToPdf);
    $('#export-doc-btn').on('click', exportToDoc);

    // --- Fungsi Tampilan & Reset (Lengkap) ---
    function displayResults(data) {
        const { prerequisites, analysis_type, summary, descriptive_stats, main_test_results, post_hoc_results, plot } = data;
        $('#normality-badge').html(`<span class="badge badge-${prerequisites.is_all_normal ? 'success' : 'warning'}">${prerequisites.is_all_normal ? '✅ Normalitas Terpenuhi' : '⚠️ Normalitas Tidak Terpenuhi'}</span>`);
        $('#homogeneity-badge').html(`<span class="badge badge-${prerequisites.is_homogeneous ? 'success' : 'warning'}">${prerequisites.is_homogeneous ? '✅ Homogenitas Terpenuhi' : '⚠️ Homogenitas Tidak Terpenuhi'}</span>`);
        $('#prerequisite-summary').html("Uji prasyarat telah dilakukan secara otomatis untuk memastikan validitas hasil.");
        $('#analysis-type').text(analysis_type);
        $('#summary-indonesia').text(summary.indonesia);
        $('#summary-apa').text(summary.apa);
        const descColumns = Object.keys(descriptive_stats[0]).map(key => ({ title: key.charAt(0).toUpperCase() + key.slice(1), data: key }));
        renderDataTable('#desc-table', descriptive_stats, descColumns);
        $('#main-test-title').text(analysis_type);
        const mainTestData = Array.isArray(main_test_results) ? main_test_results : [main_test_results];
        const mainTestColumns = Object.keys(mainTestData[0]).map(key => ({ title: key.replace(/_/g, ' ').replace('stat', 'Statistic').replace(/\b\w/g, l => l.toUpperCase()), data: key }));
        renderDataTable('#main-test-table', mainTestData, mainTestColumns);
        if (post_hoc_results && post_hoc_results.length > 0) {
            $('#posthoc-container').show();
            $('#posthoc-title').text("Tukey HSD / Games-Howell");
            const pKey = Object.keys(post_hoc_results[0]).find(k => k.startsWith('p-'));
            const posthocColumns = Object.keys(post_hoc_results[0]).map(key => ({ title: key.replace(pKey, 'p-value'), data: key }));
            renderDataTable('#posthoc-table', post_hoc_results, posthocColumns, (row, data) => { if (data[pKey] < 0.05) $(row).addClass('highlight'); });
        } else {
            $('#posthoc-container').hide();
        }
        $('#result-plot').attr('src', plot);
    }
    
    function renderDataTable(tableId, data, columns, createdRowCallback = null) {
        if ($.fn.DataTable.isDataTable(tableId)) $(tableId).DataTable().destroy();
        $(tableId).DataTable({
            data: data, columns: columns, paging: false, searching: false, info: false, ordering: false, responsive: true, createdRow: createdRowCallback,
            language: { emptyTable: "Tidak ada data untuk ditampilkan" }
        });
    }

    function resetSelectors() {
        const selects = ['#dependent-var', '#independent-var-1', '#independent-var-2'];
        selects.forEach(id => $(id).empty().append('<option>Sediakan data terlebih dahulu</option>').prop('disabled', true));
        $('#run-analysis').prop('disabled', true);
    }

    function populateSelectorsFromFile() {
        const selects = ['#dependent-var', '#independent-var-1', '#independent-var-2'];
        selects.forEach(id => {
            const select = $(id), currentValue = select.val();
            select.empty().append('<option value="">Pilih variabel...</option>');
            columnHeaders.forEach(header => { if(header) select.append(`<option value="${header}">${header}</option>`); });
            select.val(currentValue);
            select.prop('disabled', false);
        });
        if ($('#anova-type').val() !== 'two_way') {
            $('#independent-var-2').prop('disabled', true);
        }
        $('#run-analysis').prop('disabled', false);
    }

    function populateSelectorsForManual() {
        const anovaType = $('#anova-type').val();
        if (anovaType === 'one_way') {
            $('#dependent-var').empty().append('<option value="Nilai">Nilai (Dependen)</option>').prop('disabled', false);
            $('#independent-var-1').empty().append('<option value="Kelompok">Kelompok (Grup)</option>').prop('disabled', false);
            $('#independent-var-2').empty().append('<option>Tidak tersedia</option>').prop('disabled', true);
        } else { // two_way
            const colDep = $('#manual-col-dependent').val(), colInd1 = $('#manual-col-independent1').val(), colInd2 = $('#manual-col-independent2').val();
            $('#dependent-var').empty().append(`<option value="${colDep}">${colDep}</option>`).prop('disabled', false);
            $('#independent-var-1').empty().append(`<option value="${colInd1}">${colInd1}</option>`).prop('disabled', false);
            $('#independent-var-2').empty().append(`<option value="${colInd2}">${colInd2}</option>`).prop('disabled', false);
        }
        $('#run-analysis').prop('disabled', false);
    }
    
    $('#manual-col-dependent, #manual-col-independent1, #manual-col-independent2').on('keyup', populateSelectorsForManual);
});
</script>
{% endblock %}
