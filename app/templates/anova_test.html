{% extends "layout.html" %}

{% block title %}Uji ANOVA Profesional - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Grafik & Tabel -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- Pustaka untuk Export Profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- Library untuk membaca file Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<style>
    /* Gaya untuk file upload modern */
    .file-drop-area {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 2rem;
        border: 2px dashed var(--border-panel);
        border-radius: 0.75rem;
        transition: all 0.2s ease-in-out;
        background-color: var(--bg-canvas);
    }
    .file-drop-area.is-active {
        border-color: var(--accent-cyan);
        background-color: var(--accent-cyan-glow);
    }
    .file-input {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
        cursor: pointer;
        opacity: 0;
    }

    /* Gaya untuk tab yang aktif */
    .tab-button.active {
        color: var(--accent-cyan);
        border-bottom-color: var(--accent-cyan);
        font-weight: 600;
    }
    
    /* Gaya untuk badge status */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        font-weight: 600;
        border-radius: 9999px;
    }
    .badge-success { background-color: rgba(34, 211, 238, 0.1); color: var(--accent-cyan); }
    .badge-warning { background-color: rgba(251, 191, 36, 0.1); color: #FBBF24; }
    
    /* Gaya untuk highlight tabel */
    .highlight td {
        background-color: var(--accent-cyan-glow) !important;
        font-weight: 600;
        color: var(--text-primary) !important;
    }

    /* Penyesuaian DataTable dengan tema */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: var(--text-secondary) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: var(--accent-cyan) !important;
        color: var(--bg-panel) !important;
        border-color: var(--accent-cyan) !important;
    }
    html.light .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        color: white !important;
    }
    table.dataTable thead th {
        border-bottom: 1px solid var(--border-panel);
    }
    table.dataTable.no-footer {
        border-bottom: 1px solid var(--border-panel);
    }
    table.dataTable tbody tr {
        background-color: transparent;
    }
    table.dataTable tbody td {
        color: var(--text-secondary);
    }

    /* Tombol switcher metode input */
    .input-method-btn.active {
        background-color: var(--accent-cyan);
        color: var(--bg-panel);
        font-weight: 600;
    }
    html.light .input-method-btn.active {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">ANOVA (Analysis of Variance)</h1>
        <p class="text-lg text-text-secondary mt-1">Bandingkan rata-rata dari tiga atau lebih kelompok secara profesional.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Kartu Input -->
        <div class="apex-card p-6">
            <form id="anova-form" class="space-y-6">
                <!-- Pilihan Metode Input -->
                <div>
                    <h3 class="text-xl font-bold text-text-primary mb-4">Input Data</h3>
                    <div class="flex gap-1 border border-border-panel p-1 rounded-lg bg-bg-canvas">
                        <button type="button" class="input-method-btn active btn-secondary flex-1 border-0" data-method="upload">Unggah File</button>
                        <button type="button" class="input-method-btn btn-secondary flex-1 border-0" data-method="manual">Input Manual</button>
                    </div>
                </div>

                <!-- Kontainer Unggah File -->
                <div id="upload-container">
                    <div class="file-drop-area">
                        <div class="text-center text-text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-accent-cyan opacity-50"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <p class="mb-2">Seret & letakkan file di sini, atau</p>
                            <button type="button" class="btn-secondary text-sm" onclick="$('#file-upload').click();">Pilih File</button>
                            <p id="file-name" class="mt-2 text-sm"></p>
                        </div>
                        <input type="file" id="file-upload" name="file" class="file-input" accept=".csv, .xlsx, .xls">
                    </div>
                </div>

                <!-- Kontainer Input Manual -->
                <div id="manual-input-container" style="display: none;">
                    <p class="text-sm text-text-secondary mb-4">Masukkan data untuk setiap kelompok. Pisahkan setiap angka dengan koma, spasi, atau baris baru.</p>
                    <div id="groups-container" class="space-y-4">
                        <!-- Grup dinamis akan ditambahkan di sini -->
                    </div>
                    <div class="flex gap-4 mt-4 pt-4 border-t border-border-panel">
                        <button type="button" id="add-group" class="btn-secondary text-sm flex-grow">+ Tambah Grup</button>
                        <button type="button" id="remove-group" class="btn-secondary text-sm flex-grow">- Hapus Grup</button>
                        <button type="button" id="load-sample" class="btn-secondary text-sm flex-grow">Muat Contoh</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-border-panel">
                    <div>
                        <label for="dependent-var" class="block text-sm font-medium text-text-secondary mb-1">Variabel Dependen</label>
                        <select id="dependent-var" name="dependent" class="feedback-form-input" required disabled>
                            <option>Sediakan data terlebih dahulu</option>
                        </select>
                        <p class="mt-1 text-xs text-text-secondary">Pilih variabel numerik yang akan diuji.</p>
                    </div>
                    <div>
                        <label for="independent-var" class="block text-sm font-medium text-text-secondary mb-1">Variabel Grup (Independen)</label>
                        <select id="independent-var" name="independent" class="feedback-form-input" required disabled>
                            <option>Sediakan data terlebih dahulu</option>
                        </select>
                        <p class="mt-1 text-xs text-text-secondary">Pilih variabel kategori sebagai pembeda grup.</p>
                    </div>
                </div>

                <div>
                    <button type="submit" id="run-analysis" class="btn-primary w-full" disabled>
                        <span class="btn-text">Jalankan Analisis</span>
                        <div class="spinner hidden ml-2 w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Kontainer Hasil -->
        <div id="results-container" class="space-y-8" style="display: none;">
            <div class="apex-card p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-text-primary">Hasil Analisis</h2>
                    <div class="flex gap-2">
                        <button id="export-pdf-btn" class="btn-secondary text-sm">Export PDF</button>
                        <button id="export-doc-btn" class="btn-secondary text-sm">Export DOC</button>
                    </div>
                </div>
                <div class="border-b border-border-panel mb-6">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-text-secondary hover:text-text-primary" data-tab="summary-tab">Ringkasan</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-text-secondary hover:text-text-primary" data-tab="stats-tab">Tabel Statistik</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-text-secondary hover:text-text-primary" data-tab="plot-tab">Visualisasi</button>
                    </nav>
                </div>
                <div id="tab-content" class="prose max-w-none prose-sm text-text-secondary">
                    <div id="summary-tab" class="tab-pane">
                        <h3 class="font-bold text-lg text-text-primary">Uji Prasyarat</h3>
                        <div class="flex flex-wrap gap-4 mb-4">
                            <div id="normality-badge"></div>
                            <div id="homogeneity-badge"></div>
                        </div>
                        <p id="prerequisite-summary" class="text-sm"></p>
                        <h3 class="font-bold text-lg text-text-primary mt-6">Jenis Analisis yang Digunakan</h3>
                        <p id="analysis-type" class="text-accent-cyan font-semibold"></p>
                        <h3 class="font-bold text-lg text-text-primary mt-6">Interpretasi Hasil</h3>
                        <div class="p-4 bg-bg-canvas rounded-md border border-border-panel">
                            <p id="summary-indonesia" class="text-text-primary"></p>
                            <button id="copy-summary" class="mt-3 text-xs font-semibold text-accent-cyan hover:underline">Salin ke Laporan</button>
                        </div>
                        <h4 class="font-semibold text-md text-text-primary mt-4">Format Laporan (APA Style)</h4>
                        <div class="p-3 bg-bg-canvas rounded-md border border-border-panel text-sm">
                            <p id="summary-apa" class="font-mono"></p>
                        </div>
                    </div>
                    <div id="stats-tab" class="tab-pane hidden">
                        <h3 class="font-bold text-lg text-text-primary">Statistik Deskriptif</h3>
                        <table id="desc-table" class="display" style="width:100%"></table>
                        <h3 class="font-bold text-lg text-text-primary mt-8">Hasil Uji Utama (<span id="main-test-title"></span>)</h3>
                        <table id="main-test-table" class="display" style="width:100%"></table>
                        <div id="posthoc-container" class="mt-8" style="display: none;">
                            <h3 class="font-bold text-lg text-text-primary">Hasil Uji Post-Hoc (<span id="posthoc-title"></span>)</h3>
                            <p class="text-sm">Tabel perbandingan antar pasangan grup. Nilai p-value < 0.05 menunjukkan perbedaan yang signifikan.</p>
                            <table id="posthoc-table" class="display" style="width:100%"></table>
                        </div>
                    </div>
                    <div id="plot-tab" class="tab-pane hidden">
                        <div id="plot-output" class="w-full h-[500px] bg-bg-canvas rounded-md flex items-center justify-center border border-border-panel">
                            <img id="result-plot" src="" alt="Hasil Plot Analisis" class="max-w-full max-h-full">
                        </div>
                         <button id="download-plot" class="mt-4 btn-secondary text-sm">Download Grafik (PNG)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    let columnHeaders = [];
    let analysisData = null;

    // --- Inisialisasi Input Manual ---
    function createGroup(name = '', data = '') {
        const groupCount = $('#groups-container').children().length + 1;
        const groupName = name || `Kelompok ${groupCount}`;
        const groupHtml = `
            <div class="data-group bg-bg-canvas border border-border-panel p-3 rounded-lg">
                <input type="text" class="group-name-input w-full bg-transparent border-0 border-b-2 border-border-panel focus:ring-0 focus:border-accent-cyan font-semibold mb-2 text-text-primary" value="${groupName}" placeholder="Nama Kelompok">
                <textarea class="data-input feedback-form-input" rows="3" placeholder="Masukkan data...">${data}</textarea>
            </div>
        `;
        $('#groups-container').append(groupHtml);
    }
    createGroup('Kelompok A');
    createGroup('Kelompok B');

    // --- Event Listeners ---
    $('.input-method-btn').on('click', function() {
        $('.input-method-btn').removeClass('active');
        $(this).addClass('active');
        const selectedMethod = $(this).data('method');
        
        if (selectedMethod === 'upload') {
            $('#upload-container').show();
            $('#manual-input-container').hide();
            if ($('#file-upload').val()) {
                $('#file-upload').trigger('change');
            } else {
                resetSelectors();
            }
        } else { // manual
            $('#upload-container').hide();
            $('#manual-input-container').show();
            populateSelectorsForManual();
        }
    });

    const fileDropArea = $('.file-drop-area');
    fileDropArea.on('dragover dragenter', function() {
        $(this).addClass('is-active');
    });
    fileDropArea.on('dragleave dragend drop', function() {
        $(this).removeClass('is-active');
    });

    $('#file-upload').on('change', function(e) {
        const file = e.target.files[0];
        if (!file) {
            resetSelectors();
            $('#file-name').text('');
            return;
        }

        $('#file-name').text(`File terpilih: ${file.name}`);
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const data = event.target.result;
            if (file.name.endsWith('.csv')) {
                const firstLine = data.split('\\n')[0].split('\\r')[0];
                columnHeaders = firstLine.split(',').map(h => h.trim().replace(/"/g, ''));
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                const workbook = XLSX.read(data, {type: 'binary'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const headers = XLSX.utils.sheet_to_json(worksheet, {header: 1})[0];
                columnHeaders = headers.map(h => String(h).trim());
            }
            populateSelectorsFromFile();
        };

        if (file.name.endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsBinaryString(file);
        }
    });

    $('#add-group').on('click', () => createGroup());
    $('#remove-group').on('click', function() {
        if ($('#groups-container').children().length > 2) {
            $('#groups-container').children().last().remove();
        } else {
            alert('Minimal harus ada 2 kelompok.');
        }
    });

    $('#load-sample').on('click', function() {
        $('.input-method-btn[data-method="manual"]').trigger('click');
        $('#groups-container').empty();
        createGroup('Metode A', '85, 88, 82, 89, 90, 84, 87');
        createGroup('Metode B', '78, 81, 79, 80, 83, 77, 82');
        createGroup('Metode C', '90, 92, 95, 88, 91, 94, 93');
        populateSelectorsForManual();
    });

    $('#anova-form').on('submit', function(e) {
        e.preventDefault();
        runAnalysis();
    });

    $('.tab-button').on('click', function() {
        const tabId = $(this).data('tab');
        $('.tab-button').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').hide();
        $('#' + tabId).show();
    });

    $('#copy-summary').on('click', function() {
        const textToCopy = $('#summary-indonesia').text();
        navigator.clipboard.writeText(textToCopy).then(() => {
            $(this).text('Berhasil disalin!');
            setTimeout(() => $(this).text('Salin ke Laporan'), 2000);
        });
    });
    
    $('#download-plot').on('click', function() {
        const link = document.createElement('a');
        link.href = $('#result-plot').attr('src');
        link.download = 'anova-plot-onthesis.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // --- Functions ---
    function resetSelectors() {
        const depSelect = $('#dependent-var');
        const indepSelect = $('#independent-var');
        depSelect.empty().append('<option>Sediakan data terlebih dahulu</option>').prop('disabled', true);
        indepSelect.empty().append('<option>Sediakan data terlebih dahulu</option>').prop('disabled', true);
        $('#run-analysis').prop('disabled', true);
    }

    function populateSelectorsFromFile() {
        const depSelect = $('#dependent-var');
        const indepSelect = $('#independent-var');
        depSelect.empty().append('<option value="">Pilih variabel...</option>');
        indepSelect.empty().append('<option value="">Pilih variabel...</option>');

        columnHeaders.forEach(header => {
            if(header) {
                depSelect.append(`<option value="${header}">${header}</option>`);
                indepSelect.append(`<option value="${header}">${header}</option>`);
            }
        });

        depSelect.prop('disabled', false);
        indepSelect.prop('disabled', false);
        $('#run-analysis').prop('disabled', false);
    }

    function populateSelectorsForManual() {
        const depSelect = $('#dependent-var');
        const indepSelect = $('#independent-var');
        depSelect.empty().append('<option value="Nilai">Nilai (Dependen)</option>').prop('disabled', false);
        indepSelect.empty().append('<option value="Kelompok">Kelompok (Grup)</option>').prop('disabled', false);
        $('#run-analysis').prop('disabled', false);
    }

    async function runAnalysis() {
        const button = $('#run-analysis');
        const btnText = button.find('.btn-text');
        const spinner = button.find('.spinner');
        const inputMethod = $('.input-method-btn.active').data('method');
        
        let endpoint = '';
        let payload = {};
        let headers = {};

        if (inputMethod === 'upload') {
            const form = $('#anova-form')[0];
            const formData = new FormData(form);
            if (!$('#file-upload')[0].files.length) {
                alert('Silakan pilih file untuk diunggah.');
                return;
            }
            // PERBAIKAN FINAL UNTUK ENDPOINT FILE UPLOAD
            endpoint = "{{ url_for('api_anova_test_file') }}";
            payload = formData;
            // Headers will be set automatically for FormData
        } else { // manual
            let groupsData = [];
            let groupNames = [];
            let hasError = false;

            $('.data-group').each(function() {
                const groupName = $(this).find('.group-name-input').val().trim();
                const dataArea = $(this).find('.data-input');
                const dataText = dataArea.val().trim();
                const values = dataText.split(/[ ,\\n\\t;]+/).map(Number).filter(v => !isNaN(v));
                
                if (!groupName || values.length < 2) {
                    hasError = true;
                    dataArea.addClass('input-error');
                } else {
                    dataArea.removeClass('input-error');
                    groupsData.push(values);
                    groupNames.push(groupName);
                }
            });

            if (hasError || groupsData.length < 2) {
                alert('Pastikan semua grup memiliki nama dan minimal 2 data poin yang valid.');
                return;
            }

            // PERBAIKAN FINAL UNTUK ENDPOINT INPUT MANUAL
            endpoint = "{{ url_for('api_anova_test_manual') }}";
            payload = JSON.stringify({ groups: groupsData, group_names: groupNames });
            headers = { 'Content-Type': 'application/json' };
        }

        btnText.text('Menganalisis...');
        spinner.removeClass('hidden');
        button.prop('disabled', true);
        $('#results-container').slideUp();

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                body: payload,
                headers: headers
            });

            analysisData = await response.json();

            if (!response.ok || !analysisData.success) {
                 throw new Error(analysisData.message || `Error ${response.status}`);
            }
            
            displayResults(analysisData);
            $('#results-container').slideDown();

        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            btnText.text('Jalankan Analisis');
            spinner.addClass('hidden');
            button.prop('disabled', false);
        }
    }

    function displayResults(data) {
        const { prerequisites, analysis_type, summary } = data;
        
        let normalityBadge = `<span class="badge badge-${prerequisites.is_all_normal ? 'success' : 'warning'}">✅ Normalitas Terpenuhi</span>`;
        if (!prerequisites.is_all_normal) {
            normalityBadge = `<span class="badge badge-warning">⚠️ Normalitas Tidak Terpenuhi</span>`;
        }
        $('#normality-badge').html(normalityBadge);

        let homogeneityBadge = `<span class="badge badge-${prerequisites.is_homogeneous ? 'success' : 'warning'}">✅ Homogenitas Terpenuhi</span>`;
        if (!prerequisites.is_homogeneous) {
            homogeneityBadge = `<span class="badge badge-warning">⚠️ Homogenitas Tidak Terpenuhi</span>`;
        }
        $('#homogeneity-badge').html(homogeneityBadge);
        
        const normalitySummary = prerequisites.is_all_normal 
            ? "Semua grup data berdistribusi normal (Uji Shapiro-Wilk, p > 0.05)."
            : "Setidaknya satu grup data tidak berdistribusi normal (Uji Shapiro-Wilk, p < 0.05). Sistem secara otomatis menggunakan uji non-parametrik (Kruskal-Wallis) yang lebih sesuai.";
        const homogeneitySummary = prerequisites.is_homogeneous
            ? "Varians antar grup data adalah homogen (Uji Levene, p > 0.05)."
            : "Varians antar grup data tidak homogen (Uji Levene, p < 0.05). Sistem secara otomatis menggunakan uji post-hoc (Games-Howell) yang robust terhadap pelanggaran asumsi ini.";
        $('#prerequisite-summary').html(`${normalitySummary}<br>${homogeneitySummary}`);

        $('#analysis-type').text(analysis_type);
        $('#summary-indonesia').text(summary.indonesia);
        $('#summary-apa').text(summary.apa);

        const { descriptive_stats, main_test_results, post_hoc_results } = data;
        
        const descColumns = Object.keys(descriptive_stats[0]).map(key => ({ title: key.charAt(0).toUpperCase() + key.slice(1), data: key }));
        renderDataTable('#desc-table', descriptive_stats, descColumns);

        $('#main-test-title').text(analysis_type);
        const mainTestColumns = Object.keys(main_test_results).map(key => ({ title: key.replace(/_/g, ' ').replace('stat', 'Statistic').replace(/\b\w/g, l => l.toUpperCase()), data: key }));
        renderDataTable('#main-test-table', [main_test_results], mainTestColumns);

        if (post_hoc_results && post_hoc_results.length > 0) {
            $('#posthoc-container').show();
            $('#posthoc-title').text(prerequisites.is_homogeneous ? 'Tukey HSD' : (analysis_type === 'One-Way ANOVA' ? 'Games-Howell' : 'Dunn'));
            const pKey = Object.keys(post_hoc_results[0]).find(k => k.startsWith('p-'));
            const posthocColumns = Object.keys(post_hoc_results[0]).map(key => ({ title: key.replace(pKey, 'p-value'), data: key }));
            renderDataTable('#posthoc-table', post_hoc_results, posthocColumns, (row, data) => {
                if (data[pKey] < 0.05) {
                    $(row).addClass('highlight');
                }
            });
        } else {
            $('#posthoc-container').hide();
        }

        $('#result-plot').attr('src', data.plot);
    }

    function renderDataTable(tableId, data, columns, createdRowCallback = null) {
        if ($.fn.DataTable.isDataTable(tableId)) {
            $(tableId).DataTable().destroy();
        }
        $(tableId).DataTable({
            data: data,
            columns: columns,
            paging: false,
            searching: false,
            info: false,
            ordering: false,
            responsive: true,
            createdRow: createdRowCallback,
            language: {
                emptyTable: "Tidak ada data untuk ditampilkan"
            }
        });
    }

});
</script>
{% endblock %}
