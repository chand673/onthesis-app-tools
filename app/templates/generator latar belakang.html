{% extends "layout.html" %}

{% block title %}Generator Latar Belakang - Asisten AI{% endblock %}

{% block page_styles %}
<!-- Pustaka Ikon -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Pustaka untuk konversi Markdown ke HTML -->
<script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>

<style>
    /* Gaya ini sekarang selaras dengan styles.css Anda */
    .io-panel {
        background-color: var(--bg-panel);
        border: 1px solid var(--border-panel);
        border-radius: 1rem;
        padding: 2rem; /* Padding disesuaikan */
        transition: all 0.3s ease-in-out;
    }
    .io-textarea {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        color: var(--text-primary);
        border-radius: 0.75rem;
        resize: vertical;
        transition: all 0.2s ease;
    }
    .io-textarea:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px var(--accent-cyan-glow);
    }
    .io-output {
        width: 100%;
        min-height: 300px;
        overflow-y: auto;
        color: var(--text-secondary);
    }
    /* Menggunakan gaya .prose untuk konsistensi */
    .io-output .prose p, .io-output .prose li { color: var(--text-secondary); }
    .io-output .prose strong, .io-output .prose h1, .io-output .prose h2, .io-output .prose h3, .io-output .prose code { color: var(--text-primary); }
    .io-output .prose a { color: var(--accent-cyan); text-decoration: none; border-bottom: 1px dashed var(--accent-cyan); }
    .io-output .prose a:hover { color: var(--text-primary); }
    .io-output .prose pre { background-color: var(--bg-canvas); border: 1px solid var(--border-panel); border-radius: 0.5rem; padding: 1rem; }
    
    .control-group label, .form-step label {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }
    .form-step p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        margin-top: -0.5rem;
    }
    .control-select {
        width: 100%;
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        color: var(--text-primary);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238B949E' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
    .control-select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px var(--accent-cyan-glow);
    }
    
    /* Menggunakan gaya .btn-primary dari styles.css */
    #generate-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        border: 1px solid transparent;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        background-color: var(--accent-cyan);
        color: var(--bg-panel); /* Disesuaikan agar kontras */
    }
     html.light #generate-btn {
        color: #fff;
    }
    #generate-btn:hover {
        filter: brightness(1.1);
    }
    #generate-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        filter: none;
    }

    /* Animasi notifikasi */
    @keyframes fade-in-out {
      0% { opacity: 0; transform: translateY(20px); } 10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(20px); }
    }
    .animate-fade-in-out { animation: fade-in-out 4s ease-in-out forwards; }

    /* Gaya untuk Loading Overlay disesuaikan dengan tema */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--glass-bg);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: var(--text-primary);
    }
    .spinner {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 6px solid var(--border-panel);
        border-top-color: var(--accent-cyan);
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="h-full w-full p-4 sm:p-6 lg:p-8 flex flex-col gap-8">
    <!-- Header Halaman Generator -->
    <header class="flex-shrink-0 flex items-center gap-4 animate-fade-in-up">
        <a href="/writing_assistant" class="back-to-menu btn-secondary !p-2" title="Kembali ke Menu Asisten">
            <i data-lucide="arrow-left"></i>
        </a>
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-primary">Generator Latar Belakang</h1>
            <p class="text-md text-secondary mt-1">Buat draf latar belakang masalah yang terstruktur dalam beberapa langkah.</p>
        </div>
    </header>

    <!-- Panel Input & Kontrol Utama -->
    <div class="io-panel w-full max-w-4xl mx-auto flex flex-col gap-8">
        <!-- Form Steps -->
        <div class="form-step">
            <label for="input-topic">Langkah 1: Topik Utama Penelitian</label>
            <p>Masukkan beberapa kata kunci utama yang paling relevan (3-5 kata).</p>
            <textarea id="input-topic" class="io-textarea" placeholder="Contoh: pengaruh media sosial, kesehatan mental, mahasiswa"></textarea>
        </div>
        <div class="form-step">
            <label for="input-problem">Langkah 2: Masalah yang Diangkat</label>
            <p>Jelaskan secara singkat masalah yang Anda amati terkait topik.</p>
            <textarea id="input-problem" class="io-textarea" placeholder="Contoh: Peningkatan kecemasan dan depresi di kalangan mahasiswa akibat tekanan perbandingan sosial di Instagram."></textarea>
        </div>
        <div class="form-step">
            <label for="input-goal">Langkah 3: Tujuan Penelitian</label>
            <p>Sebutkan apa yang ingin Anda capai atau buktikan melalui penelitian ini.</p>
            <textarea id="input-goal" class="io-textarea" placeholder="Contoh: Menganalisis hubungan antara intensitas penggunaan Instagram dengan tingkat depresi mahasiswa."></textarea>
        </div>
        <div class="form-step">
            <label for="input-location">Langkah 4: Lokasi Penelitian (Opsional)</label>
            <p>Spesifikkan lokasi jika ada, ini akan membantu AI mencari data yang lebih akurat.</p>
            <textarea id="input-location" class="io-textarea" placeholder="Contoh: Universitas Gadjah Mada, Yogyakarta"></textarea>
        </div>

        <!-- Pengaturan Penulisan -->
        <div class="border-t border-border-panel pt-8">
            <h3 class="text-xl font-bold text-primary mb-4">Pengaturan Penulisan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="control-group">
                    <label for="writing-mode">Mode Penulisan</label>
                    <select id="writing-mode" class="control-select">
                        <option value="Akademik Formal">Akademik Formal</option>
                        <option value="Semi-Formal">Semi-Formal</option>
                        <option value="Persuasif (Data-driven)">Persuasif (Data-driven)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="citation-style">Gaya Sitasi</label>
                    <select id="citation-style" class="control-select">
                        <option value="APA 7">APA 7</option>
                        <option value="IEEE">IEEE</option>
                        <option value="MLA">MLA</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Tombol Generate -->
        <div class="mt-4 text-center">
            <button id="generate-btn" class="btn-primary">
                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                Generate Latar Belakang
            </button>
        </div>
    </div>

    <!-- Panel Output -->
    <div id="output-panel" class="io-panel w-full max-w-4xl mx-auto flex-col gap-4 hidden">
        <!-- Toolbar Output -->
        <div class="flex justify-between items-center pb-4 border-b border-[var(--border-panel)]">
            <h2 class="text-xl font-bold text-primary">Hasil Draf Latar Belakang</h2>
            <div class="flex items-center gap-2">
                <div id="originality-indicator" class="hidden items-center gap-2 text-sm bg-green-900/50 text-green-300 px-3 py-1 rounded-full border border-green-500/50">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Originalitas: <strong id="originality-score">97%</strong></span>
                </div>
                <button id="paraphrase-btn" class="btn-secondary !p-2" title="Parafrase Ulang"><i data-lucide="refresh-cw"></i></button>
                <button id="export-btn" class="btn-secondary !p-2" title="Ekspor Dokumen"><i data-lucide="download"></i></button>
            </div>
        </div>
        <!-- Konten Output -->
        <div id="output-content" class="io-output prose max-w-none">
            <!-- Hasil generate akan muncul di sini -->
        </div>
    </div>
</div>

<!-- Kontainer Notifikasi -->
<div id="notification-container" class="fixed bottom-5 right-5 z-50 w-full max-w-sm"></div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <h3 class="text-xl font-semibold">AI sedang menganalisis...</h3>
    <p class="text-secondary">Menyusun draf dan mencari data pendukung. Mohon tunggu sebentar.</p>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Inisialisasi Elemen ---
    const generateBtn = document.getElementById('generate-btn');
    const outputPanel = document.getElementById('output-panel');
    const outputContent = document.getElementById('output-content');
    const originalityIndicator = document.getElementById('originality-indicator');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    const renderIcons = () => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    };

    const showNotification = (message, type = 'success') => {
        const container = document.getElementById('notification-container');
        const icon = type === 'error' ? `<i data-lucide="x-circle"></i>` : `<i data-lucide="check-circle"></i>`;
        const bgColor = type === 'error' ? 'bg-red-500/90' : 'bg-cyan-500/90';
        const notif = document.createElement('div');
        notif.className = `flex items-center gap-3 px-4 py-3 text-white ${bgColor} rounded-lg shadow-2xl mb-2 animate-fade-in-out backdrop-blur-sm`;
        notif.innerHTML = `${icon}<span>${message}</span>`;
        container.appendChild(notif);
        renderIcons();
        setTimeout(() => { notif.remove(); }, 4000);
    };

    // --- Logika Inti: Generate Konten dengan AI ---
    const handleGeneration = async () => {
        const topic = document.getElementById('input-topic').value.trim();
        const problem = document.getElementById('input-problem').value.trim();
        const goal = document.getElementById('input-goal').value.trim();
        const location = document.getElementById('input-location').value.trim();
        const writingMode = document.getElementById('writing-mode').value;
        const citationStyle = document.getElementById('citation-style').value;

        if (!topic) {
            showNotification('Langkah 1 (Topik) tidak boleh kosong.', 'error');
            return;
        }

        // Tampilkan loading overlay dan nonaktifkan tombol
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        generateBtn.disabled = true;

        try {
            const prompt = `
                Anda adalah seorang asisten penulis skripsi ahli dengan gaya penulisan yang profesional dan akademis. Tugas Anda adalah membuat draf Latar Belakang Masalah untuk sebuah skripsi berdasarkan informasi berikut:

                1.  **Topik Utama:** ${topic}
                2.  **Masalah yang Diamati:** ${problem || 'Belum ditentukan secara spesifik, jelaskan masalah umum terkait topik.'}
                3.  **Tujuan Penelitian:** ${goal || 'Belum ditentukan, jelaskan tujuan umum penelitian pada topik ini.'}
                4.  **Konteks/Lokasi (jika ada):** ${location || 'Umum/Tidak spesifik.'}

                Instruksi Penulisan:
                * **Mode Penulisan:** ${writingMode}.
                * **Gaya Sitasi:** ${citationStyle}.
                * **Struktur Output:** Hasilkan teks dalam format Markdown dengan struktur wajib sebagai berikut:
                    * \`### 1. Pendahuluan\`: Pengenalan topik secara umum.
                    * \`### 2. Masalah Aktual dan Data Pendukung\`: Jelaskan masalah dengan mengintegrasikan data atau fakta relevan. Jika memungkinkan, cari dan sertakan data statistik pendukung (misalnya dari BPS, lembaga survei, atau jurnal) dan berikan sitasi palsu sesuai gaya yang diminta, contoh: (Nama Lembaga, 2024).
                    * \`### 3. Relevansi dan Kesenjangan Penelitian\`: Jelaskan mengapa topik ini penting dan apa yang belum banyak dibahas oleh penelitian sebelumnya.
                    * \`### 4. Transisi ke Rumusan Masalah\`: Tutup latar belakang dengan kalimat yang mengarah ke rumusan masalah.

                Tulis draf Latar Belakang Masalah sekarang.
            `;

            const apiKey = ""; // API Key akan di-handle oleh environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Gagal mendapat respon dari AI.');
            }

            const result = await response.json();
            const generatedText = result.candidates[0].content.parts[0].text;

            // Menggunakan Showdown.js untuk mengubah Markdown ke HTML
            const converter = new showdown.Converter({tables: true, strikethrough: true, openLinksInNewWindow: true});
            outputContent.innerHTML = converter.makeHtml(generatedText);

            // Tampilkan panel output
            outputPanel.classList.remove('hidden');
            outputPanel.classList.add('flex');

            originalityIndicator.classList.remove('hidden');
            originalityIndicator.classList.add('flex');
            showNotification('Draf latar belakang berhasil dibuat!', 'success');

        } catch (error) {
            outputContent.innerHTML = `<div class="p-4 rounded-md bg-red-900/50 border border-red-500/50 text-red-300"><h4 class="font-bold">Terjadi Kesalahan</h4><p>${error.message}</p></div>`;
            showNotification('Gagal memproses permintaan.', 'error');
        } finally {
            // Sembunyikan loading overlay dan aktifkan kembali tombol
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
            generateBtn.disabled = false;
        }
    };

    generateBtn.addEventListener('click', handleGeneration);

    // --- Event Listeners untuk Tombol Lainnya (Simulasi) ---
    document.getElementById('paraphrase-btn').addEventListener('click', () => showNotification('Fitur parafrase akan memproses ulang teks...', 'success'));
    document.getElementById('export-btn').addEventListener('click', () => showNotification('Dokumen akan diekspor dalam format yang dipilih...', 'success'));

    // Inisialisasi awal
    renderIcons();
});
</script>
{% endblock %}
