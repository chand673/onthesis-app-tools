{% extends "layout.html" %}

{% block title %}Search References - OnThesis{% endblock %}

{% block page_styles %}
<style>
    /* Utility untuk memotong teks panjang (abstract) */
    .truncate-3-lines {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <!-- Header Halaman -->
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Search References</h1>
        <p class="text-lg text-text-secondary mt-1">Temukan jutaan referensi ilmiah dari berbagai sumber terpercaya.</p>
    </header>

    <!-- Panel Pencarian dengan Gaya Baru -->
    <div class="apex-card p-6 mb-8">
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <div class="relative flex-grow w-full">
                <svg class="w-5 h-5 text-text-secondary absolute left-4 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="search-query" placeholder="Cari judul, penulis, atau kata kunci..." class="feedback-form-input w-full pl-12 pr-4 py-3">
            </div>
            <button id="search-btn" class="btn-primary w-full sm:w-auto">Cari</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <select id="source-select" class="feedback-form-input">
                <option value="core" selected>Sumber: CORE</option>
                <option value="crossref">Sumber: Crossref</option>
            </select>
            <select id="year-select" class="feedback-form-input">
                <option value="">Tahun: Semua</option>
            </select>
        </div>
        <div id="usage-counter-display" class="hidden mt-4 flex justify-center items-center gap-2 text-text-secondary text-sm font-medium px-3 py-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Sisa Pencarian Hari Ini: <strong id="search-remaining-count" class="text-text-primary">...</strong></span>
        </div>
    </div>

    <!-- Area Hasil Pencarian -->
    <div id="results-container" class="space-y-6">
         <div id="initial-message" class="text-center text-text-secondary italic py-10">
            <p>Mulai pencarian Anda untuk melihat hasilnya di sini.</p>
        </div>
    </div>
</div>

<!-- Kontainer Notifikasi (menggunakan gaya dari layout) -->
<div id="notification-container" class="fixed top-5 right-5 z-50 w-full max-w-xs"></div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- UI Elements ---
    const searchBtn = document.getElementById('search-btn');
    const searchQueryInput = document.getElementById('search-query');
    const sourceSelect = document.getElementById('source-select');
    const yearSelect = document.getElementById('year-select');
    const resultsContainer = document.getElementById('results-container');

    const fetchAndDisplayUsage = async () => {
        const display = document.getElementById('usage-counter-display');
        try {
            const response = await fetch('/api/get-usage-status');
            if (!response.ok) return;
            const data = await response.json();
            if (data.status === 'free') {
                const countEl = document.getElementById('search-remaining-count');
                countEl.textContent = `${data.search_remaining}/${data.limits['search']}`;
                display.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Gagal mengambil status kuota:", error);
        }
    };
    fetchAndDisplayUsage();

    const currentYear = new Date().getFullYear();
    for (let year = currentYear; year >= 1980; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }

    const showNotification = (message, type = 'success') => {
        const container = document.getElementById('notification-container');
        if (!container) return;
        
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
        const notif = document.createElement('div');
        notif.className = `px-4 py-3 text-white ${bgColor} rounded-lg shadow-lg mb-2 animate-fade-in-up`;
        notif.textContent = message;
        
        container.appendChild(notif);
        setTimeout(() => { notif.remove(); }, 4000);
    };

    const handleSearch = async () => {
        const query = searchQueryInput.value.trim();
        if (!query) {
            showNotification('Mohon masukkan kata kunci pencarian.', 'error');
            return;
        }

        resultsContainer.innerHTML = `<div class="flex flex-col items-center justify-center py-16"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-cyan"></div><p class="mt-4 text-text-secondary">Mencari referensi...</p></div>`;

        try {
            const response = await fetch('/api/search-references', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: sourceSelect.value, query: query, year: yearSelect.value })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Terjadi kesalahan pada server.');
            
            processAndRenderResults(data, sourceSelect.value);
            fetchAndDisplayUsage();
        } catch (error) {
            resultsContainer.innerHTML = `<div class="text-center text-red-500 py-16 px-6 apex-card"><h3 class="text-xl font-semibold">Terjadi Kesalahan</h3><p class="mt-1">${error.message}</p></div>`;
        }
    };

    const processAndRenderResults = (data, source) => {
        let results = [];
        if (source === 'core' && data.results) {
            results = data.results.map(item => ({
                id: item.id,
                title: item.title || 'Judul tidak tersedia',
                author: (item.authors || []).map(author => typeof author === 'string' ? author : author.name).filter(Boolean).join(', ') || 'Penulis tidak diketahui',
                year: item.yearPublished || 'N/A',
                journal: item.publisher || 'Publikasi tidak tersedia',
                pdfUrl: item.downloadUrl,
                doi: item.doi,
                abstract: item.abstract || 'Abstrak tidak tersedia.'
            }));
        } else if (source === 'crossref' && data.results) {
            results = data.results.map(item => ({
                id: item.DOI,
                title: (item.title && item.title.length > 0) ? item.title[0] : 'Judul tidak tersedia',
                author: (item.author || []).map(a => `${a.given || ''} ${a.family || ''}`.trim()).join(', ') || 'Penulis tidak diketahui',
                year: item.created?.['date-parts']?.[0]?.[0] || 'N/A',
                journal: (item['container-title'] && item['container-title'].length > 0) ? item['container-title'][0] : 'Publikasi tidak tersedia',
                pdfUrl: item.URL,
                doi: item.DOI,
                abstract: 'Abstrak tidak tersedia dari Crossref.'
            }));
        }
        renderResults(results);
    };

    const renderResults = (results) => {
        if (results.length === 0) {
            resultsContainer.innerHTML = `<div class="text-center text-text-secondary italic py-10 apex-card"><h3 class="text-xl font-semibold text-text-primary">Tidak Ada Hasil</h3><p class="mt-1">Coba gunakan kata kunci yang berbeda.</p></div>`;
            return;
        }

        resultsContainer.innerHTML = `<h3 class="text-xl font-semibold text-text-primary mb-4">Hasil Ditemukan (${results.length})</h3>` + 
            results.map(ref => `
            <div class="apex-card p-5">
                <a href="${ref.pdfUrl || '#'}" target="_blank" class="hover:underline"><h4 class="font-bold text-lg text-text-primary">${ref.title}</h4></a>
                <div class="text-sm text-text-secondary mt-2 space-y-1">
                    <p><span class="font-semibold text-text-secondary/80">Penulis:</span> ${ref.author}</p>
                    <p><span class="font-semibold text-text-secondary/80">Publikasi:</span> ${ref.journal} (${ref.year})</p>
                </div>
                <p class="text-sm text-text-secondary mt-3 pt-3 border-t border-border-panel truncate-3-lines">${ref.abstract}</p>
                <div class="mt-4 flex flex-wrap gap-3 items-center">
                    <button data-ref='${JSON.stringify(ref)}' class="add-to-citation-btn btn-secondary text-xs !py-1 !px-3">+ Tambah ke Sitasi</button>
                    ${ref.pdfUrl ? `<a href="${ref.pdfUrl}" target="_blank" class="btn-secondary text-xs !py-1 !px-3 flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>Lihat Sumber</a>` : ''}
                    ${ref.doi ? `<a href="https://doi.org/${ref.doi}" target="_blank" class="text-text-secondary hover:text-text-primary text-xs font-semibold py-1 px-3 rounded-md bg-white/5 dark:bg-black/10 hover:bg-white/10 dark:hover:bg-black/20 transition-colors">DOI</a>` : ''}
                </div>
            </div>`).join('');
    };
    
    const handleAddToCitation = (e) => {
        if (!e.target.classList.contains('add-to-citation-btn')) return;

        const refData = JSON.parse(e.target.dataset.ref);
        let references = JSON.parse(localStorage.getItem('onthesis_references')) || [];
        if (references.some(r => r.id && r.id === refData.id)) {
            showNotification('Referensi ini sudah ada di daftar sitasi Anda.', 'error');
            return;
        }

        references.unshift({ id: refData.id, title: refData.title, author: refData.author, year: refData.year, journal: refData.journal });
        localStorage.setItem('onthesis_references', JSON.stringify(references));
        showNotification('Referensi berhasil ditambahkan!');
        
        e.target.textContent = '✔ Ditambahkan';
        e.target.disabled = true;
        e.target.classList.remove('btn-secondary');
        e.target.classList.add('!bg-green-500/20', '!text-green-500', '!border-green-500/30', 'cursor-not-allowed');
    };

    searchBtn.addEventListener('click', handleSearch);
    searchQueryInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSearch());
    resultsContainer.addEventListener('click', handleAddToCitation);
});
</script>
{% endblock %}
