{% extends "layout.html" %}

{% block title %}Uji T (T-Test) - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Grafik & Tabel -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Pustaka untuk Export Profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    /* Mengatur lebar tabel agar auto fit */
    .spss-table {
        width: auto; 
        min-width: 600px;
        margin-left: auto;
        margin-right: auto;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
    }
    .spss-table thead .spss-title-row th {
        background-color: transparent !important;
        color: var(--text-primary) !important;
        font-size: 1.1em;
        font-weight: bold;
        padding: 10px 0;
        text-align: left;
        border: none;
        border-bottom: 2px solid var(--text-primary) !important;
    }
    .spss-table thead .spss-header-row th {
        color: var(--text-primary) !important;
        font-weight: bold;
        padding: 8px;
        border: none;
        border-bottom: 1px solid var(--border-panel) !important;
        text-align: center;
        vertical-align: middle;
    }
    .spss-table tbody td {
        padding: 8px;
        color: var(--text-secondary) !important;
        border-bottom: 1px solid var(--border-panel);
        text-align: center;
        vertical-align: middle;
    }
    .spss-table tbody td:first-child {
        text-align: left;
        font-weight: 600;
    }
    .highlight {
        color: var(--accent-cyan);
        font-weight: 600;
    }
    .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
    .tab-btn {
        padding: 0.5rem 1rem;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease-in-out;
    }
    .tab-btn.active {
        color: var(--accent-cyan);
        border-bottom-color: var(--accent-cyan);
        font-weight: 600;
    }
    .report-section {
        margin-bottom: 1.5rem;
    }
    .report-section h4 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-panel);
    }
    /* PERUBAHAN: Menghapus semua style untuk loading overlay */
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Uji T (Student's T-Test)</h1>
        <p class="text-lg text-text-secondary mt-1">Bandingkan rata-rata dua grup data untuk melihat apakah ada perbedaan yang signifikan.</p>
    </header>

    <div class="max-w-5xl mx-auto space-y-8">
        
        <!-- Kartu Input -->
        <div class="apex-card p-6 relative"> 
            <!-- PERUBAHAN: Menghapus elemen HTML loading overlay -->

            <div class="border-b border-border-panel mb-6">
                <nav class="flex justify-center -mb-px">
                    <button class="tab-btn active" data-tab="independent">Independent Samples</button>
                    <button class="tab-btn" data-tab="paired">Paired Samples</button>
                </nav>
            </div>

            <!-- Input untuk Independent T-Test -->
            <div id="independent-input" class="tab-content">
                <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Dua Grup Berbeda</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="group1_name" class="block text-sm font-medium text-text-secondary mb-1">Nama Grup 1</label>
                        <input type="text" id="group1_name" class="feedback-form-input w-full" value="Grup Kontrol">
                        <textarea id="group1_data" class="feedback-form-input mt-2" rows="8" placeholder="Masukkan data Grup 1, pisahkan dengan koma, spasi, atau baris baru..."></textarea>
                    </div>
                    <div>
                        <label for="group2_name" class="block text-sm font-medium text-text-secondary mb-1">Nama Grup 2</label>
                        <input type="text" id="group2_name" class="feedback-form-input w-full" value="Grup Eksperimen">
                        <textarea id="group2_data" class="feedback-form-input mt-2" rows="8" placeholder="Masukkan data Grup 2..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Input untuk Paired T-Test -->
            <div id="paired-input" class="tab-content hidden">
                <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Berpasangan</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="pair1_name" class="block text-sm font-medium text-text-secondary mb-1">Variabel 1 (e.g., Pre-Test)</label>
                        <input type="text" id="pair1_name" class="feedback-form-input w-full" value="Pre-Test">
                        <textarea id="pair1_data" class="feedback-form-input mt-2" rows="8" placeholder="Masukkan data Pre-Test..."></textarea>
                    </div>
                    <div>
                        <label for="pair2_name" class="block text-sm font-medium text-text-secondary mb-1">Variabel 2 (e.g., Post-Test)</label>
                        <input type="text" id="pair2_name" class="feedback-form-input w-full" value="Post-Test">
                        <textarea id="pair2_data" class="feedback-form-input mt-2" rows="8" placeholder="Masukkan data Post-Test..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border-panel">
                <div class="flex flex-col md:flex-row gap-4 items-end justify-center">
                    <div class="w-full md:w-48">
                        <label for="confidence-level" class="block text-sm font-medium text-text-secondary mb-1 text-center">Confidence Interval (%)</label>
                        <input type="number" id="confidence-level" class="feedback-form-input w-full text-center" value="95" min="1" max="99">
                    </div>
                    <button id="runAnalysis" class="btn-primary w-full md:w-auto flex-grow md:flex-grow-0">Jalankan Analisis Uji T</button>
                </div>
                 <div class="text-center mt-4">
                    <button id="loadSample" class="btn-secondary text-sm">Muat Contoh Data</button>
                </div>
            </div>
        </div>

        <!-- Kontainer Output -->
        <div id="resultCard" class="space-y-8" style="display:none;">
            <div class="apex-card p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h3 class="text-xl font-bold text-text-primary">2. Hasil Analisis</h3>
                    <div class="flex gap-2 items-center">
                        <button id="export-pdf-btn" class="btn-secondary text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            <span class="btn-text">PDF</span>
                        </button>
                        <button id="export-doc-btn" class="btn-secondary text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4.5V20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4.5M16 4.5h-4a2 2 0 0 0-2 2v0a2 2 0 0 0 2 2h4M16 4.5V2M8 13h8M8 17h8"></path></svg>
                            <span class="btn-text">DOC</span>
                        </button>
                        <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
                
                <div id="professional-report">
                    <!-- Akan diisi oleh JavaScript -->
                </div>
                
                <div class="mt-8 border-t border-border-panel pt-6">
                    <h4 class="text-lg font-bold text-text-primary mb-2">Interpretasi AI</h4>
                    <button id="interpretBtn" class="btn-secondary w-full mb-4 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                        <span class="btn-text">Jelaskan Laporan Ini</span>
                        <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <div id="interpretationOutput" class="prose prose-sm max-w-none text-text-secondary dark:prose-invert bg-bg-canvas p-4 rounded-lg border border-border-panel" style="display: none;"></div>
                </div>
            </div>

            <div class="apex-card p-6">
                <h3 class="text-xl font-bold text-text-primary mb-4 text-center">3. Visualisasi Data</h3>
                <div id="plot" class="w-full h-96"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    let activeTest = 'independent';
    let analysisResult = null;

    // --- Logika UI ---
    $('.tab-btn').on('click', function() {
        $('.tab-btn').removeClass('active');
        $(this).addClass('active');
        activeTest = $(this).data('tab');

        $('.tab-content').addClass('hidden');
        $(`#${activeTest}-input`).removeClass('hidden');
        $('#resultCard').hide();
    });

    $('#loadSample').click(() => {
        if (activeTest === 'independent') {
            $('#group1_data').val('8, 7, 9, 6, 8, 7, 9, 10, 5, 7');
            $('#group2_data').val('10, 9, 11, 8, 9, 10, 12, 11, 8, 9');
        } else {
            $('#pair1_data').val('65, 70, 75, 80, 85, 90, 95, 100, 105, 110');
            $('#pair2_data').val('60, 65, 70, 75, 80, 85, 90, 95, 100, 105');
        }
    });

    // --- Logika Analisis ---
    $('#runAnalysis').click(async function() {
        $('textarea').removeClass('input-error');
        let hasError = false;
        let payload = {};
        const confidenceLevel = $('#confidence-level').val();
        const button = $(this);

        if (activeTest === 'independent') {
            const group1_data = $('#group1_data').val().trim().split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            const group2_data = $('#group2_data').val().trim().split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));

            if (group1_data.length < 3) { $('#group1_data').addClass('input-error'); hasError = true; }
            if (group2_data.length < 3) { $('#group2_data').addClass('input-error'); hasError = true; }
            
            payload = { 
                groups: [group1_data, group2_data],
                confidence_level: confidenceLevel
            };
        } else { // Paired
            const pair1_data = $('#pair1_data').val().trim().split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            const pair2_data = $('#pair2_data').val().trim().split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            
            if (pair1_data.length < 3) { $('#pair1_data').addClass('input-error'); hasError = true; }
            if (pair2_data.length < 3) { $('#pair2_data').addClass('input-error'); hasError = true; }
            if (pair1_data.length !== pair2_data.length) {
                alert('Untuk Paired Samples T-Test, jumlah data di kedua grup harus sama.');
                $('#pair1_data, #pair2_data').addClass('input-error');
                return;
            }
            payload = { 
                pairs: [pair1_data, pair2_data],
                confidence_level: confidenceLevel
            };
        }

        if (hasError) {
            alert('Setiap grup harus memiliki minimal 3 data poin. Grup yang bermasalah telah ditandai.');
            return;
        }
        
        button.prop('disabled', true).text('Menganalisis...');
        $('#interpretationOutput').hide().empty();
        $('#professional-report').empty();

        try {
            const response = await fetch(`/api/${activeTest}-ttest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Terjadi kesalahan pada server.');
            }

            analysisResult = await response.json();
            displayProfessionalResults(analysisResult);
            $('#resultCard').slideDown();

        } catch (e) {
            alert('Error: ' + e.message);
        } finally {
            button.prop('disabled', false).text('Jalankan Analisis Uji T');
        }
    });

    function displayProfessionalResults(data) {
        const container = $('#professional-report');
        const ci_level = $('#confidence-level').val();
        let reportHtml = '';

        if (activeTest === 'independent') {
            const group1Name = $('#group1_name').val() || 'Grup 1';
            const group2Name = $('#group2_name').val() || 'Grup 2';
            const levene = data.independent_test.levene;
            
            reportHtml = `
                <div class="report-section">
                    <h4>Ringkasan Hasil</h4>
                    <div class="text-text-secondary mb-6 p-4 bg-bg-canvas rounded-lg border border-border-panel">
                        <p>${data.summary}</p>
                    </div>
                </div>
                <div class="report-section">
                    <h4>Hipotesis Penelitian</h4>
                    <ul class="list-disc list-inside text-text-secondary space-y-1">
                        <li><b>Hipotesis Nol (H₀):</b> Tidak terdapat perbedaan rata-rata yang signifikan antara ${group1Name} dan ${group2Name}.</li>
                        <li><b>Hipotesis Alternatif (H₁):</b> Terdapat perbedaan rata-rata yang signifikan antara ${group1Name} dan ${group2Name}.</li>
                    </ul>
                </div>
                <div class="report-section">
                    <h4>Statistik Deskriptif</h4>
                    <div class="overflow-x-auto">
                        <table class="spss-table">
                            <thead><tr class="spss-title-row"><th colspan="4">Group Statistics</th></tr>
                            <tr class="spss-header-row"><th>Grup</th><th>N</th><th>Mean</th><th>Std. Deviation</th></tr></thead>
                            <tbody>
                                <tr><td>${group1Name}</td><td>${data.group_stats[0].N}</td><td>${data.group_stats[0].mean.toFixed(3)}</td><td>${data.group_stats[0].std.toFixed(3)}</td></tr>
                                <tr><td>${group2Name}</td><td>${data.group_stats[1].N}</td><td>${data.group_stats[1].mean.toFixed(3)}</td><td>${data.group_stats[1].std.toFixed(3)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="report-section">
                    <h4>Hasil Uji Independent Samples T-Test</h4>
                     <div class="overflow-x-auto">
                        <table class="spss-table">
                            <thead>
                                <tr class="spss-title-row"><th colspan="9">Independent Samples Test</th></tr>
                                <tr class="spss-header-row">
                                    <th rowspan="2" style="vertical-align: middle;"></th>
                                    <th colspan="2">Levene's Test</th>
                                    <th colspan="6">t-test for Equality of Means</th>
                                </tr>
                                <tr class="spss-header-row">
                                    <th>F</th><th>Sig.</th><th>t</th><th>df</th><th>Sig. (2-tailed)</th><th>Mean Difference</th><th colspan="2">${ci_level}% CI of the Difference</th>
                                </tr>
                                 <tr class="spss-header-row" style="font-size: 0.8em;">
                                    <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th>Lower</th><th>Upper</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Equal variances assumed</td>
                                    <td>${levene.F.toFixed(3)}</td>
                                    <td>${levene.p.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_equal_variances.t.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_equal_variances.df}</td>
                                    <td class="${data.independent_test.ttest_equal_variances.p < 0.05 ? 'highlight' : ''}">${data.independent_test.ttest_equal_variances.p.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_equal_variances.mean_diff.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_equal_variances.ci_lower.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_equal_variances.ci_upper.toFixed(3)}</td>
                                </tr>
                                <tr>
                                    <td>Equal variances not assumed</td>
                                    <td></td><td></td>
                                    <td>${data.independent_test.ttest_unequal_variances.t.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_unequal_variances.df.toFixed(3)}</td>
                                    <td class="${data.independent_test.ttest_unequal_variances.p < 0.05 ? 'highlight' : ''}">${data.independent_test.ttest_unequal_variances.p.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_unequal_variances.mean_diff.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_unequal_variances.ci_lower.toFixed(3)}</td>
                                    <td>${data.independent_test.ttest_unequal_variances.ci_upper.toFixed(3)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const plotData = [{
                x: [group1Name, group2Name],
                y: data.group_stats.map(s => s.mean),
                error_y: {
                    type: 'data',
                    array: data.group_stats.map(s => (s.ci_upper - s.ci_lower) / 2),
                    visible: true
                },
                type: 'bar',
                marker: { color: ['#0284c7', '#f59e0b'] }
            }];
            Plotly.newPlot('plot', plotData, getPlotlyLayout(`Perbandingan Rata-rata Grup (${ci_level}% CI)`));

        } else { // Paired
            const pair1Name = $('#pair1_name').val() || 'Variabel 1';
            const pair2Name = $('#pair2_name').val() || 'Variabel 2';
            const corr = data.paired_correlation;
            const test = data.paired_test;

            reportHtml = `
                <div class="report-section">
                    <h4>Ringkasan Hasil</h4>
                    <div class="text-text-secondary mb-6 p-4 bg-bg-canvas rounded-lg border border-border-panel">
                        <p>${data.summary}</p>
                    </div>
                </div>
                <div class="report-section">
                    <h4>Hipotesis Penelitian</h4>
                    <ul class="list-disc list-inside text-text-secondary space-y-1">
                        <li><b>Hipotesis Nol (H₀):</b> Tidak terdapat perbedaan rata-rata yang signifikan antara ${pair1Name} dan ${pair2Name}.</li>
                        <li><b>Hipotesis Alternatif (H₁):</b> Terdapat perbedaan rata-rata yang signifikan antara ${pair1Name} dan ${pair2Name}.</li>
                    </ul>
                </div>
                <div class="report-section">
                    <h4>Statistik Deskriptif</h4>
                    <div class="overflow-x-auto">
                        <table class="spss-table">
                            <thead><tr class="spss-title-row"><th colspan="4">Paired Samples Statistics</th></tr>
                            <tr class="spss-header-row"><th>Variabel</th><th>N</th><th>Mean</th><th>Std. Deviation</th></tr></thead>
                            <tbody>
                                <tr><td>${pair1Name}</td><td>${data.paired_stats[0].N}</td><td>${data.paired_stats[0].mean.toFixed(3)}</td><td>${data.paired_stats[0].std.toFixed(3)}</td></tr>
                                <tr><td>${pair2Name}</td><td>${data.paired_stats[1].N}</td><td>${data.paired_stats[1].mean.toFixed(3)}</td><td>${data.paired_stats[1].std.toFixed(3)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="report-section">
                    <h4>Korelasi Antar Variabel</h4>
                    <div class="overflow-x-auto">
                        <table class="spss-table">
                            <thead><tr class="spss-title-row"><th colspan="4">Paired Samples Correlations</th></tr>
                            <tr class="spss-header-row"><th>Pasangan</th><th>N</th><th>Correlation</th><th>Sig.</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td>${pair1Name} & ${pair2Name}</td>
                                    <td>${data.paired_stats[0].N}</td>
                                    <td>${corr.r.toFixed(3)}</td>
                                    <td class="${corr.p < 0.05 ? 'highlight' : ''}">${corr.p.toFixed(3)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="report-section">
                    <h4>Hasil Uji Paired Samples T-Test</h4>
                    <div class="overflow-x-auto">
                        <table class="spss-table">
                             <thead>
                                <tr class="spss-title-row"><th colspan="7">Paired Samples Test</th></tr>
                                <tr class="spss-header-row">
                                    <th rowspan="2" style="vertical-align: middle;">Pasangan</th>
                                    <th colspan="3">Paired Differences</th>
                                    <th rowspan="2" style="vertical-align: middle;">t</th>
                                    <th rowspan="2" style="vertical-align: middle;">df</th>
                                    <th rowspan="2" style="vertical-align: middle;">Sig. (2-tailed)</th>
                                </tr>
                                <tr class="spss-header-row">
                                    <th>Mean</th><th>Std. Dev</th><th>${ci_level}% CI (Lower-Upper)</th>
                                </tr>
                            </thead>
                            <tbody><tr>
                                <td>${pair1Name} - ${pair2Name}</td>
                                <td>${test.mean_diff.toFixed(3)}</td>
                                <td>${test.std_diff.toFixed(3)}</td>
                                <td>${test.ci_lower.toFixed(3)} - ${test.ci_upper.toFixed(3)}</td>
                                <td>${test.t.toFixed(3)}</td>
                                <td>${test.df}</td>
                                <td class="${test.p < 0.05 ? 'highlight' : ''}">${test.p.toFixed(3)}</td>
                            </tr></tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const plotData = [{
                x: [pair1Name, pair2Name],
                y: data.paired_stats.map(s => s.mean),
                type: 'bar',
                marker: { color: ['#0284c7', '#f59e0b'] }
            }];
            Plotly.newPlot('plot', plotData, getPlotlyLayout('Perbandingan Rata-rata Variabel Berpasangan'));
        }
        container.html(reportHtml);
    }

    // --- Logika Interpretasi & Ekspor (DIPERBARUI) ---
    $('#interpretBtn').click(function() {
        if (!analysisResult) return;
        const btn = $(this);
        const btnText = btn.find('.btn-text');
        const spinner = btn.find('.spinner');

        btnText.text('Menganalisis...');
        spinner.removeClass('hidden');
        btn.prop('disabled', true);

        // Membuat ringkasan teks yang bersih untuk AI
        let analysisSummaryForAI = `Jenis Uji: ${activeTest} Samples T-Test.\n`;
        analysisSummaryForAI += `Kesimpulan Awal: ${analysisResult.summary}\n\n`;
        if (activeTest === 'independent') {
            analysisSummaryForAI += "Statistik Grup:\n";
            analysisResult.group_stats.forEach(s => {
                analysisSummaryForAI += `- ${s.group}: N=${s.N}, Mean=${s.mean.toFixed(3)}, Std.Dev=${s.std.toFixed(3)}\n`;
            });
            analysisSummaryForAI += "\nHasil Uji T Independent:\n";
            const t_test = analysisResult.independent_test.levene.p > 0.05 ? analysisResult.independent_test.ttest_equal_variances : analysisResult.independent_test.ttest_unequal_variances;
            analysisSummaryForAI += `- Levene's Test p-value: ${analysisResult.independent_test.levene.p.toFixed(3)}\n`;
            analysisSummaryForAI += `- t-value: ${t_test.t.toFixed(3)}, df: ${t_test.df.toFixed(3)}, p-value: ${t_test.p.toFixed(3)}\n`;
            analysisSummaryForAI += `- Mean Difference: ${t_test.mean_diff.toFixed(3)}\n`;
            analysisSummaryForAI += `- ${$('#confidence-level').val()}% CI: [${t_test.ci_lower.toFixed(3)}, ${t_test.ci_upper.toFixed(3)}]\n`;
        } else {
            analysisSummaryForAI += "Statistik Berpasangan:\n";
            analysisResult.paired_stats.forEach(s => {
                analysisSummaryForAI += `- ${s.variable}: N=${s.N}, Mean=${s.mean.toFixed(3)}, Std.Dev=${s.std.toFixed(3)}\n`;
            });
            const test = analysisResult.paired_test;
            analysisSummaryForAI += "\nHasil Uji T Berpasangan:\n";
            analysisSummaryForAI += `- t-value: ${test.t.toFixed(3)}, df: ${test.df}, p-value: ${test.p.toFixed(3)}\n`;
            analysisSummaryForAI += `- Mean Difference: ${test.mean_diff.toFixed(3)}\n`;
            analysisSummaryForAI += `- ${$('#confidence-level').val()}% CI: [${test.ci_lower.toFixed(3)}, ${test.ci_upper.toFixed(3)}]\n`;
        }
        
        const prompt = `Anda adalah seorang ahli statistik. Berikan interpretasi profesional untuk ringkasan hasil Uji T berikut dalam format HTML (gunakan <h4>, <p>, <ul>, <li>, <strong>). Jelaskan statistik deskriptif, hasil uji asumsi (jika ada), dan hasil uji T utama. Fokus pada arti nilai p-value (Sig.), nilai t, dan confidence interval. Tarik kesimpulan akhir apakah ada perbedaan yang signifikan atau tidak. Berikut adalah ringkasan hasilnya:\n\n${analysisSummaryForAI}`;

        $.ajax({
            url: "{{ url_for('interpret_analysis') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stats: prompt }),
            success: (res) => $('#interpretationOutput').html(res.interpretation).show(),
            error: (err) => $('#interpretationOutput').html(`<p class="text-red-400">Gagal mendapatkan interpretasi: ${err.responseJSON ? err.responseJSON.error : 'Error'}</p>`).show(),
            complete: () => {
                btnText.text('Jelaskan Laporan Ini');
                spinner.addClass('hidden');
                btn.prop('disabled', false);
            }
        });
    });

    const loadImageAsBase64 = (url) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = reject;
            img.src = url;
        });
    };

    const exportHandler = async (format) => {
        if (!analysisResult) return;
        const btn = $(`#export-${format}-btn`);
        const spinner = btn.siblings('.spinner').first();
        btn.prop('disabled', true);
        spinner.removeClass('hidden');

        try {
            const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-black.png') }}";
            const logoData = await loadImageAsBase64(logoUrl);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                let yPos = 25;
                const title = `Laporan ${activeTest === 'independent' ? 'Independent' : 'Paired'} Samples T-Test`;

                const addHeader = (docInstance) => {
                    const pageWidth = docInstance.internal.pageSize.width;
                    docInstance.addImage(logoData, 'PNG', pageWidth - 15 - 30, 10, 30, 8);
                };

                addHeader(doc);
                doc.setFontSize(18);
                doc.text(title, 105, 25, { align: 'center' });
                yPos = 40;
                
                const sections = $('#professional-report .report-section');
                sections.each(function() {
                    if (yPos > 250) { doc.addPage(); addHeader(doc); yPos = 25; }
                    const sectionTitle = $(this).find('h4').text();
                    const contentP = $(this).find('p').text();
                    const contentUl = $(this).find('ul li');
                    const table = $(this).find('table').get(0);

                    doc.setFontSize(14);
                    doc.text(sectionTitle, 15, yPos);
                    yPos += 8;

                    if (contentP) {
                        const splitText = doc.splitTextToSize(contentP, 180);
                        doc.setFontSize(10);
                        doc.text(splitText, 15, yPos);
                        yPos += (splitText.length * 4) + 5;
                    }
                    if (contentUl.length > 0) {
                        contentUl.each(function() {
                            const liText = $(this).text();
                            doc.setFontSize(10);
                            doc.text(`- ${liText}`, 18, yPos);
                            yPos += 5;
                        });
                        yPos += 5;
                    }
                    if (table) {
                        doc.autoTable({ 
                            html: table, 
                            startY: yPos,
                            theme: 'grid',
                            headStyles: { fillColor: [2, 132, 199], textColor: [255, 255, 255] }
                        });
                        yPos = doc.autoTable.previous.finalY + 10;
                    }
                });
                
                const plotImg = await Plotly.toImage('plot', {format: 'png', width: 800, height: 450});
                if (yPos > 190) { doc.addPage(); addHeader(doc); yPos = 25; }
                doc.setFontSize(14);
                doc.text("Visualisasi Data", 15, yPos);
                yPos += 8;
                doc.addImage(plotImg, 'PNG', 15, yPos, 180, 101);

                doc.save(`hasil-uji-t-${activeTest}-onthesis.pdf`);
            } else if (format === 'doc') {
                const reportHtml = $('#professional-report').html();
                const plotImg = await Plotly.toImage('plot', {format: 'png', width: 800, height: 450});
                let content = `
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; }
                        h4 { font-size: 14pt; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: left; vertical-align: top; }
                        th { font-weight: bold; background-color: #E0E0E0; }
                    </style>
                    <h1>Laporan Uji T</h1>
                    ${reportHtml}
                    <h3>Visualisasi</h3><img src="${plotImg}" style="width:500px; height:auto;" />
                `;
                saveAs(htmlDocx.asBlob(content), `hasil-uji-t-${activeTest}-onthesis.doc`);
            }
        } catch (e) {
            console.error("Gagal mengekspor:", e);
            alert("Terjadi kesalahan saat mengekspor file.");
        } finally {
            btn.prop('disabled', false);
            spinner.addClass('hidden');
        }
    };

    $('#export-pdf-btn').on('click', () => exportHandler('pdf'));
    $('#export-doc-btn').on('click', () => exportHandler('doc'));

    const getPlotlyLayout = (title) => {
        const isLight = document.documentElement.classList.contains('light');
        return {
            title: { text: title, font: { color: isLight ? '#181C32' : '#E6EDF3' } },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: isLight ? '#5E6278' : '#8B949E' },
            xaxis: { gridcolor: isLight ? '#DEE2E6' : '#30363D' },
            yaxis: { gridcolor: isLight ? '#DEE2E6' : '#30363D' }
        };
    };
});
</script>
{% endblock %}
