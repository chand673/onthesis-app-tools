{% extends "layout.html" %}

{% block title %}Uji Homogenitas - OnThesis{% endblock %}

{% block page_styles %}
<!-- Pustaka untuk Grafik & Tabel -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- Pustaka untuk Export Profesional -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    /* Penyesuaian Gaya DataTable agar sesuai Tema */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        color: var(--text-secondary) !important;
        font-size: 0.875rem;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: var(--text-secondary) !important;
        border-color: var(--border-panel) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        background: var(--accent-cyan) !important;
        color: white !important;
        border-color: var(--accent-cyan) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: var(--bg-canvas) !important;
        border-color: var(--border-panel) !important;
    }
    table.dataTable.no-footer {
        border-bottom-color: var(--border-panel) !important;
    }
    /* Gaya Tabel SPSS */
    table.dataTable thead {
        background-color: var(--accent-cyan);
    }
    table.dataTable thead th {
        color: white !important;
        border-bottom: 1px solid var(--accent-cyan) !important;
    }
    table.dataTable tbody tr {
        background-color: transparent !important;
    }
    table.dataTable tbody tr:hover {
        background-color: var(--bg-canvas) !important;
    }
    table.dataTable tbody td {
        color: var(--text-secondary) !important;
    }
    .highlight {
        color: var(--accent-cyan);
        font-weight: 600;
    }
    /* Gaya untuk menandai input yang error */
    .input-error {
        border-color: #ef4444 !important; /* Warna merah */
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-text-primary">Uji Homogenitas Varians</h1>
        <p class="text-lg text-text-secondary mt-1">Lakukan Levene's Test atau Bartlett's Test untuk membandingkan varians antar grup.</p>
    </header>

    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- Kartu Input -->
        <div class="apex-card p-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 text-center">1. Input Data Grup</h3>
            <p class="text-sm text-text-secondary mb-4 max-w-2xl mx-auto text-center">Masukkan data untuk setiap grup dan berikan nama yang sesuai.</p>
            
            <div id="groupsContainer" class="space-y-4 text-left">
                <!-- Grup data dinamis -->
            </div>

            <div class="flex flex-wrap gap-4 mt-4 pt-4 border-t border-border-panel">
                <button id="addGroup" class="btn-secondary flex-1">+ Tambah Grup</button>
                <button id="loadSample" class="btn-secondary flex-1">Muat Contoh</button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-border-panel">
                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <select id="ujiSelector" class="feedback-form-input md:w-auto">
                        <option value="levene">Levene's Test</option>
                        <option value="bartlett">Bartlett's Test</option>
                    </select>
                    <button id="runAnalysis" class="btn-primary w-full md:w-auto">Jalankan Analisis</button>
                </div>
                <p class="text-xs text-text-secondary text-center mt-4">
                    <strong>Levene's Test</strong> lebih robust untuk data yang tidak berdistribusi normal. 
                    <strong>Bartlett's Test</strong> lebih sensitif tetapi mensyaratkan data berdistribusi normal.
                </p>
            </div>
        </div>

        <!-- Kontainer Output -->
        <div id="resultCard" class="space-y-8" style="display:none;">
            <div class="apex-card p-6">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h3 class="text-xl font-bold text-text-primary">2. Hasil Uji Homogenitas</h3>
                    <div class="flex gap-2">
                        <button id="export-pdf-btn" class="btn-secondary text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            <span class="btn-text">Export PDF</span>
                        </button>
                        <button id="export-doc-btn" class="btn-secondary text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4.5V20a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4.5M16 4.5h-4a2 2 0 0 0-2 2v0a2 2 0 0 0 2 2h4M16 4.5V2M8 13h8M8 17h8"></path></svg>
                            <span class="btn-text">Export DOC</span>
                        </button>
                        <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
                <div id="summaryText" class="text-text-secondary mb-4 p-4 bg-bg-canvas rounded-lg border border-border-panel"></div>
                <h4 class="text-md font-bold text-text-primary mb-2">Test of Homogeneity of Variances</h4>
                <table id="resultTable" class="display" style="width:100%">
                    <!-- Header akan diisi oleh JavaScript -->
                </table>
                <div class="text-sm text-text-secondary mt-4" id="metaInfo"></div>
                
                <!-- Fitur Interpretasi AI -->
                <div class="mt-6 border-t border-border-panel pt-6">
                    <h4 class="text-lg font-bold text-text-primary mb-2">Interpretasi AI</h4>
                    <button id="interpretBtn" class="btn-secondary w-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent-cyan"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                        <span class="btn-text">Jelaskan Hasil Ini</span>
                        <div class="spinner hidden ml-2 w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <div id="interpretationOutput" class="prose prose-sm max-w-none text-text-secondary dark:prose-invert bg-bg-canvas p-4 rounded-lg border border-border-panel" style="display: none;"></div>
                </div>
            </div>

            <div class="apex-card p-6">
                <h3 class="text-xl font-bold text-text-primary mb-4 text-center">3. Visualisasi Data</h3>
                <div id="plots" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="boxplot" class="w-full h-96"></div>
                    <div id="violinplot" class="w-full h-96"></div>
                </div>
            </div>
        </div>
        <!-- Elemen tersembunyi untuk ekspor DOC -->
        <div id="exportContent" class="hidden"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    const groupsContainer = $('#groupsContainer');
    let dataTable = null;
    let analysisResult = null;
    let groupDataForPlots = [];

    function createGroup(name = '', data = '') {
        const groupCount = groupsContainer.children().length + 1;
        const groupName = name || `Grup ${groupCount}`;
        const groupHtml = `
            <div class="data-group p-4 border border-border-panel rounded-lg bg-bg-canvas">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" class="bg-transparent font-semibold text-text-primary focus:outline-none w-full group-name-input" value="${groupName}" placeholder="Nama Grup">
                    <button class="text-text-secondary hover:text-red-400 remove-group-btn text-xl font-bold">&times;</button>
                </div>
                <textarea class="feedback-form-input data-input" placeholder="Masukkan data dipisah koma, spasi, atau baris baru...">${data}</textarea>
            </div>
        `;
        groupsContainer.append(groupHtml);
    }

    function resetGroups(count = 2) {
        groupsContainer.empty();
        for (let i = 0; i < count; i++) {
            createGroup();
        }
    }
    
    function getPlotlyLayout(title, forExport = false) {
        const isLight = document.documentElement.classList.contains('light');
        const titleColor = forExport ? '#000000' : (isLight ? '#181C32' : '#E6EDF3');
        const textColor = forExport ? '#000000' : (isLight ? '#5E6278' : '#8B949E');
        const gridColor = forExport ? '#cccccc' : (isLight ? '#DEE2E6' : '#30363D');

        return {
            title: { text: title, font: { color: titleColor } },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: textColor },
            xaxis: { gridcolor: gridColor, zerolinecolor: gridColor },
            yaxis: { gridcolor: gridColor, zerolinecolor: gridColor }
        };
    }

    $('#addGroup').click(() => createGroup());
    groupsContainer.on('click', '.remove-group-btn', function() {
        if (groupsContainer.children().length > 2) {
            $(this).closest('.data-group').remove();
        } else {
            alert('Minimal harus ada 2 grup.');
        }
    });

    $('#loadSample').click(() => {
        groupsContainer.empty();
        createGroup('Kelas A', '22, 23, 25, 24, 23, 26, 28');
        createGroup('Kelas B', '18, 19, 23, 24, 25, 21, 20');
        createGroup('Kelas C', '29, 31, 33, 32, 34, 28, 30');
    });

    $('#runAnalysis').click(async function() {
        $('.data-input').removeClass('input-error');
        let hasError = false;
        let validGroups = [];
        groupDataForPlots = [];

        $('.data-group').each(function(index) {
            const groupEl = $(this);
            const name = groupEl.find('.group-name-input').val().trim();
            const textarea = groupEl.find('.data-input');
            const rawData = textarea.val().trim();
            
            if (rawData === '' && name === `Grup ${index + 1}`) return;

            const values = rawData.split(/[ ,\n\t;]+/).map(Number).filter(x => !isNaN(x));
            
            if (values.length < 2) {
                hasError = true;
                textarea.addClass('input-error');
            } else {
                validGroups.push(values);
                groupDataForPlots.push({ name: name || `Grup ${index + 1}`, values: values });
            }
        });

        if (hasError) {
            alert('Setiap grup yang diisi harus memiliki minimal 2 data poin. Grup yang bermasalah telah ditandai dengan warna merah.');
            return;
        }

        if (validGroups.length < 2) {
            alert('Analisis memerlukan minimal 2 grup data yang valid.');
            return;
        }

        const uji = $('#ujiSelector').val();
        const button = $(this);
        button.prop('disabled', true).text('Menganalisis...');
        $('#interpretationOutput').hide().empty();

        try {
            const response = await fetch(`/api/${uji}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ groups: validGroups })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Terjadi kesalahan pada server.');
            }

            analysisResult = await response.json();
            
            $('#resultCard').slideDown();
            $('#summaryText').html(`<strong>Interpretasi:</strong> ${analysisResult.summary || ''}`);
            
            if (dataTable) {
                dataTable.destroy();
            }
            const statisticName = uji === 'levene' ? 'Levene Statistic' : 'Bartlett Statistic';
            $('#resultTable').html(`
                <thead>
                    <tr>
                        <th></th>
                        <th>${statisticName}</th>
                        <th>df1</th>
                        <th>df2</th>
                        <th>Sig.</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `);

            dataTable = $('#resultTable').DataTable({
                paging: false, searching: false, info: false, ordering: false
            });
            
            (analysisResult.table || []).forEach(r => {
                const pValue = (typeof r.p === 'number') ? r.p : parseFloat(r.p);
                const pCell = pValue < 0.05 ? `<span class='highlight'>${pValue.toFixed(4)}</span>` : pValue.toFixed(4);
                dataTable.row.add(['', Number(r.statistic).toFixed(4), r.df1 ?? '', r.df2 ?? '', pCell]);
            });
            dataTable.draw();

            $('#metaInfo').html(`<b>Jumlah data per grup:</b> ${validGroups.map(g => g.length).join(' &middot; ')}`);

            const boxTraces = groupDataForPlots.map(g => ({ y: g.values, type: 'box', name: g.name, boxpoints: 'all', jitter: 0.3, pointpos: -1.8 }));
            Plotly.newPlot('boxplot', boxTraces, getPlotlyLayout('Box Plot Sebaran Data per Grup'));

            const violinTraces = groupDataForPlots.map(g => ({ y: g.values, type: 'violin', name: g.name, box: { visible: true }, meanline: { visible: true } }));
            Plotly.newPlot('violinplot', violinTraces, getPlotlyLayout('Violin Plot Sebaran Data per Grup'));

        } catch (e) {
            alert('Error: ' + e.message);
        } finally {
            button.prop('disabled', false).text('Jalankan Analisis');
        }
    });

    $('#interpretBtn').click(function() {
        if (!analysisResult) {
            alert("Lakukan analisis terlebih dahulu.");
            return;
        }
        const btn = $(this);
        const btnText = btn.find('.btn-text');
        const spinner = btn.find('.spinner');

        btnText.text('Menganalisis...');
        spinner.removeClass('hidden');
        btn.prop('disabled', true);

        const testResult = analysisResult.table[0];
        const prompt = `
            Anda adalah seorang ahli statistik. Berikan interpretasi profesional untuk hasil uji homogenitas berikut.

            **Data Hasil:**
            - **Nama Uji:** ${testResult.test}
            - **Nilai Statistik:** ${testResult.statistic}
            - **P-value (Sig.):** ${testResult.p}
            - **Kesimpulan Awal:** ${analysisResult.summary}

            **Tugas Anda:**
            1.  **Jelaskan Hasil Uji:** Terangkan apa arti dari nilai p-value yang didapat. Bandingkan dengan tingkat signifikansi (alpha = 0.05). Tarik kesimpulan apakah hipotesis nol (yang menyatakan varians antar grup adalah sama/homogen) ditolak atau gagal ditolak.
            2.  **Jelaskan Konsep Uji:** Berikan penjelasan singkat mengenai tujuan dari ${testResult.test} dan mengapa uji homogenitas ini penting dalam analisis statistik (misalnya, sebagai asumsi untuk ANOVA).
            3.  **Interpretasi Visual:** Jelaskan secara singkat bagaimana cara membaca visualisasi yang menyertainya:
                - **Box Plot:** Bagaimana perbandingan tinggi dan sebaran kotak (interquartile range) antar grup dapat memberikan petunjuk visual tentang homogenitas varians.
                - **Violin Plot:** Bagaimana bentuk 'violin' yang serupa lebarnya antar grup mengindikasikan varians yang homogen.
            
            Gunakan format yang rapi menggunakan elemen HTML seperti <h4>, <p>, <ul>, <li>, dan <strong> untuk menyorot poin-poin penting. Jangan sertakan tag <html>, <body>, atau \`\`\`html.
        `;

        $.ajax({
            url: "{{ url_for('interpret_analysis') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stats: prompt }),
            success: function(res) {
                const cleanedHtml = res.interpretation.replace(/^```html\s*|```\s*$/g, '').trim();
                $('#interpretationOutput').html(cleanedHtml).show();
            },
            error: function(err) {
                $('#interpretationOutput').html(`<p class="text-red-400">Gagal mendapatkan interpretasi: ${err.responseJSON ? err.responseJSON.error : 'Error'}</p>`).show();
            },
            complete: function() {
                btnText.text('Jelaskan Hasil Ini');
                spinner.addClass('hidden');
                btn.prop('disabled', false);
            }
        });
    });

    // Fungsi untuk memuat gambar sebagai base64
    const loadImageAsBase64 = (url) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = reject;
            img.src = url;
        });
    };

    const exportHandler = async (format) => {
        const btn = $(`#export-${format}-btn`);
        const spinner = btn.siblings('.spinner').first();
        btn.prop('disabled', true);
        spinner.removeClass('hidden');

        try {
            const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-blue.png') }}";
            const logoData = await loadImageAsBase64(logoUrl);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                let yPos = 15;

                const addHeader = () => {
                    doc.addImage(logoData, 'PNG', 15, 10, 30, 8);
                };

                addHeader();
                doc.setFontSize(18);
                doc.text("Laporan Uji Homogenitas - OnThesis", 105, 25, { align: 'center' });
                yPos = 40;

                doc.setFontSize(12);
                const summary = $('#summaryText').text();
                const splitSummary = doc.splitTextToSize(summary, 180);
                doc.text(splitSummary, 15, yPos);
                yPos += (splitSummary.length * 5) + 5;
                
                doc.autoTable({ 
                    html: '#resultTable', 
                    startY: yPos,
                    theme: 'grid',
                    headStyles: { fillColor: [2, 132, 199], textColor: [255, 255, 255] }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                const boxplotLayout = getPlotlyLayout('Box Plot Sebaran Data per Grup', true);
                const violinplotLayout = getPlotlyLayout('Violin Plot Sebaran Data per Grup', true);
                
                await Plotly.relayout('boxplot', boxplotLayout);
                await Plotly.relayout('violinplot', violinplotLayout);

                const boxplotImg = await Plotly.toImage('boxplot', {format: 'png', width: 800, height: 500});
                const violinplotImg = await Plotly.toImage('violinplot', {format: 'png', width: 800, height: 500});
                
                await Plotly.relayout('boxplot', getPlotlyLayout('Box Plot Sebaran Data per Grup'));
                await Plotly.relayout('violinplot', getPlotlyLayout('Violin Plot Sebaran Data per Grup'));

                if (yPos > 160) { doc.addPage(); addHeader(); yPos = 25; }
                doc.setFontSize(14);
                doc.text("Visualisasi Data", 15, yPos);
                yPos += 8;
                doc.addImage(boxplotImg, 'PNG', 15, yPos, 85, 53);
                doc.addImage(violinplotImg, 'PNG', 110, yPos, 85, 53);

                doc.save('hasil-uji-homogenitas-onthesis.pdf');

            } else if (format === 'doc') {
                const uji = $('#ujiSelector').val();
                const statisticName = uji === 'levene' ? 'Levene Statistic' : 'Bartlett Statistic';
                let content = `
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; }
                        h1, h2, h3, h4 { font-family: 'Times New Roman', Times, serif; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: left; vertical-align: top; }
                        th { font-weight: bold; background-color: #E0E0E0; }
                        .spss-title-cell { text-align: left; font-weight: bold; border: 1px solid #000; background-color: #E0E0E0;}
                    </style>
                    <h1>Laporan Uji Homogenitas - OnThesis</h1>
                `;
                content += `<p>${$('#summaryText').text()}</p>`;
                
                let tableHtml = `
                    <h4>Tabel 1</h4>
                    <table>
                        <thead>
                            <tr><th class="spss-title-cell" colspan="5">Test of Homogeneity of Variances</th></tr>
                            <tr>
                                <th></th>
                                <th>${statisticName}</th>
                                <th>df1</th>
                                <th>df2</th>
                                <th>Sig.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="font-weight: bold;">${analysisResult.table[0].test}</td>
                                <td>${Number(analysisResult.table[0].statistic).toFixed(4)}</td>
                                <td>${analysisResult.table[0].df1 ?? ''}</td>
                                <td>${analysisResult.table[0].df2 ?? ''}</td>
                                <td>${Number(analysisResult.table[0].p).toFixed(4)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                content += tableHtml;
                
                content += `<h3>Visualisasi Data</h3>`;
                const boxplotLayout = getPlotlyLayout('Box Plot', true);
                const violinplotLayout = getPlotlyLayout('Violin Plot', true);
                
                await Plotly.relayout('boxplot', boxplotLayout);
                await Plotly.relayout('violinplot', violinplotLayout);

                const boxplotImg = await Plotly.toImage('boxplot', {format: 'png', width: 800, height: 500});
                const violinplotImg = await Plotly.toImage('violinplot', {format: 'png', width: 800, height: 500});
                
                await Plotly.relayout('boxplot', getPlotlyLayout('Box Plot Sebaran Data per Grup'));
                await Plotly.relayout('violinplot', getPlotlyLayout('Violin Plot Sebaran Data per Grup'));

                content += `<h4>Box Plot</h4><p><img src="${boxplotImg}" style="width:500px; height:auto;" /></p>`;
                content += `<h4>Violin Plot</h4><p><img src="${violinplotImg}" style="width:500px; height:auto;" /></p>`;

                var converted = htmlDocx.asBlob(content);
                saveAs(converted, 'hasil-uji-homogenitas-onthesis.doc');
            }
        } catch (e) {
            console.error("Gagal mengekspor:", e);
            alert("Terjadi kesalahan saat mengekspor file.");
        } finally {
            btn.prop('disabled', false);
            spinner.addClass('hidden');
        }
    };

    $('#export-pdf-btn').on('click', () => exportHandler('pdf'));
    $('#export-doc-btn').on('click', () => exportHandler('doc'));

    // Inisialisasi
    resetGroups(2);
});
</script>
{% endblock %}
